<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>46 报表和日志 | Python-100天从新手到大师</title>


<link rel="stylesheet" href="/python100days/book.min.89885fa0429ec73067282f26fc0c6d38cfc617a443ec4e835d47b821c52c6e92.css" integrity="sha256-iYhfoEKexzBnKC8m/AxtOM/GF6RD7E6DXUe4IcUsbpI=">


<script defer src="/python100days/search.min.60214faf2667d486f5a5c602eb23dff270f5cbd9d003a2a159b89871099dc1b4.js" integrity="sha256-YCFPryZn1Ib1pcYC6yPf8nD1y9nQA6KhWbiYcQmdwbQ="></script>



<link rel="icon" href="/python100days/favicon.png" type="image/x-icon">

<base href="https://ezzdoc.github.io/python100days/">


<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="flex container">

    <aside class="book-menu fixed">
      <nav>
<h2 class="book-brand">
  <a href="https://ezzdoc.github.io/python100days/"><span>Python-100天从新手到大师</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" placeholder="Search" id="book-search-input" maxlength="64" readonly />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>





    
  
  
  

  <style>
  nav ul a[href$="\2fpython100days\2f docs\2f Day41-55\2f 46-%E6%8A%A5%E8%A1%A8%E5%92%8C%E6%97%A5%E5%BF%97\2f "] {
      color: #004ed0;
  }
  </style>

<ul>
<li><a href="/python100days/posts/"><strong>相关文章</strong></a></li>
<li><strong>Day01-15</strong>

<ul>
<li><a href="/python100days/docs/Day01-15/01-%E5%88%9D%E8%AF%86Python/">01.初识Python</a></li>
<li><a href="/python100days/docs/Day01-15/02-%E8%AF%AD%E8%A8%80%E5%85%83%E7%B4%A0/">02.语言元素</a></li>
<li><a href="/python100days/docs/Day01-15/03-%E5%88%86%E6%94%AF%E7%BB%93%E6%9E%84/">03.分支结构</a></li>
<li><a href="/python100days/docs/Day01-15/04-%E5%BE%AA%E7%8E%AF%E7%BB%93%E6%9E%84/">04.循环结构</a></li>
<li><a href="/python100days/docs/Day01-15/05-%E6%9E%84%E9%80%A0%E7%A8%8B%E5%BA%8F%E9%80%BB%E8%BE%91/">05.构造程序逻辑</a></li>
<li><a href="/python100days/docs/Day01-15/06-%E5%87%BD%E6%95%B0%E5%92%8C%E6%A8%A1%E5%9D%97%E7%9A%84%E4%BD%BF%E7%94%A8/">06.函数和模块的使用</a></li>
<li><a href="/python100days/docs/Day01-15/07-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%92%8C%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">07.字符串和常用数据结构</a></li>
<li><a href="/python100days/docs/Day01-15/08-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/">08.面向对象编程基础</a></li>
<li><a href="/python100days/docs/Day01-15/09-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BF%9B%E9%98%B6/">09.面向对象进阶</a></li>
<li><a href="/python100days/docs/Day01-15/10-%E5%9B%BE%E5%BD%A2%E7%94%A8%E6%88%B7%E7%95%8C%E9%9D%A2%E5%92%8C%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/">10.图形用户界面和游戏开发</a></li>
<li><a href="/python100days/docs/Day01-15/11-%E6%96%87%E4%BB%B6%E5%92%8C%E5%BC%82%E5%B8%B8/">11.文件和异常</a></li>
<li><a href="/python100days/docs/Day01-15/12-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%92%8C%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">12.字符串和正则表达式</a></li>
<li><a href="/python100days/docs/Day01-15/13-%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B/">13.进程和线程</a></li>
<li><a href="/python100days/docs/Day01-15/14-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/">14.网络编程入门和网络应用开发</a></li>
<li><a href="/python100days/docs/Day01-15/15-%E5%9B%BE%E5%83%8F%E5%92%8C%E5%8A%9E%E5%85%AC%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86/">15.图像和办公文档处理</a></li>
</ul></li>
<li><strong>Day16-20</strong>

<ul>
<li><a href="/python100days/docs/Day16-20/16-20-Python%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/">16-20.Python语言进阶</a></li>
</ul></li>
<li><strong>Day21-30</strong>

<ul>
<li><a href="/python100days/docs/Day21-30/21-30-Web%E5%89%8D%E7%AB%AF%E6%A6%82%E8%BF%B0/">21-30.Web前端概述</a></li>
</ul></li>
<li><strong>Day31-35</strong>

<ul>
<li><a href="/python100days/docs/Day31-35/31-35-%E7%8E%A9%E8%BD%ACLinux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">31-35.玩转Linux操作系统</a></li>
</ul></li>
<li><strong>Day36-40</strong>

<ul>
<li><a href="/python100days/docs/Day36-40/36-38-%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93MySQL/">36-38.关系型数据库MySQL</a></li>
<li><a href="/python100days/docs/Day36-40/39-40-NoSQL%E5%85%A5%E9%97%A8/">39-40.NoSQL入门</a></li>
</ul></li>
<li><strong>Day41-55</strong>

<ul>
<li><a href="/python100days/docs/Day41-55/41-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/">41.快速上手</a></li>
<li><a href="/python100days/docs/Day41-55/42-%E6%B7%B1%E5%85%A5%E6%A8%A1%E5%9E%8B/">42.深入模型</a></li>
<li><a href="/python100days/docs/Day41-55/43-%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E5%92%8CAjax%E8%AF%B7%E6%B1%82/">43.静态资源和Ajax请求</a></li>
<li><a href="/python100days/docs/Day41-55/44-%E8%A1%A8%E5%8D%95%E7%9A%84%E5%BA%94%E7%94%A8/">44.表单的应用</a></li>
<li><a href="/python100days/docs/Day41-55/45-Cookie%E5%92%8CSession/">45.Cookie和Session</a></li>
<li><a href="/python100days/docs/Day41-55/46-%E6%8A%A5%E8%A1%A8%E5%92%8C%E6%97%A5%E5%BF%97/">46.报表和日志</a></li>
<li><a href="/python100days/docs/Day41-55/47-%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E5%BA%94%E7%94%A8/">47.中间件的应用</a></li>
<li><a href="/python100days/docs/Day41-55/48-%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/">48.前后端分离开发入门</a></li>
<li><a href="/python100days/docs/Day41-55/49-RESTful%E6%9E%B6%E6%9E%84%E5%92%8CDRF%E5%85%A5%E9%97%A8/">49.RESTful架构和DRF入门</a></li>
<li><a href="/python100days/docs/Day41-55/50-RESTful%E6%9E%B6%E6%9E%84%E5%92%8CDRF%E8%BF%9B%E9%98%B6/">50.RESTful架构和DRF进阶</a></li>
<li><a href="/python100days/docs/Day41-55/51-%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98/">51.使用缓存</a></li>
<li><a href="/python100days/docs/Day41-55/52-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%92%8C%E5%AF%8C%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91/">52.文件上传和富文本编辑</a></li>
<li><a href="/python100days/docs/Day41-55/53-%E7%9F%AD%E4%BF%A1%E5%92%8C%E9%82%AE%E4%BB%B6/">53.短信和邮件</a></li>
<li><a href="/python100days/docs/Day41-55/54-%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E5%92%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/">54.异步任务和定时任务</a></li>
<li><a href="/python100days/docs/Day41-55/55-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E5%92%8C%E9%A1%B9%E7%9B%AE%E4%B8%8A%E7%BA%BF/">55.单元测试和项目上线</a></li>
</ul></li>
<li><strong>Day56-60</strong>

<ul>
<li><a href="/python100days/docs/Day56-60/56-Flask%E5%85%A5%E9%97%A8/">56.Flask入门</a></li>
<li><a href="/python100days/docs/Day56-60/57-%E6%A8%A1%E6%9D%BF%E7%9A%84%E4%BD%BF%E7%94%A8/">57.模板的使用</a></li>
<li><a href="/python100days/docs/Day56-60/58-%E8%A1%A8%E5%8D%95%E7%9A%84%E5%A4%84%E7%90%86/">58.表单的处理</a></li>
<li><a href="/python100days/docs/Day56-60/59-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/">59.数据库操作</a></li>
<li><a href="/python100days/docs/Day56-60/60-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">60.项目实战</a></li>
</ul></li>
<li><strong>Day61-65</strong>

<ul>
<li><a href="/python100days/docs/Day61-65/61-%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86/">61.预备知识</a></li>
<li><a href="/python100days/docs/Day61-65/62-Tornado%E5%85%A5%E9%97%A8/">62.Tornado入门</a></li>
<li><a href="/python100days/docs/Day61-65/63-%E5%BC%82%E6%AD%A5%E5%8C%96/">63.异步化</a></li>
<li><a href="/python100days/docs/Day61-65/64-WebSocket%E7%9A%84%E5%BA%94%E7%94%A8/">64.WebSocket的应用</a></li>
<li><a href="/python100days/docs/Day61-65/65-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">65.项目实战</a></li>
</ul></li>
<li><strong>Day66-75</strong>

<ul>
<li><a href="/python100days/docs/Day66-75/66-%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%92%8C%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7/">66.网络爬虫和相关工具</a></li>
<li><a href="/python100days/docs/Day66-75/67-%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86%E5%92%8C%E8%A7%A3%E6%9E%90/">67.数据采集和解析</a></li>
<li><a href="/python100days/docs/Day66-75/68-%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE/">68.存储数据</a></li>
<li><a href="/python100days/docs/Day66-75/69-%E5%B9%B6%E5%8F%91%E4%B8%8B%E8%BD%BD/">69.并发下载</a></li>
<li><a href="/python100days/docs/Day66-75/70-%E8%A7%A3%E6%9E%90%E5%8A%A8%E6%80%81%E5%86%85%E5%AE%B9/">70.解析动态内容</a></li>
<li><a href="/python100days/docs/Day66-75/71-%E8%A1%A8%E5%8D%95%E4%BA%A4%E4%BA%92%E5%92%8C%E9%AA%8C%E8%AF%81%E7%A0%81%E5%A4%84%E7%90%86/">71.表单交互和验证码处理</a></li>
<li><a href="/python100days/docs/Day66-75/72-Scrapy%E5%85%A5%E9%97%A8/">72.Scrapy入门</a></li>
<li><a href="/python100days/docs/Day66-75/73-Scrapy%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8/">73.Scrapy高级应用</a></li>
<li><a href="/python100days/docs/Day66-75/74-Scrapy%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9E%E7%8E%B0/">74.Scrapy分布式实现</a></li>
<li><a href="/python100days/docs/Day66-75/75-%E7%88%AC%E8%99%AB%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">75.爬虫项目实战</a></li>
</ul></li>
<li><strong>Day76-90</strong>

<ul>
<li><a href="/python100days/docs/Day76-90/76-%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/">76.机器学习基础</a></li>
<li><a href="/python100days/docs/Day76-90/77-Pandas%E7%9A%84%E5%BA%94%E7%94%A8/">77.Pandas的应用</a></li>
<li><a href="/python100days/docs/Day76-90/78-NumPy%E5%92%8CSciPy%E7%9A%84%E5%BA%94%E7%94%A8/">78.NumPy和SciPy的应用</a></li>
<li><a href="/python100days/docs/Day76-90/79-Matplotlib%E5%92%8C%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/">79.Matplotlib和数据可视化</a></li>
<li><a href="/python100days/docs/Day76-90/80-k%E6%9C%80%E8%BF%91%E9%82%BB%E5%88%86%E7%B1%BB/">80.k最近邻分类</a></li>
<li><a href="/python100days/docs/Day76-90/81-%E5%86%B3%E7%AD%96%E6%A0%91/">81.决策树</a></li>
<li><a href="/python100days/docs/Day76-90/82-%E8%B4%9D%E5%8F%B6%E6%96%AF%E5%88%86%E7%B1%BB/">82.贝叶斯分类</a></li>
<li><a href="/python100days/docs/Day76-90/83-%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BA/">83.支持向量机</a></li>
<li><a href="/python100days/docs/Day76-90/84-K-%E5%9D%87%E5%80%BC%E8%81%9A%E7%B1%BB/">84.K-均值聚类</a></li>
<li><a href="/python100days/docs/Day76-90/85-%E5%9B%9E%E5%BD%92%E5%88%86%E6%9E%90/">85.回归分析</a></li>
<li><a href="/python100days/docs/Day76-90/86-%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/">86.大数据分析入门</a></li>
<li><a href="/python100days/docs/Day76-90/87-%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E8%BF%9B%E9%98%B6/">87.大数据分析进阶</a></li>
<li><a href="/python100days/docs/Day76-90/88-Tensorflow%E5%85%A5%E9%97%A8/">88.Tensorflow入门</a></li>
<li><a href="/python100days/docs/Day76-90/89-Tensorflow%E5%AE%9E%E6%88%98/">89.Tensorflow实战</a></li>
<li><a href="/python100days/docs/Day76-90/90-%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AE%9E%E6%88%98/">90.推荐系统实战</a></li>
</ul></li>
<li><strong>Day91-100</strong>

<ul>
<li><a href="/python100days/docs/Day91-100/91-%E5%9B%A2%E9%98%9F%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E5%87%86%E5%A4%87/">91.团队项目开发准备</a></li>
<li><a href="/python100days/docs/Day91-100/92-%E4%BD%BF%E7%94%A8Docker%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1/">92.使用Docker部署服务</a></li>
<li><a href="/python100days/docs/Day91-100/93-MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">93.MySQL性能优化</a></li>
<li><a href="/python100days/docs/Day91-100/94-%E7%BD%91%E7%BB%9CAPI%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1/">94.网络API接口设计</a></li>
<li><a href="/python100days/docs/Day91-100/95-%E4%BD%BF%E7%94%A8Django%E5%BC%80%E5%8F%91%E5%95%86%E4%B8%9A%E9%A1%B9%E7%9B%AE/">95.使用Django开发商业项目</a></li>
<li><a href="/python100days/docs/Day91-100/96-%E8%BD%AF%E4%BB%B6%E6%B5%8B%E8%AF%95%E5%92%8C%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/">96.软件测试和自动化测试</a></li>
<li><a href="/python100days/docs/Day91-100/97-%E7%94%B5%E5%95%86%E7%BD%91%E7%AB%99%E6%8A%80%E6%9C%AF%E8%A6%81%E7%82%B9%E5%89%96%E6%9E%90/">97.电商网站技术要点剖析</a></li>
<li><a href="/python100days/docs/Day91-100/98-%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E4%B8%8A%E7%BA%BF%E5%92%8C%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/">98.项目部署上线和性能调优</a></li>
<li><a href="/python100days/docs/Day91-100/99-%E9%9D%A2%E8%AF%95%E4%B8%AD%E7%9A%84%E5%85%AC%E5%85%B1%E9%97%AE%E9%A2%98/">99.面试中的公共问题</a></li>
<li><a href="/python100days/docs/Day91-100/100-%E8%8B%B1%E8%AF%AD%E9%9D%A2%E8%AF%95/">100.英语面试</a></li>
</ul></li>
</ul>







</nav>


<script>
(function() {
  var menu = document.querySelector("aside.book-menu nav");
  addEventListener("beforeunload", function(event) {
    localStorage.setItem("menu.scrollTop", menu.scrollTop);
  });
  menu.scrollTop = localStorage.getItem("menu.scrollTop");
})();
</script>

    </aside>

    <div class="book-page">
      <header class="flex align-center justify-between book-header">
  <label for="menu-control">
    <img src="/python100days/svg/menu.svg" alt="Menu" />
  </label>
  <strong>46 报表和日志</strong>
</header>

      
<article class="markdown">

<h1 id="报表和日志">报表和日志</h1>

<h2 id="导出excel报表">导出Excel报表</h2>

<p>报表就是用表格、图表等格式来动态显示数据，所以有人用这样的公式来描述报表：</p>

<pre><code>报表 = 多样的格式 + 动态的数据
</code></pre>

<p>有很多的三方库支持在Python程序中写Excel文件，包括<a href="https://xlwt.readthedocs.io/en/latest/">xlwt</a>、<a href="https://docs.xlwings.org/en/latest/quickstart.html">xlwings</a>、<a href="https://openpyxl.readthedocs.io/en/latest/">openpyxl</a>、<a href="https://xlsxwriter.readthedocs.io/">xlswriter</a>、<a href="http://pandas.pydata.org/">pandas</a>等，其中的xlwt虽然只支持写xls格式的Excel文件，但在性能方面的表现还是不错的。下面我们就以xlwt为例，来演示如何在Django项目中导出Excel报表，例如导出一个包含所有老师信息的Excel表格。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">export_teachers_excel</span>(request):
    <span style="color:#75715e"># 创建工作簿</span>
    wb <span style="color:#f92672">=</span> xlwt<span style="color:#f92672">.</span>Workbook()
    <span style="color:#75715e"># 添加工作表</span>
    sheet <span style="color:#f92672">=</span> wb<span style="color:#f92672">.</span>add_sheet(<span style="color:#e6db74">&#39;老师信息表&#39;</span>)
    <span style="color:#75715e"># 查询所有老师的信息(注意：这个地方稍后需要优化)</span>
    queryset <span style="color:#f92672">=</span> Teacher<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>all()
    <span style="color:#75715e"># 向Excel表单中写入表头</span>
    colnames <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;姓名&#39;</span>, <span style="color:#e6db74">&#39;介绍&#39;</span>, <span style="color:#e6db74">&#39;好评数&#39;</span>, <span style="color:#e6db74">&#39;差评数&#39;</span>, <span style="color:#e6db74">&#39;学科&#39;</span>)
    <span style="color:#66d9ef">for</span> index, name <span style="color:#f92672">in</span> enumerate(colnames):
        sheet<span style="color:#f92672">.</span>write(<span style="color:#ae81ff">0</span>, index, name)
    <span style="color:#75715e"># 向单元格中写入老师的数据</span>
    props <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;name&#39;</span>, <span style="color:#e6db74">&#39;detail&#39;</span>, <span style="color:#e6db74">&#39;good_count&#39;</span>, <span style="color:#e6db74">&#39;bad_count&#39;</span>, <span style="color:#e6db74">&#39;subject&#39;</span>)
    <span style="color:#66d9ef">for</span> row, teacher <span style="color:#f92672">in</span> enumerate(queryset):
        <span style="color:#66d9ef">for</span> col, prop <span style="color:#f92672">in</span> enumerate(props):
            value <span style="color:#f92672">=</span> getattr(teacher, prop, <span style="color:#e6db74">&#39;&#39;</span>)
            <span style="color:#66d9ef">if</span> isinstance(value, Subject):
                value <span style="color:#f92672">=</span> value<span style="color:#f92672">.</span>name
            sheet<span style="color:#f92672">.</span>write(row <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, col, value)
    <span style="color:#75715e"># 保存Excel</span>
    buffer <span style="color:#f92672">=</span> BytesIO()
    wb<span style="color:#f92672">.</span>save(buffer)
    <span style="color:#75715e"># 将二进制数据写入响应的消息体中并设置MIME类型</span>
    resp <span style="color:#f92672">=</span> HttpResponse(buffer<span style="color:#f92672">.</span>getvalue(), content_type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;application/vnd.ms-excel&#39;</span>)
    <span style="color:#75715e"># 中文文件名需要处理成百分号编码</span>
    filename <span style="color:#f92672">=</span> quote(<span style="color:#e6db74">&#39;老师.xls&#39;</span>)
    <span style="color:#75715e"># 通过响应头告知浏览器下载该文件以及对应的文件名</span>
    resp[<span style="color:#e6db74">&#39;content-disposition&#39;</span>] <span style="color:#f92672">=</span> f<span style="color:#e6db74">&#39;attachment; filename=&#34;{filename}&#34;&#39;</span>
    <span style="color:#66d9ef">return</span> resp</code></pre></div>
<p>映射URL。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">urlpatterns <span style="color:#f92672">=</span> [
    <span style="color:#75715e"># 此处省略上面的代码</span>
    path(<span style="color:#e6db74">&#39;excel/&#39;</span>, views<span style="color:#f92672">.</span>export_teachers_excel),
    <span style="color:#75715e"># 此处省略下面的代码</span>
]</code></pre></div>
<h2 id="生成前端统计图表">生成前端统计图表</h2>

<p>如果项目中需要生成前端统计图表，可以使用百度的<a href="https://echarts.baidu.com/">ECharts</a>。具体的做法是后端通过提供数据接口返回统计图表所需的数据，前端使用ECharts来渲染出柱状图、折线图、饼图、散点图等图表。例如我们要生成一个统计所有老师好评数和差评数的报表，可以按照下面的方式来做。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_teachers_data</span>(request):
    <span style="color:#75715e"># 查询所有老师的信息(注意：这个地方稍后也需要优化)</span>
    queryset <span style="color:#f92672">=</span> Teacher<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>all()
    <span style="color:#75715e"># 用生成式将老师的名字放在一个列表中</span>
    names <span style="color:#f92672">=</span> [teacher<span style="color:#f92672">.</span>name <span style="color:#66d9ef">for</span> teacher <span style="color:#f92672">in</span> queryset]
    <span style="color:#75715e"># 用生成式将老师的好评数放在一个列表中</span>
    good <span style="color:#f92672">=</span> [teacher<span style="color:#f92672">.</span>good_count <span style="color:#66d9ef">for</span> teacher <span style="color:#f92672">in</span> queryset]
    <span style="color:#75715e"># 用生成式将老师的差评数放在一个列表中</span>
    bad <span style="color:#f92672">=</span> [teacher<span style="color:#f92672">.</span>bad_count <span style="color:#66d9ef">for</span> teacher <span style="color:#f92672">in</span> queryset]
    <span style="color:#75715e"># 返回JSON格式的数据</span>
    <span style="color:#66d9ef">return</span> JsonResponse({<span style="color:#e6db74">&#39;names&#39;</span>: names, <span style="color:#e6db74">&#39;good&#39;</span>: good, <span style="color:#e6db74">&#39;bad&#39;</span>: bad})</code></pre></div>
<p>映射URL。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">urlpatterns <span style="color:#f92672">=</span> [
    <span style="color:#75715e"># 此处省略上面的代码</span>
    path(<span style="color:#e6db74">&#39;teachers_data/&#39;</span>, views<span style="color:#f92672">.</span>export_teachers_excel),
    <span style="color:#75715e"># 此处省略下面的代码</span>
]</code></pre></div>
<p>使用ECharts生成柱状图。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-HTML" data-lang="HTML"><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
&lt;<span style="color:#f92672">html</span> <span style="color:#a6e22e">lang</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;en&#34;</span>&gt;
&lt;<span style="color:#f92672">head</span>&gt;
    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">charset</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;UTF-8&#34;</span>&gt;
    &lt;<span style="color:#f92672">title</span>&gt;老师评价统计&lt;/<span style="color:#f92672">title</span>&gt;
&lt;/<span style="color:#f92672">head</span>&gt;
&lt;<span style="color:#f92672">body</span>&gt;
    &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;main&#34;</span> <span style="color:#a6e22e">style</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;width: 600px; height: 400px&#34;</span>&gt;&lt;/<span style="color:#f92672">div</span>&gt;
    &lt;<span style="color:#f92672">p</span>&gt;
        &lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span>&gt;返回首页&lt;/<span style="color:#f92672">a</span>&gt;
    &lt;/<span style="color:#f92672">p</span>&gt;
    &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://cdn.bootcss.com/echarts/4.2.1-rc1/echarts.min.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
    &lt;<span style="color:#f92672">script</span>&gt;
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">myChart</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">echarts</span>.<span style="color:#a6e22e">init</span>(document.<span style="color:#a6e22e">querySelector</span>(<span style="color:#e6db74">&#39;#main&#39;</span>))
        <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">&#39;/teachers_data/&#39;</span>)
            .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">resp</span> =&gt; <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">json</span>())
            .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">json</span> =&gt; {
                <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">option</span> <span style="color:#f92672">=</span> {
                    <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#39;#f00&#39;</span>, <span style="color:#e6db74">&#39;#00f&#39;</span>],
                    <span style="color:#a6e22e">title</span><span style="color:#f92672">:</span> {
                        <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;老师评价统计图&#39;</span>
                    },
                    <span style="color:#a6e22e">tooltip</span><span style="color:#f92672">:</span> {},
                    <span style="color:#a6e22e">legend</span><span style="color:#f92672">:</span> {
                        <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span>[<span style="color:#e6db74">&#39;好评&#39;</span>, <span style="color:#e6db74">&#39;差评&#39;</span>]
                    },
                    <span style="color:#a6e22e">xAxis</span><span style="color:#f92672">:</span> {
                        <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">names</span>
                    },
                    <span style="color:#a6e22e">yAxis</span><span style="color:#f92672">:</span> {},
                    <span style="color:#a6e22e">series</span><span style="color:#f92672">:</span> [
                        {
                            <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;好评&#39;</span>,
                            <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;bar&#39;</span>,
                            <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">good</span>
                        },
                        {
                            <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;差评&#39;</span>,
                            <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;bar&#39;</span>,
                            <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">bad</span>
                        }
                    ]
                }
                <span style="color:#a6e22e">myChart</span>.<span style="color:#a6e22e">setOption</span>(<span style="color:#a6e22e">option</span>)
            })
    &lt;/<span style="color:#f92672">script</span>&gt;
&lt;/<span style="color:#f92672">body</span>&gt;
&lt;/<span style="color:#f92672">html</span>&gt;</code></pre></div>
<p>运行效果如下图所示。</p>

<p><img src="Day41-55/res/echarts_bar_graph.png" alt="" /></p>

<h2 id="配置日志">配置日志</h2>

<p>项目开发阶段，显示足够的调试信息以辅助开发人员调试代码还是非常必要的；项目上线以后，将系统运行时出现的警告、错误等信息记录下来以备相关人员了解系统运行状况并维护代码也是很有必要的。要做好这两件事件，我们需要为Django项目配置日志。</p>

<p>Django的日志配置基本可以参照官方文档再结合项目实际需求来进行，这些内容基本上可以从官方文档上复制下来，然后进行局部的调整即可，下面给出一些参考配置。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">LOGGING <span style="color:#f92672">=</span> {
    <span style="color:#e6db74">&#39;version&#39;</span>: <span style="color:#ae81ff">1</span>,
    <span style="color:#75715e"># 是否禁用已经存在的日志器</span>
    <span style="color:#e6db74">&#39;disable_existing_loggers&#39;</span>: False,
    <span style="color:#75715e"># 日志格式化器</span>
    <span style="color:#e6db74">&#39;formatters&#39;</span>: {
        <span style="color:#e6db74">&#39;simple&#39;</span>: {
            <span style="color:#e6db74">&#39;format&#39;</span>: <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%(asctime)s</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%(module)s</span><span style="color:#e6db74">.</span><span style="color:#e6db74">%(funcName)s</span><span style="color:#e6db74">: </span><span style="color:#e6db74">%(message)s</span><span style="color:#e6db74">&#39;</span>,
            <span style="color:#e6db74">&#39;datefmt&#39;</span>: <span style="color:#e6db74">&#39;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S&#39;</span>,
        },
        <span style="color:#e6db74">&#39;verbose&#39;</span>: {
            <span style="color:#e6db74">&#39;format&#39;</span>: <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%(asctime)s</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%(levelname)s</span><span style="color:#e6db74"> [</span><span style="color:#e6db74">%(process)d</span><span style="color:#e6db74">-</span><span style="color:#e6db74">%(threadName)s</span><span style="color:#e6db74">] &#39;</span>
                      <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%(module)s</span><span style="color:#e6db74">.</span><span style="color:#e6db74">%(funcName)s</span><span style="color:#e6db74"> line </span><span style="color:#e6db74">%(lineno)d</span><span style="color:#e6db74">: </span><span style="color:#e6db74">%(message)s</span><span style="color:#e6db74">&#39;</span>,
            <span style="color:#e6db74">&#39;datefmt&#39;</span>: <span style="color:#e6db74">&#39;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S&#39;</span>,
        }
    },
    <span style="color:#75715e"># 日志过滤器</span>
    <span style="color:#e6db74">&#39;filters&#39;</span>: {
        <span style="color:#75715e"># 只有在Django配置文件中DEBUG值为True时才起作用</span>
        <span style="color:#e6db74">&#39;require_debug_true&#39;</span>: {
            <span style="color:#e6db74">&#39;()&#39;</span>: <span style="color:#e6db74">&#39;django.utils.log.RequireDebugTrue&#39;</span>,
        },
    },
    <span style="color:#75715e"># 日志处理器</span>
    <span style="color:#e6db74">&#39;handlers&#39;</span>: {
        <span style="color:#75715e"># 输出到控制台</span>
        <span style="color:#e6db74">&#39;console&#39;</span>: {
            <span style="color:#e6db74">&#39;class&#39;</span>: <span style="color:#e6db74">&#39;logging.StreamHandler&#39;</span>,
            <span style="color:#e6db74">&#39;level&#39;</span>: <span style="color:#e6db74">&#39;DEBUG&#39;</span>,
            <span style="color:#e6db74">&#39;filters&#39;</span>: [<span style="color:#e6db74">&#39;require_debug_true&#39;</span>],
            <span style="color:#e6db74">&#39;formatter&#39;</span>: <span style="color:#e6db74">&#39;simple&#39;</span>,
        },
        <span style="color:#75715e"># 输出到文件(每周切割一次)</span>
        <span style="color:#e6db74">&#39;file1&#39;</span>: {
            <span style="color:#e6db74">&#39;class&#39;</span>: <span style="color:#e6db74">&#39;logging.handlers.TimedRotatingFileHandler&#39;</span>,
            <span style="color:#e6db74">&#39;filename&#39;</span>: <span style="color:#e6db74">&#39;access.log&#39;</span>,
            <span style="color:#e6db74">&#39;when&#39;</span>: <span style="color:#e6db74">&#39;W0&#39;</span>,
            <span style="color:#e6db74">&#39;backupCount&#39;</span>: <span style="color:#ae81ff">12</span>,
            <span style="color:#e6db74">&#39;formatter&#39;</span>: <span style="color:#e6db74">&#39;simple&#39;</span>,
            <span style="color:#e6db74">&#39;level&#39;</span>: <span style="color:#e6db74">&#39;INFO&#39;</span>,
        },
        <span style="color:#75715e"># 输出到文件(每天切割一次)</span>
        <span style="color:#e6db74">&#39;file2&#39;</span>: {
            <span style="color:#e6db74">&#39;class&#39;</span>: <span style="color:#e6db74">&#39;logging.handlers.TimedRotatingFileHandler&#39;</span>,
            <span style="color:#e6db74">&#39;filename&#39;</span>: <span style="color:#e6db74">&#39;error.log&#39;</span>,
            <span style="color:#e6db74">&#39;when&#39;</span>: <span style="color:#e6db74">&#39;D&#39;</span>,
            <span style="color:#e6db74">&#39;backupCount&#39;</span>: <span style="color:#ae81ff">31</span>,
            <span style="color:#e6db74">&#39;formatter&#39;</span>: <span style="color:#e6db74">&#39;verbose&#39;</span>,
            <span style="color:#e6db74">&#39;level&#39;</span>: <span style="color:#e6db74">&#39;WARNING&#39;</span>,
        },
    },
    <span style="color:#75715e"># 日志器记录器</span>
    <span style="color:#e6db74">&#39;loggers&#39;</span>: {
        <span style="color:#e6db74">&#39;django&#39;</span>: {
            <span style="color:#75715e"># 需要使用的日志处理器</span>
            <span style="color:#e6db74">&#39;handlers&#39;</span>: [<span style="color:#e6db74">&#39;console&#39;</span>, <span style="color:#e6db74">&#39;file1&#39;</span>, <span style="color:#e6db74">&#39;file2&#39;</span>],
            <span style="color:#75715e"># 是否向上传播日志信息</span>
            <span style="color:#e6db74">&#39;propagate&#39;</span>: True,
            <span style="color:#75715e"># 日志级别(不一定是最终的日志级别)</span>
            <span style="color:#e6db74">&#39;level&#39;</span>: <span style="color:#e6db74">&#39;DEBUG&#39;</span>,
        },
    }
}</code></pre></div>
<p>大家可能已经注意到了，上面日志配置中的formatters是<strong>日志格式化器</strong>，它代表了如何格式化输出日志，其中格式占位符分别表示：</p>

<ol>
<li>%(name)s - 记录器的名称</li>
<li>%(levelno)s - 数字形式的日志记录级别</li>
<li>%(levelname)s - 日志记录级别的文本名称</li>
<li>%(filename)s - 执行日志记录调用的源文件的文件名称</li>
<li>%(pathname)s - 执行日志记录调用的源文件的路径名称</li>
<li>%(funcName)s - 执行日志记录调用的函数名称</li>
<li>%(module)s - 执行日志记录调用的模块名称</li>
<li>%(lineno)s - 执行日志记录调用的行号</li>
<li>%(created)s - 执行日志记录的时间</li>
<li>%(asctime)s - 日期和时间</li>
<li>%(msecs)s - 毫秒部分</li>
<li>%(thread)d - 线程ID（整数）</li>
<li>%(threadName)s - 线程名称</li>
<li>%(process)d - 进程ID （整数）</li>
</ol>

<p>日志配置中的handlers用来指定<strong>日志处理器</strong>，简单的说就是指定将日志输出到控制台还是文件又或者是网络上的服务器，可用的处理器包括：</p>

<ol>
<li>logging.StreamHandler(stream=None) - 可以向类似与sys.stdout或者sys.stderr的任何文件对象输出信息</li>
<li>logging.FileHandler(filename, mode=&lsquo;a&rsquo;, encoding=None, delay=False) - 将日志消息写入文件</li>
<li>logging.handlers.DatagramHandler(host, port) - 使用UDP协议，将日志信息发送到指定主机和端口的网络主机上</li>
<li>logging.handlers.HTTPHandler(host, url) - 使用HTTP的GET或POST方法将日志消息上传到一台HTTP 服务器</li>
<li>logging.handlers.RotatingFileHandler(filename, mode=&lsquo;a&rsquo;, maxBytes=0, backupCount=0, encoding=None, delay=False) - 将日志消息写入文件，如果文件的大小超出maxBytes指定的值，那么将重新生成一个文件来记录日志</li>
<li>logging.handlers.SocketHandler(host, port) - 使用TCP协议，将日志信息发送到指定主机和端口的网络主机上</li>
<li>logging.handlers.SMTPHandler(mailhost, fromaddr, toaddrs, subject, credentials=None, secure=None, timeout=1.0) - 将日志输出到指定的邮件地址</li>
<li>logging.MemoryHandler(capacity, flushLevel=ERROR, target=None, flushOnClose=True) - 将日志输出到内存指定的缓冲区中</li>
</ol>

<p>上面每个日志处理器都指定了一个名为“level”的属性，它代表了日志的级别，不同的日志级别反映出日志中记录信息的严重性。Python中定义了六个级别的日志，按照从低到高的顺序依次是：NOTSET、DEBUG、INFO、WARNING、ERROR、CRITICAL。</p>

<p>最后配置的<strong>日志记录器</strong>是用来真正输出日志的，Django框架提供了如下所示的内置记录器：</p>

<ol>
<li>django - 在Django层次结构中的所有消息记录器</li>
<li>django.request - 与请求处理相关的日志消息。5xx响应被视为错误消息；4xx响应被视为为警告消息</li>
<li>django.server - 与通过runserver调用的服务器所接收的请求相关的日志消息。5xx响应被视为错误消息；4xx响应被记录为警告消息；其他一切都被记录为INFO</li>
<li>django.template - 与模板渲染相关的日志消息</li>
<li>django.db.backends - 有与数据库交互产生的日志消息，如果希望显示ORM框架执行的SQL语句，就可以使用该日志记录器。</li>
</ol>

<p>日志记录器中配置的日志级别有可能不是最终的日志级别，因为还要参考日志处理器中配置的日志级别，取二者中级别较高者作为最终的日志级别。</p>

<h2 id="配置django-debug-toolbar">配置Django-Debug-Toolbar</h2>

<p>Django-Debug-Toolbar是项目开发阶段辅助调试和优化的神器，只要配置了它，就可以很方便的查看到如下表所示的项目运行信息，这些信息对调试项目和优化Web应用性能都是至关重要的。</p>

<table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td>Versions</td>
<td>Django的版本</td>
</tr>

<tr>
<td>Time</td>
<td>显示视图耗费的时间</td>
</tr>

<tr>
<td>Settings</td>
<td>配置文件中设置的值</td>
</tr>

<tr>
<td>Headers</td>
<td>HTTP请求头和响应头的信息</td>
</tr>

<tr>
<td>Request</td>
<td>和请求相关的各种变量及其信息</td>
</tr>

<tr>
<td>StaticFiles</td>
<td>静态文件加载情况</td>
</tr>

<tr>
<td>Templates</td>
<td>模板的相关信息</td>
</tr>

<tr>
<td>Cache</td>
<td>缓存的使用情况</td>
</tr>

<tr>
<td>Signals</td>
<td>Django内置的信号信息</td>
</tr>

<tr>
<td>Logging</td>
<td>被记录的日志信息</td>
</tr>

<tr>
<td>SQL</td>
<td>向数据库发送的SQL语句及其执行时间</td>
</tr>
</tbody>
</table>

<ol>
<li><p>安装Django-Debug-Toolbar。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">pip install django-debug-toolbar</code></pre></div></li>

<li><p>配置 - 修改settings.py。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">INSTALLED_APPS <span style="color:#f92672">=</span> [
   <span style="color:#e6db74">&#39;debug_toolbar&#39;</span>,
]

MIDDLEWARE <span style="color:#f92672">=</span> [
   <span style="color:#e6db74">&#39;debug_toolbar.middleware.DebugToolbarMiddleware&#39;</span>,
]

DEBUG_TOOLBAR_CONFIG <span style="color:#f92672">=</span> {
   <span style="color:#75715e"># 引入jQuery库</span>
   <span style="color:#e6db74">&#39;JQUERY_URL&#39;</span>: <span style="color:#e6db74">&#39;https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js&#39;</span>,
   <span style="color:#75715e"># 工具栏是否折叠</span>
   <span style="color:#e6db74">&#39;SHOW_COLLAPSED&#39;</span>: True,
   <span style="color:#75715e"># 是否显示工具栏</span>
   <span style="color:#e6db74">&#39;SHOW_TOOLBAR_CALLBACK&#39;</span>: <span style="color:#66d9ef">lambda</span> x: True,
}</code></pre></div></li>

<li><p>配置 - 修改urls.py。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">if</span> settings<span style="color:#f92672">.</span>DEBUG:

   <span style="color:#f92672">import</span> debug_toolbar

   urlpatterns<span style="color:#f92672">.</span>insert(<span style="color:#ae81ff">0</span>, path(<span style="color:#e6db74">&#39;__debug__/&#39;</span>, include(debug_toolbar<span style="color:#f92672">.</span>urls)))</code></pre></div></li>

<li><p>使用 - 如下图所示，在配置好Django-Debug-Toolbar之后，页面右侧会看到一个调试工具栏，上面包括了如前所述的各种调试信息，包括执行时间、项目设置、请求头、SQL、静态资源、模板、缓存、信号等，查看起来非常的方便。</p></li>
</ol>

<h2 id="优化orm代码">优化ORM代码</h2>

<p>在配置了日志或Django-Debug-Toolbar之后，我们可以查看一下之前将老师数据导出成Excel报表的视图函数执行情况，这里我们关注的是ORM框架生成的SQL查询到底是什么样子的，相信这里的结果会让你感到有一些意外。执行<code>Teacher.objects.all()</code>之后我们可以注意到，在控制台看到的或者通过Django-Debug-Toolbar输出的SQL是下面这样的：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-SQL" data-lang="SQL"><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">`</span>tb_teacher<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">no</span><span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_teacher<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>name<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_teacher<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>detail<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_teacher<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>photo<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_teacher<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>good_count<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_teacher<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>bad_count<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_teacher<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>sno<span style="color:#f92672">`</span> <span style="color:#66d9ef">FROM</span> <span style="color:#f92672">`</span>tb_teacher<span style="color:#f92672">`</span>; args<span style="color:#f92672">=</span>()
<span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">no</span><span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>name<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>intro<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>create_date<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>is_hot<span style="color:#f92672">`</span> <span style="color:#66d9ef">FROM</span> <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span> <span style="color:#66d9ef">WHERE</span> <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">no</span><span style="color:#f92672">`</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">101</span>; args<span style="color:#f92672">=</span>(<span style="color:#ae81ff">101</span>,)
<span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">no</span><span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>name<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>intro<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>create_date<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>is_hot<span style="color:#f92672">`</span> <span style="color:#66d9ef">FROM</span> <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span> <span style="color:#66d9ef">WHERE</span> <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">no</span><span style="color:#f92672">`</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">101</span>; args<span style="color:#f92672">=</span>(<span style="color:#ae81ff">101</span>,)
<span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">no</span><span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>name<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>intro<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>create_date<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>is_hot<span style="color:#f92672">`</span> <span style="color:#66d9ef">FROM</span> <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span> <span style="color:#66d9ef">WHERE</span> <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">no</span><span style="color:#f92672">`</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">101</span>; args<span style="color:#f92672">=</span>(<span style="color:#ae81ff">101</span>,)
<span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">no</span><span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>name<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>intro<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>create_date<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>is_hot<span style="color:#f92672">`</span> <span style="color:#66d9ef">FROM</span> <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span> <span style="color:#66d9ef">WHERE</span> <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">no</span><span style="color:#f92672">`</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">101</span>; args<span style="color:#f92672">=</span>(<span style="color:#ae81ff">101</span>,)
<span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">no</span><span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>name<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>intro<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>create_date<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>is_hot<span style="color:#f92672">`</span> <span style="color:#66d9ef">FROM</span> <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span> <span style="color:#66d9ef">WHERE</span> <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">no</span><span style="color:#f92672">`</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">103</span>; args<span style="color:#f92672">=</span>(<span style="color:#ae81ff">103</span>,)
<span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">no</span><span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>name<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>intro<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>create_date<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>is_hot<span style="color:#f92672">`</span> <span style="color:#66d9ef">FROM</span> <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span> <span style="color:#66d9ef">WHERE</span> <span style="color:#f92672">`</span>tb_subject<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">no</span><span style="color:#f92672">`</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">103</span>; args<span style="color:#f92672">=</span>(<span style="color:#ae81ff">103</span>,)</code></pre></div>
<p>这里的问题通常被称为“1+N查询”（或“N+1查询”），原本获取老师的数据只需要一条SQL，但是由于老师关联了学科，当我们查询到N条老师的数据时，Django的ORM框架又向数据库发出了N条SQL去查询老师所属学科的信息。每条SQL执行都会有较大的开销而且会给数据库服务器带来压力，如果能够在一条SQL中完成老师和学科的查询肯定是更好的做法，这一点也很容易做到，相信大家已经想到怎么做了。是的，我们可以使用连接查询，但是在使用Django的ORM框架时如何做到这一点呢？对于多对一关联（如投票应用中的老师和学科），我们可以使用<code>QuerySet</code>的用<code>select_related()</code>方法来加载关联对象；而对于多对多关联（如电商网站中的订单和商品），我们可以使用<code>prefetch_related()</code>方法来加载关联对象。</p>

<p>在导出老师Excel报表的视图函数中，我们可以按照下面的方式优化代码。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">queryset <span style="color:#f92672">=</span> Teacher<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>all()<span style="color:#f92672">.</span>select_related(<span style="color:#e6db74">&#39;subject&#39;</span>)</code></pre></div>
<p>事实上，用ECharts生成前端报表的视图函数中，查询老师好评和差评数据的操作也能够优化，因为在这个例子中，我们只需要获取老师的姓名、好评数和差评数这三项数据，但是在默认的情况生成的SQL会查询老师表的所有字段。可以用<code>QuerySet</code>的<code>only()</code>方法来指定需要查询的属性，也可以用<code>QuerySet</code>的<code>defer()</code>方法来指定暂时不需要查询的属性，这样生成的SQL会通过投影操作来指定需要查询的列，从而改善查询性能，代码如下所示：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">queryset <span style="color:#f92672">=</span> Teacher<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>all()<span style="color:#f92672">.</span>only(<span style="color:#e6db74">&#39;name&#39;</span>, <span style="color:#e6db74">&#39;good_count&#39;</span>, <span style="color:#e6db74">&#39;bad_count&#39;</span>)</code></pre></div>
<p>当然，如果要统计出每个学科的老师好评和差评的平均数，利用Django的ORM框架也能够做到，代码如下所示：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">queryset <span style="color:#f92672">=</span> Teacher<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>values(<span style="color:#e6db74">&#39;subject&#39;</span>)<span style="color:#f92672">.</span>annotate(
        good<span style="color:#f92672">=</span>Avg(<span style="color:#e6db74">&#39;good_count&#39;</span>), bad<span style="color:#f92672">=</span>Avg(<span style="color:#e6db74">&#39;bad_count&#39;</span>))</code></pre></div>
<p>这里获得的<code>QuerySet</code>中的元素是字典对象，每个字典中有三组键值对，分别是代表学科编号的<code>subject</code>、代表好评数的<code>good</code>和代表差评数的<code>bad</code>。如果想要获得学科的名称而不是编号，可以按照如下所示的方式调整代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">queryset <span style="color:#f92672">=</span> Teacher<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>values(<span style="color:#e6db74">&#39;subject__name&#39;</span>)<span style="color:#f92672">.</span>annotate(
        good<span style="color:#f92672">=</span>Avg(<span style="color:#e6db74">&#39;good_count&#39;</span>), bad<span style="color:#f92672">=</span>Avg(<span style="color:#e6db74">&#39;bad_count&#39;</span>))</code></pre></div>
<p>可见，Django的ORM框架允许我们用面向对象的方式完成关系数据库中的分组和聚合查询。</p>
</article>

      

      
    </div>

    
  

  <aside class="book-toc level-3 fixed">
    <nav id="TableOfContents">
<ul>
<li><a href="#报表和日志">报表和日志</a>
<ul>
<li><a href="#导出excel报表">导出Excel报表</a></li>
<li><a href="#生成前端统计图表">生成前端统计图表</a></li>
<li><a href="#配置日志">配置日志</a></li>
<li><a href="#配置django-debug-toolbar">配置Django-Debug-Toolbar</a></li>
<li><a href="#优化orm代码">优化ORM代码</a></li>
</ul></li>
</ul>
</nav>
  </aside>



  </main>

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-148025936-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>

</html>
