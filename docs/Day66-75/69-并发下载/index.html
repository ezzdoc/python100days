<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>69 并发下载 | Python-100天从新手到大师</title>


<link rel="stylesheet" href="/python100days/book.min.89885fa0429ec73067282f26fc0c6d38cfc617a443ec4e835d47b821c52c6e92.css" integrity="sha256-iYhfoEKexzBnKC8m/AxtOM/GF6RD7E6DXUe4IcUsbpI=">


<script defer src="/python100days/search.min.60214faf2667d486f5a5c602eb23dff270f5cbd9d003a2a159b89871099dc1b4.js" integrity="sha256-YCFPryZn1Ib1pcYC6yPf8nD1y9nQA6KhWbiYcQmdwbQ="></script>



<link rel="icon" href="/python100days/favicon.png" type="image/x-icon">

<base href="https://ezzdoc.github.io/python100days/">


<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="flex container">

    <aside class="book-menu fixed">
      <nav>
<h2 class="book-brand">
  <a href="https://ezzdoc.github.io/python100days/"><span>Python-100天从新手到大师</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" placeholder="Search" id="book-search-input" maxlength="64" readonly />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>





    
  
  
  

  <style>
  nav ul a[href$="\2fpython100days\2f docs\2f Day66-75\2f 69-%E5%B9%B6%E5%8F%91%E4%B8%8B%E8%BD%BD\2f "] {
      color: #004ed0;
  }
  </style>

<ul>
<li><a href="/python100days/posts/"><strong>相关文章</strong></a></li>
<li><strong>Day01-15</strong>

<ul>
<li><a href="/python100days/docs/Day01-15/01-%E5%88%9D%E8%AF%86Python/">01.初识Python</a></li>
<li><a href="/python100days/docs/Day01-15/02-%E8%AF%AD%E8%A8%80%E5%85%83%E7%B4%A0/">02.语言元素</a></li>
<li><a href="/python100days/docs/Day01-15/03-%E5%88%86%E6%94%AF%E7%BB%93%E6%9E%84/">03.分支结构</a></li>
<li><a href="/python100days/docs/Day01-15/04-%E5%BE%AA%E7%8E%AF%E7%BB%93%E6%9E%84/">04.循环结构</a></li>
<li><a href="/python100days/docs/Day01-15/05-%E6%9E%84%E9%80%A0%E7%A8%8B%E5%BA%8F%E9%80%BB%E8%BE%91/">05.构造程序逻辑</a></li>
<li><a href="/python100days/docs/Day01-15/06-%E5%87%BD%E6%95%B0%E5%92%8C%E6%A8%A1%E5%9D%97%E7%9A%84%E4%BD%BF%E7%94%A8/">06.函数和模块的使用</a></li>
<li><a href="/python100days/docs/Day01-15/07-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%92%8C%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">07.字符串和常用数据结构</a></li>
<li><a href="/python100days/docs/Day01-15/08-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/">08.面向对象编程基础</a></li>
<li><a href="/python100days/docs/Day01-15/09-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BF%9B%E9%98%B6/">09.面向对象进阶</a></li>
<li><a href="/python100days/docs/Day01-15/10-%E5%9B%BE%E5%BD%A2%E7%94%A8%E6%88%B7%E7%95%8C%E9%9D%A2%E5%92%8C%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/">10.图形用户界面和游戏开发</a></li>
<li><a href="/python100days/docs/Day01-15/11-%E6%96%87%E4%BB%B6%E5%92%8C%E5%BC%82%E5%B8%B8/">11.文件和异常</a></li>
<li><a href="/python100days/docs/Day01-15/12-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%92%8C%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">12.字符串和正则表达式</a></li>
<li><a href="/python100days/docs/Day01-15/13-%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B/">13.进程和线程</a></li>
<li><a href="/python100days/docs/Day01-15/14-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/">14.网络编程入门和网络应用开发</a></li>
<li><a href="/python100days/docs/Day01-15/15-%E5%9B%BE%E5%83%8F%E5%92%8C%E5%8A%9E%E5%85%AC%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86/">15.图像和办公文档处理</a></li>
</ul></li>
<li><strong>Day16-20</strong>

<ul>
<li><a href="/python100days/docs/Day16-20/16-20-Python%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/">16-20.Python语言进阶</a></li>
</ul></li>
<li><strong>Day21-30</strong>

<ul>
<li><a href="/python100days/docs/Day21-30/21-30-Web%E5%89%8D%E7%AB%AF%E6%A6%82%E8%BF%B0/">21-30.Web前端概述</a></li>
</ul></li>
<li><strong>Day31-35</strong>

<ul>
<li><a href="/python100days/docs/Day31-35/31-35-%E7%8E%A9%E8%BD%ACLinux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">31-35.玩转Linux操作系统</a></li>
</ul></li>
<li><strong>Day36-40</strong>

<ul>
<li><a href="/python100days/docs/Day36-40/36-38-%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93MySQL/">36-38.关系型数据库MySQL</a></li>
<li><a href="/python100days/docs/Day36-40/39-40-NoSQL%E5%85%A5%E9%97%A8/">39-40.NoSQL入门</a></li>
</ul></li>
<li><strong>Day41-55</strong>

<ul>
<li><a href="/python100days/docs/Day41-55/41-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/">41.快速上手</a></li>
<li><a href="/python100days/docs/Day41-55/42-%E6%B7%B1%E5%85%A5%E6%A8%A1%E5%9E%8B/">42.深入模型</a></li>
<li><a href="/python100days/docs/Day41-55/43-%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E5%92%8CAjax%E8%AF%B7%E6%B1%82/">43.静态资源和Ajax请求</a></li>
<li><a href="/python100days/docs/Day41-55/44-%E8%A1%A8%E5%8D%95%E7%9A%84%E5%BA%94%E7%94%A8/">44.表单的应用</a></li>
<li><a href="/python100days/docs/Day41-55/45-Cookie%E5%92%8CSession/">45.Cookie和Session</a></li>
<li><a href="/python100days/docs/Day41-55/46-%E6%8A%A5%E8%A1%A8%E5%92%8C%E6%97%A5%E5%BF%97/">46.报表和日志</a></li>
<li><a href="/python100days/docs/Day41-55/47-%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E5%BA%94%E7%94%A8/">47.中间件的应用</a></li>
<li><a href="/python100days/docs/Day41-55/48-%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/">48.前后端分离开发入门</a></li>
<li><a href="/python100days/docs/Day41-55/49-RESTful%E6%9E%B6%E6%9E%84%E5%92%8CDRF%E5%85%A5%E9%97%A8/">49.RESTful架构和DRF入门</a></li>
<li><a href="/python100days/docs/Day41-55/50-RESTful%E6%9E%B6%E6%9E%84%E5%92%8CDRF%E8%BF%9B%E9%98%B6/">50.RESTful架构和DRF进阶</a></li>
<li><a href="/python100days/docs/Day41-55/51-%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98/">51.使用缓存</a></li>
<li><a href="/python100days/docs/Day41-55/52-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%92%8C%E5%AF%8C%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91/">52.文件上传和富文本编辑</a></li>
<li><a href="/python100days/docs/Day41-55/53-%E7%9F%AD%E4%BF%A1%E5%92%8C%E9%82%AE%E4%BB%B6/">53.短信和邮件</a></li>
<li><a href="/python100days/docs/Day41-55/54-%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E5%92%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/">54.异步任务和定时任务</a></li>
<li><a href="/python100days/docs/Day41-55/55-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E5%92%8C%E9%A1%B9%E7%9B%AE%E4%B8%8A%E7%BA%BF/">55.单元测试和项目上线</a></li>
</ul></li>
<li><strong>Day56-60</strong>

<ul>
<li><a href="/python100days/docs/Day56-60/56-Flask%E5%85%A5%E9%97%A8/">56.Flask入门</a></li>
<li><a href="/python100days/docs/Day56-60/57-%E6%A8%A1%E6%9D%BF%E7%9A%84%E4%BD%BF%E7%94%A8/">57.模板的使用</a></li>
<li><a href="/python100days/docs/Day56-60/58-%E8%A1%A8%E5%8D%95%E7%9A%84%E5%A4%84%E7%90%86/">58.表单的处理</a></li>
<li><a href="/python100days/docs/Day56-60/59-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/">59.数据库操作</a></li>
<li><a href="/python100days/docs/Day56-60/60-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">60.项目实战</a></li>
</ul></li>
<li><strong>Day61-65</strong>

<ul>
<li><a href="/python100days/docs/Day61-65/61-%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86/">61.预备知识</a></li>
<li><a href="/python100days/docs/Day61-65/62-Tornado%E5%85%A5%E9%97%A8/">62.Tornado入门</a></li>
<li><a href="/python100days/docs/Day61-65/63-%E5%BC%82%E6%AD%A5%E5%8C%96/">63.异步化</a></li>
<li><a href="/python100days/docs/Day61-65/64-WebSocket%E7%9A%84%E5%BA%94%E7%94%A8/">64.WebSocket的应用</a></li>
<li><a href="/python100days/docs/Day61-65/65-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">65.项目实战</a></li>
</ul></li>
<li><strong>Day66-75</strong>

<ul>
<li><a href="/python100days/docs/Day66-75/66-%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%92%8C%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7/">66.网络爬虫和相关工具</a></li>
<li><a href="/python100days/docs/Day66-75/67-%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86%E5%92%8C%E8%A7%A3%E6%9E%90/">67.数据采集和解析</a></li>
<li><a href="/python100days/docs/Day66-75/68-%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE/">68.存储数据</a></li>
<li><a href="/python100days/docs/Day66-75/69-%E5%B9%B6%E5%8F%91%E4%B8%8B%E8%BD%BD/">69.并发下载</a></li>
<li><a href="/python100days/docs/Day66-75/70-%E8%A7%A3%E6%9E%90%E5%8A%A8%E6%80%81%E5%86%85%E5%AE%B9/">70.解析动态内容</a></li>
<li><a href="/python100days/docs/Day66-75/71-%E8%A1%A8%E5%8D%95%E4%BA%A4%E4%BA%92%E5%92%8C%E9%AA%8C%E8%AF%81%E7%A0%81%E5%A4%84%E7%90%86/">71.表单交互和验证码处理</a></li>
<li><a href="/python100days/docs/Day66-75/72-Scrapy%E5%85%A5%E9%97%A8/">72.Scrapy入门</a></li>
<li><a href="/python100days/docs/Day66-75/73-Scrapy%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8/">73.Scrapy高级应用</a></li>
<li><a href="/python100days/docs/Day66-75/74-Scrapy%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9E%E7%8E%B0/">74.Scrapy分布式实现</a></li>
<li><a href="/python100days/docs/Day66-75/75-%E7%88%AC%E8%99%AB%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">75.爬虫项目实战</a></li>
</ul></li>
<li><strong>Day76-90</strong>

<ul>
<li><a href="/python100days/docs/Day76-90/76-%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/">76.机器学习基础</a></li>
<li><a href="/python100days/docs/Day76-90/77-Pandas%E7%9A%84%E5%BA%94%E7%94%A8/">77.Pandas的应用</a></li>
<li><a href="/python100days/docs/Day76-90/78-NumPy%E5%92%8CSciPy%E7%9A%84%E5%BA%94%E7%94%A8/">78.NumPy和SciPy的应用</a></li>
<li><a href="/python100days/docs/Day76-90/79-Matplotlib%E5%92%8C%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/">79.Matplotlib和数据可视化</a></li>
<li><a href="/python100days/docs/Day76-90/80-k%E6%9C%80%E8%BF%91%E9%82%BB%E5%88%86%E7%B1%BB/">80.k最近邻分类</a></li>
<li><a href="/python100days/docs/Day76-90/81-%E5%86%B3%E7%AD%96%E6%A0%91/">81.决策树</a></li>
<li><a href="/python100days/docs/Day76-90/82-%E8%B4%9D%E5%8F%B6%E6%96%AF%E5%88%86%E7%B1%BB/">82.贝叶斯分类</a></li>
<li><a href="/python100days/docs/Day76-90/83-%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BA/">83.支持向量机</a></li>
<li><a href="/python100days/docs/Day76-90/84-K-%E5%9D%87%E5%80%BC%E8%81%9A%E7%B1%BB/">84.K-均值聚类</a></li>
<li><a href="/python100days/docs/Day76-90/85-%E5%9B%9E%E5%BD%92%E5%88%86%E6%9E%90/">85.回归分析</a></li>
<li><a href="/python100days/docs/Day76-90/86-%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/">86.大数据分析入门</a></li>
<li><a href="/python100days/docs/Day76-90/87-%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E8%BF%9B%E9%98%B6/">87.大数据分析进阶</a></li>
<li><a href="/python100days/docs/Day76-90/88-Tensorflow%E5%85%A5%E9%97%A8/">88.Tensorflow入门</a></li>
<li><a href="/python100days/docs/Day76-90/89-Tensorflow%E5%AE%9E%E6%88%98/">89.Tensorflow实战</a></li>
<li><a href="/python100days/docs/Day76-90/90-%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AE%9E%E6%88%98/">90.推荐系统实战</a></li>
</ul></li>
<li><strong>Day91-100</strong>

<ul>
<li><a href="/python100days/docs/Day91-100/91-%E5%9B%A2%E9%98%9F%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E5%87%86%E5%A4%87/">91.团队项目开发准备</a></li>
<li><a href="/python100days/docs/Day91-100/92-%E4%BD%BF%E7%94%A8Docker%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1/">92.使用Docker部署服务</a></li>
<li><a href="/python100days/docs/Day91-100/93-MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">93.MySQL性能优化</a></li>
<li><a href="/python100days/docs/Day91-100/94-%E7%BD%91%E7%BB%9CAPI%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1/">94.网络API接口设计</a></li>
<li><a href="/python100days/docs/Day91-100/95-%E4%BD%BF%E7%94%A8Django%E5%BC%80%E5%8F%91%E5%95%86%E4%B8%9A%E9%A1%B9%E7%9B%AE/">95.使用Django开发商业项目</a></li>
<li><a href="/python100days/docs/Day91-100/96-%E8%BD%AF%E4%BB%B6%E6%B5%8B%E8%AF%95%E5%92%8C%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/">96.软件测试和自动化测试</a></li>
<li><a href="/python100days/docs/Day91-100/97-%E7%94%B5%E5%95%86%E7%BD%91%E7%AB%99%E6%8A%80%E6%9C%AF%E8%A6%81%E7%82%B9%E5%89%96%E6%9E%90/">97.电商网站技术要点剖析</a></li>
<li><a href="/python100days/docs/Day91-100/98-%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E4%B8%8A%E7%BA%BF%E5%92%8C%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/">98.项目部署上线和性能调优</a></li>
<li><a href="/python100days/docs/Day91-100/99-%E9%9D%A2%E8%AF%95%E4%B8%AD%E7%9A%84%E5%85%AC%E5%85%B1%E9%97%AE%E9%A2%98/">99.面试中的公共问题</a></li>
<li><a href="/python100days/docs/Day91-100/100-%E8%8B%B1%E8%AF%AD%E9%9D%A2%E8%AF%95/">100.英语面试</a></li>
</ul></li>
</ul>







</nav>


<script>
(function() {
  var menu = document.querySelector("aside.book-menu nav");
  addEventListener("beforeunload", function(event) {
    localStorage.setItem("menu.scrollTop", menu.scrollTop);
  });
  menu.scrollTop = localStorage.getItem("menu.scrollTop");
})();
</script>

    </aside>

    <div class="book-page">
      <header class="flex align-center justify-between book-header">
  <label for="menu-control">
    <img src="/python100days/svg/menu.svg" alt="Menu" />
  </label>
  <strong>69 并发下载</strong>
</header>

      
<article class="markdown">

<h1 id="并发下载">并发下载</h1>

<h2 id="多线程和多进程回顾">多线程和多进程回顾</h2>

<p>在前面的<a href="../../Day01-15/13-进程和线程/">《进程和线程》</a>一文中，我们已经对在Python中使用多进程和多线程实现并发编程进行了简明的讲解，在此我们补充几个知识点。</p>

<h3 id="threading-local类">threading.local类</h3>

<p>使用线程时最不愿意遇到的情况就是多个线程竞争资源，在这种情况下为了保证资源状态的正确性，我们可能需要对资源进行加锁保护的处理，这一方面会导致程序失去并发性，另外如果多个线程竞争多个资源时，还有可能因为加锁方式的不当导致<a href="https://zh.wikipedia.org/wiki/%E6%AD%BB%E9%94%81">死锁</a>。要解决多个线程竞争资源的问题，其中一个方案就是让每个线程都持有资源的副本（拷贝），这样每个线程可以操作自己所持有的资源，从而规避对资源的竞争。</p>

<p>要实现将资源和持有资源的线程进行绑定的操作，最简单的做法就是使用threading模块的local类，在网络爬虫开发中，就可以使用local类为每个线程绑定一个MySQL数据库连接或Redis客户端对象，这样通过线程可以直接获得这些资源，既解决了资源竞争的问题，又避免了在函数和方法调用时传递这些资源。具体的请参考本章多线程爬取“手机搜狐网”（Redis版）的实例代码。</p>

<h3 id="concurrent-futures模块">concurrent.futures模块</h3>

<p>Python3.2带来了<code>concurrent.futures</code> 模块，这个模块包含了线程池和进程池、管理并行编程任务、处理非确定性的执行流程、进程/线程同步等功能。关于这部分的内容推荐大家阅读<a href="http://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/index.html">《Python并行编程》</a>。</p>

<h3 id="分布式进程">分布式进程</h3>

<p>使用多进程的时候，可以将进程部署在多个主机节点上，Python的<code>multiprocessing</code>模块不但支持多进程，其中<code>managers</code>子模块还支持把多进程部署到多个节点上。当然，要部署分布式进程，首先需要一个服务进程作为调度者，进程之间通过网络进行通信来实现对进程的控制和调度，由于<code>managers</code>模块已经对这些做出了很好的封装，因此在无需了解网络通信细节的前提下，就可以编写分布式多进程应用。具体的请参照本章分布式多进程爬取“手机搜狐网”的实例代码。</p>

<h2 id="协程和异步i-o">协程和异步I/O</h2>

<h3 id="协程的概念">协程的概念</h3>

<p>协程（coroutine）通常又称之为微线程或纤程，它是相互协作的一组子程序（函数）。所谓相互协作指的是在执行函数A时，可以随时中断去执行函数B，然后又中断继续执行函数A。注意，这一过程并不是函数调用（因为没有调用语句），整个过程看似像多线程，然而协程只有一个线程执行。协程通过<code>yield</code>关键字和 <code>send()</code>操作来转移执行权，协程之间不是调用者与被调用者的关系。</p>

<p>协程的优势在于以下两点：</p>

<ol>
<li>执行效率极高，因为子程序（函数）切换不是线程切换，由程序自身控制，没有切换线程的开销。</li>
<li>不需要多线程的锁机制，因为只有一个线程，也不存在竞争资源的问题，当然也就不需要对资源加锁保护，因此执行效率高很多。</li>
</ol>

<blockquote>
<p>说明：协程适合处理的是I/O密集型任务，处理CPU密集型任务并不是它的长处，如果要提升CPU的利用率可以考虑“多进程+协程”的模式。</p>
</blockquote>

<h3 id="历史回顾">历史回顾</h3>

<ol>
<li>Python 2.2：第一次提出了生成器（最初称之为迭代器）的概念（PEP 255）。</li>
<li>Python 2.5：引入了将对象发送回暂停了的生成器这一特性即生成器的<code>send()</code>方法（PEP 342）。</li>
<li>Python 3.3：添加了<code>yield from</code>特性，允许从迭代器中返回任何值（注意生成器本身也是迭代器），这样我们就可以串联生成器并且重构出更好的生成器。</li>
<li>Python 3.4：引入<code>asyncio.coroutine</code>装饰器用来标记作为协程的函数，协程函数和<code>asyncio</code>及其事件循环一起使用，来实现异步I/O操作。</li>
<li>Python 3.5：引入了<code>async</code>和<code>await</code>，可以使用<code>async def</code>来定义一个协程函数，这个函数中不能包含任何形式的<code>yield</code>语句，但是可以使用<code>return</code>或<code>await</code>从协程中返回值。</li>
</ol>

<h3 id="示例代码">示例代码</h3>

<ol>
<li><p>生成器 - 数据的生产者。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> sleep


<span style="color:#75715e"># 倒计数生成器</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">countdown</span>(n):
   <span style="color:#66d9ef">while</span> n <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
       <span style="color:#66d9ef">yield</span> n
       n <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
   <span style="color:#66d9ef">for</span> num <span style="color:#f92672">in</span> countdown(<span style="color:#ae81ff">5</span>):
       <span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#39;Countdown: {num}&#39;</span>)
       sleep(<span style="color:#ae81ff">1</span>)
   <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Countdown Over!&#39;</span>)


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
   main()</code></pre></div></li>
</ol>

<p>生成器还可以叠加来组成生成器管道，代码如下所示。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">   <span style="color:#75715e"># Fibonacci数生成器</span>
   <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fib</span>():
       a, b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>
       <span style="color:#66d9ef">while</span> True:
           a, b <span style="color:#f92672">=</span> b, a <span style="color:#f92672">+</span> b
           <span style="color:#66d9ef">yield</span> a


   <span style="color:#75715e"># 偶数生成器</span>
   <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">even</span>(gen):
       <span style="color:#66d9ef">for</span> val <span style="color:#f92672">in</span> gen:
           <span style="color:#66d9ef">if</span> val <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
               <span style="color:#66d9ef">yield</span> val


   <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
       gen <span style="color:#f92672">=</span> even(fib())
       <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>):
           <span style="color:#66d9ef">print</span>(next(gen))


   <span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
       main()</code></pre></div>
<ol>
<li><p>协程 - 数据的消费者。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> sleep


<span style="color:#75715e"># 生成器 - 数据生产者</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">countdown_gen</span>(n, consumer):
   consumer<span style="color:#f92672">.</span>send(None)
   <span style="color:#66d9ef">while</span> n <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
       consumer<span style="color:#f92672">.</span>send(n)
       n <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>
   consumer<span style="color:#f92672">.</span>send(None)


<span style="color:#75715e"># 协程 - 数据消费者</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">countdown_con</span>():
   <span style="color:#66d9ef">while</span> True:
       n <span style="color:#f92672">=</span> <span style="color:#66d9ef">yield</span>
       <span style="color:#66d9ef">if</span> n:
           <span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#39;Countdown {n}&#39;</span>)
           sleep(<span style="color:#ae81ff">1</span>)
       <span style="color:#66d9ef">else</span>:
           <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Countdown Over!&#39;</span>)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
   countdown_gen(<span style="color:#ae81ff">5</span>, countdown_con())


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
   main()</code></pre></div></li>
</ol>

<blockquote>
<p>说明：上面代码中countdown_gen函数中的第1行consumer.send(None)是为了激活生成器，通俗的说就是让生成器执行到有yield关键字的地方挂起，当然也可以通过next(consumer)来达到同样的效果。如果不愿意每次都用这样的代码来“预激”生成器，可以写一个包装器来完成该操作，代码如下所示。</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">   <span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> wraps


   <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">coroutine</span>(fn):

       <span style="color:#a6e22e">@wraps</span>(fn)
       <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapper</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
           gen <span style="color:#f92672">=</span> fn(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
           next(gen)
           <span style="color:#66d9ef">return</span> gen

       <span style="color:#66d9ef">return</span> wrapper</code></pre></div>
<p>这样就可以使用<code>@coroutine</code>装饰器对协程进行预激操作，不需要再写重复代码来激活协程。</p>

<ol>
<li><p>异步I/O - 非阻塞式I/O操作。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">import</span> asyncio


<span style="color:#a6e22e">@asyncio.coroutine</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">countdown</span>(name, n):
   <span style="color:#66d9ef">while</span> n <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
       <span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#39;Countdown[{name}]: {n}&#39;</span>)
       <span style="color:#66d9ef">yield</span> <span style="color:#f92672">from</span> asyncio.sleep(<span style="color:#ae81ff">1</span>)
       n <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
   loop <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>get_event_loop()
   tasks <span style="color:#f92672">=</span> [
       countdown(<span style="color:#e6db74">&#34;A&#34;</span>, <span style="color:#ae81ff">10</span>), countdown(<span style="color:#e6db74">&#34;B&#34;</span>, <span style="color:#ae81ff">5</span>),
   ]
   loop<span style="color:#f92672">.</span>run_until_complete(asyncio<span style="color:#f92672">.</span>wait(tasks))
   loop<span style="color:#f92672">.</span>close()


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
   main()</code></pre></div></li>

<li><p><code>async</code>和<code>await</code>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">import</span> asyncio
<span style="color:#f92672">import</span> aiohttp


async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">download</span>(url):
   <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Fetch:&#39;</span>, url)
   async <span style="color:#66d9ef">with</span> aiohttp<span style="color:#f92672">.</span>ClientSession() <span style="color:#66d9ef">as</span> session:
       async <span style="color:#66d9ef">with</span> session<span style="color:#f92672">.</span>get(url) <span style="color:#66d9ef">as</span> resp:
           <span style="color:#66d9ef">print</span>(url, <span style="color:#e6db74">&#39;---&gt;&#39;</span>, resp<span style="color:#f92672">.</span>status)
           <span style="color:#66d9ef">print</span>(url, <span style="color:#e6db74">&#39;---&gt;&#39;</span>, resp<span style="color:#f92672">.</span>cookies)
           <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#39;</span>, await resp<span style="color:#f92672">.</span>text())


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
   loop <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>get_event_loop()
   urls <span style="color:#f92672">=</span> [
       <span style="color:#e6db74">&#39;https://www.baidu.com&#39;</span>,
       <span style="color:#e6db74">&#39;http://www.sohu.com/&#39;</span>,
       <span style="color:#e6db74">&#39;http://www.sina.com.cn/&#39;</span>,
       <span style="color:#e6db74">&#39;https://www.taobao.com/&#39;</span>,
       <span style="color:#e6db74">&#39;https://www.jd.com/&#39;</span>
   ]
   tasks <span style="color:#f92672">=</span> [download(url) <span style="color:#66d9ef">for</span> url <span style="color:#f92672">in</span> urls]
   loop<span style="color:#f92672">.</span>run_until_complete(asyncio<span style="color:#f92672">.</span>wait(tasks))
   loop<span style="color:#f92672">.</span>close()


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
   main()</code></pre></div></li>
</ol>

<p>上面的代码使用了<a href="https://github.com/aio-libs/aiohttp">AIOHTTP</a>这个非常著名的第三方库，它实现了HTTP客户端和HTTP服务器的功能，对异步操作提供了非常好的支持，有兴趣可以阅读它的<a href="https://aiohttp.readthedocs.io/en/stable/">官方文档</a>。</p>

<h2 id="实例-多线程爬取-手机搜狐网-所有页面">实例 - 多线程爬取“手机搜狐网”所有页面</h2>

<p>下面我们把之间讲的所有知识结合起来，用面向对象的方式实现一个爬取“手机搜狐网”的多线程爬虫。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">import</span> pickle
<span style="color:#f92672">import</span> zlib
<span style="color:#f92672">from</span> enum <span style="color:#f92672">import</span> Enum, unique
<span style="color:#f92672">from</span> hashlib <span style="color:#f92672">import</span> sha1
<span style="color:#f92672">from</span> random <span style="color:#f92672">import</span> random
<span style="color:#f92672">from</span> threading <span style="color:#f92672">import</span> Thread, current_thread, local
<span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> sleep
<span style="color:#f92672">from</span> urllib.parse <span style="color:#f92672">import</span> urlparse

<span style="color:#f92672">import</span> pymongo
<span style="color:#f92672">import</span> redis
<span style="color:#f92672">import</span> requests
<span style="color:#f92672">from</span> bs4 <span style="color:#f92672">import</span> BeautifulSoup
<span style="color:#f92672">from</span> bson <span style="color:#f92672">import</span> Binary


<span style="color:#a6e22e">@unique</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SpiderStatus</span>(Enum):
    IDLE <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    WORKING <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decode_page</span>(page_bytes, charsets<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;utf-8&#39;</span>,)):
    page_html <span style="color:#f92672">=</span> None
    <span style="color:#66d9ef">for</span> charset <span style="color:#f92672">in</span> charsets:
        <span style="color:#66d9ef">try</span>:
            page_html <span style="color:#f92672">=</span> page_bytes<span style="color:#f92672">.</span>decode(charset)
            <span style="color:#66d9ef">break</span>
        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">UnicodeDecodeError</span>:
            <span style="color:#66d9ef">pass</span>
    <span style="color:#66d9ef">return</span> page_html


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Retry</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, <span style="color:#f92672">*</span>, retry_times<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>,
                 wait_secs<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, errors<span style="color:#f92672">=</span>(<span style="color:#a6e22e">Exception</span>, )):
        self<span style="color:#f92672">.</span>retry_times <span style="color:#f92672">=</span> retry_times
        self<span style="color:#f92672">.</span>wait_secs <span style="color:#f92672">=</span> wait_secs
        self<span style="color:#f92672">.</span>errors <span style="color:#f92672">=</span> errors

    <span style="color:#66d9ef">def</span> __call__(self, fn):

        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapper</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
            <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(self<span style="color:#f92672">.</span>retry_times):
                <span style="color:#66d9ef">try</span>:
                    <span style="color:#66d9ef">return</span> fn(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
                <span style="color:#66d9ef">except</span> self<span style="color:#f92672">.</span>errors <span style="color:#66d9ef">as</span> e:
                    <span style="color:#66d9ef">print</span>(e)
                    sleep((random() <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> self<span style="color:#f92672">.</span>wait_secs)
            <span style="color:#66d9ef">return</span> None

        <span style="color:#66d9ef">return</span> wrapper


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Spider</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self):
        self<span style="color:#f92672">.</span>status <span style="color:#f92672">=</span> SpiderStatus<span style="color:#f92672">.</span>IDLE

    <span style="color:#a6e22e">@Retry</span>()
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fetch</span>(self, current_url, <span style="color:#f92672">*</span>, charsets<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;utf-8&#39;</span>, ),
              user_agent<span style="color:#f92672">=</span>None, proxies<span style="color:#f92672">=</span>None):
        thread_name <span style="color:#f92672">=</span> current_thread()<span style="color:#f92672">.</span>name
        <span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#39;[{thread_name}]: {current_url}&#39;</span>)
        headers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;user-agent&#39;</span>: user_agent} <span style="color:#66d9ef">if</span> user_agent <span style="color:#66d9ef">else</span> {}
        resp <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(current_url,
                            headers<span style="color:#f92672">=</span>headers, proxies<span style="color:#f92672">=</span>proxies)
        <span style="color:#66d9ef">return</span> decode_page(resp<span style="color:#f92672">.</span>content, charsets) \
            <span style="color:#66d9ef">if</span> resp<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span> <span style="color:#66d9ef">else</span> None

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parse</span>(self, html_page, <span style="color:#f92672">*</span>, domain<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;m.sohu.com&#39;</span>):
        soup <span style="color:#f92672">=</span> BeautifulSoup(html_page, <span style="color:#e6db74">&#39;lxml&#39;</span>)
        <span style="color:#66d9ef">for</span> a_tag <span style="color:#f92672">in</span> soup<span style="color:#f92672">.</span>body<span style="color:#f92672">.</span>select(<span style="color:#e6db74">&#39;a[href]&#39;</span>):
            parser <span style="color:#f92672">=</span> urlparse(a_tag<span style="color:#f92672">.</span>attrs[<span style="color:#e6db74">&#39;href&#39;</span>])
            scheme <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>scheme <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;http&#39;</span>
            netloc <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>netloc <span style="color:#f92672">or</span> domain
            <span style="color:#66d9ef">if</span> scheme <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;javascript&#39;</span> <span style="color:#f92672">and</span> netloc <span style="color:#f92672">==</span> domain:
                path <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>path
                query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;?&#39;</span> <span style="color:#f92672">+</span> parser<span style="color:#f92672">.</span>query <span style="color:#66d9ef">if</span> parser<span style="color:#f92672">.</span>query <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;&#39;</span>
                full_url <span style="color:#f92672">=</span> f<span style="color:#e6db74">&#39;{scheme}://{netloc}{path}{query}&#39;</span>
                redis_client <span style="color:#f92672">=</span> thread_local<span style="color:#f92672">.</span>redis_client
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> redis_client<span style="color:#f92672">.</span>sismember(<span style="color:#e6db74">&#39;visited_urls&#39;</span>, full_url):
                    redis_client<span style="color:#f92672">.</span>rpush(<span style="color:#e6db74">&#39;m_sohu_task&#39;</span>, full_url)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">extract</span>(self, html_page):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">store</span>(self, data_dict):
        <span style="color:#75715e"># redis_client = thread_local.redis_client</span>
        <span style="color:#75715e"># mongo_db = thread_local.mongo_db</span>
        <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SpiderThread</span>(Thread):

    <span style="color:#66d9ef">def</span> __init__(self, name, spider):
        super()<span style="color:#f92672">.</span>__init__(name<span style="color:#f92672">=</span>name, daemon<span style="color:#f92672">=</span>True)
        self<span style="color:#f92672">.</span>spider <span style="color:#f92672">=</span> spider

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>(self):
        redis_client <span style="color:#f92672">=</span> redis<span style="color:#f92672">.</span>Redis(host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;1.2.3.4&#39;</span>, port<span style="color:#f92672">=</span><span style="color:#ae81ff">6379</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;1qaz2wsx&#39;</span>)
        mongo_client <span style="color:#f92672">=</span> pymongo<span style="color:#f92672">.</span>MongoClient(host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;1.2.3.4&#39;</span>, port<span style="color:#f92672">=</span><span style="color:#ae81ff">27017</span>)
        thread_local<span style="color:#f92672">.</span>redis_client <span style="color:#f92672">=</span> redis_client
        thread_local<span style="color:#f92672">.</span>mongo_db <span style="color:#f92672">=</span> mongo_client<span style="color:#f92672">.</span>msohu
        <span style="color:#66d9ef">while</span> True:
            current_url <span style="color:#f92672">=</span> redis_client<span style="color:#f92672">.</span>lpop(<span style="color:#e6db74">&#39;m_sohu_task&#39;</span>)
            <span style="color:#66d9ef">while</span> <span style="color:#f92672">not</span> current_url:
                current_url <span style="color:#f92672">=</span> redis_client<span style="color:#f92672">.</span>lpop(<span style="color:#e6db74">&#39;m_sohu_task&#39;</span>)
            self<span style="color:#f92672">.</span>spider<span style="color:#f92672">.</span>status <span style="color:#f92672">=</span> SpiderStatus<span style="color:#f92672">.</span>WORKING
            current_url <span style="color:#f92672">=</span> current_url<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> redis_client<span style="color:#f92672">.</span>sismember(<span style="color:#e6db74">&#39;visited_urls&#39;</span>, current_url):
                redis_client<span style="color:#f92672">.</span>sadd(<span style="color:#e6db74">&#39;visited_urls&#39;</span>, current_url)
                html_page <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>spider<span style="color:#f92672">.</span>fetch(current_url)
                <span style="color:#66d9ef">if</span> html_page <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> [None, <span style="color:#e6db74">&#39;&#39;</span>]:
                    hasher <span style="color:#f92672">=</span> hasher_proto<span style="color:#f92672">.</span>copy()
                    hasher<span style="color:#f92672">.</span>update(current_url<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))
                    doc_id <span style="color:#f92672">=</span> hasher<span style="color:#f92672">.</span>hexdigest()
                    sohu_data_coll <span style="color:#f92672">=</span> mongo_client<span style="color:#f92672">.</span>msohu<span style="color:#f92672">.</span>webpages
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> sohu_data_coll<span style="color:#f92672">.</span>find_one({<span style="color:#e6db74">&#39;_id&#39;</span>: doc_id}):
                        sohu_data_coll<span style="color:#f92672">.</span>insert_one({
                            <span style="color:#e6db74">&#39;_id&#39;</span>: doc_id,
                            <span style="color:#e6db74">&#39;url&#39;</span>: current_url,
                            <span style="color:#e6db74">&#39;page&#39;</span>: Binary(zlib<span style="color:#f92672">.</span>compress(pickle<span style="color:#f92672">.</span>dumps(html_page)))
                        })
                    self<span style="color:#f92672">.</span>spider<span style="color:#f92672">.</span>parse(html_page)
            self<span style="color:#f92672">.</span>spider<span style="color:#f92672">.</span>status <span style="color:#f92672">=</span> SpiderStatus<span style="color:#f92672">.</span>IDLE


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_any_alive</span>(spider_threads):
    <span style="color:#66d9ef">return</span> any([spider_thread<span style="color:#f92672">.</span>spider<span style="color:#f92672">.</span>status <span style="color:#f92672">==</span> SpiderStatus<span style="color:#f92672">.</span>WORKING
                <span style="color:#66d9ef">for</span> spider_thread <span style="color:#f92672">in</span> spider_threads])


thread_local <span style="color:#f92672">=</span> local()
hasher_proto <span style="color:#f92672">=</span> sha1()


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
    redis_client <span style="color:#f92672">=</span> redis<span style="color:#f92672">.</span>Redis(host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;1.2.3.4&#39;</span>, port<span style="color:#f92672">=</span><span style="color:#ae81ff">6379</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;1qaz2wsx&#39;</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> redis_client<span style="color:#f92672">.</span>exists(<span style="color:#e6db74">&#39;m_sohu_task&#39;</span>):
        redis_client<span style="color:#f92672">.</span>rpush(<span style="color:#e6db74">&#39;m_sohu_task&#39;</span>, <span style="color:#e6db74">&#39;http://m.sohu.com/&#39;</span>)

    spider_threads <span style="color:#f92672">=</span> [SpiderThread(<span style="color:#e6db74">&#39;thread-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> i, Spider())
                      <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>)]
    <span style="color:#66d9ef">for</span> spider_thread <span style="color:#f92672">in</span> spider_threads:
        spider_thread<span style="color:#f92672">.</span>start()

    <span style="color:#66d9ef">while</span> redis_client<span style="color:#f92672">.</span>exists(<span style="color:#e6db74">&#39;m_sohu_task&#39;</span>) <span style="color:#f92672">or</span> is_any_alive(spider_threads):
        sleep(<span style="color:#ae81ff">5</span>)

    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Over!&#39;</span>)


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    main()</code></pre></div></article>

      

      
    </div>

    
  

  <aside class="book-toc level-3 fixed">
    <nav id="TableOfContents">
<ul>
<li><a href="#并发下载">并发下载</a>
<ul>
<li><a href="#多线程和多进程回顾">多线程和多进程回顾</a>
<ul>
<li><a href="#threading-local类">threading.local类</a></li>
<li><a href="#concurrent-futures模块">concurrent.futures模块</a></li>
<li><a href="#分布式进程">分布式进程</a></li>
</ul></li>
<li><a href="#协程和异步i-o">协程和异步I/O</a>
<ul>
<li><a href="#协程的概念">协程的概念</a></li>
<li><a href="#历史回顾">历史回顾</a></li>
<li><a href="#示例代码">示例代码</a></li>
</ul></li>
<li><a href="#实例-多线程爬取-手机搜狐网-所有页面">实例 - 多线程爬取“手机搜狐网”所有页面</a></li>
</ul></li>
</ul>
</nav>
  </aside>



  </main>

  
  
</body>

</html>
