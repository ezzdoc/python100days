<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>95 使用 Django开发商业项目 | Python-100天从新手到大师</title>


<link rel="stylesheet" href="/python100days/book.min.89885fa0429ec73067282f26fc0c6d38cfc617a443ec4e835d47b821c52c6e92.css" integrity="sha256-iYhfoEKexzBnKC8m/AxtOM/GF6RD7E6DXUe4IcUsbpI=">


<script defer src="/python100days/search.min.60214faf2667d486f5a5c602eb23dff270f5cbd9d003a2a159b89871099dc1b4.js" integrity="sha256-YCFPryZn1Ib1pcYC6yPf8nD1y9nQA6KhWbiYcQmdwbQ="></script>



<link rel="icon" href="/python100days/favicon.png" type="image/x-icon">

<base href="https://ezzdoc.github.io/python100days/">


<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="flex container">

    <aside class="book-menu fixed">
      <nav>
<h2 class="book-brand">
  <a href="https://ezzdoc.github.io/python100days/"><span>Python-100天从新手到大师</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" placeholder="Search" id="book-search-input" maxlength="64" readonly />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>





    
  
  
  

  <style>
  nav ul a[href$="\2fpython100days\2f docs\2f Day91-100\2f 95-%E4%BD%BF%E7%94%A8Django%E5%BC%80%E5%8F%91%E5%95%86%E4%B8%9A%E9%A1%B9%E7%9B%AE\2f "] {
      color: #004ed0;
  }
  </style>

<ul>
<li><a href="/python100days/posts/"><strong>相关文章</strong></a></li>
<li><strong>Day01-15</strong>

<ul>
<li><a href="/python100days/docs/Day01-15/01-%E5%88%9D%E8%AF%86Python/">01.初识Python</a></li>
<li><a href="/python100days/docs/Day01-15/02-%E8%AF%AD%E8%A8%80%E5%85%83%E7%B4%A0/">02.语言元素</a></li>
<li><a href="/python100days/docs/Day01-15/03-%E5%88%86%E6%94%AF%E7%BB%93%E6%9E%84/">03.分支结构</a></li>
<li><a href="/python100days/docs/Day01-15/04-%E5%BE%AA%E7%8E%AF%E7%BB%93%E6%9E%84/">04.循环结构</a></li>
<li><a href="/python100days/docs/Day01-15/05-%E6%9E%84%E9%80%A0%E7%A8%8B%E5%BA%8F%E9%80%BB%E8%BE%91/">05.构造程序逻辑</a></li>
<li><a href="/python100days/docs/Day01-15/06-%E5%87%BD%E6%95%B0%E5%92%8C%E6%A8%A1%E5%9D%97%E7%9A%84%E4%BD%BF%E7%94%A8/">06.函数和模块的使用</a></li>
<li><a href="/python100days/docs/Day01-15/07-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%92%8C%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">07.字符串和常用数据结构</a></li>
<li><a href="/python100days/docs/Day01-15/08-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/">08.面向对象编程基础</a></li>
<li><a href="/python100days/docs/Day01-15/09-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BF%9B%E9%98%B6/">09.面向对象进阶</a></li>
<li><a href="/python100days/docs/Day01-15/10-%E5%9B%BE%E5%BD%A2%E7%94%A8%E6%88%B7%E7%95%8C%E9%9D%A2%E5%92%8C%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/">10.图形用户界面和游戏开发</a></li>
<li><a href="/python100days/docs/Day01-15/11-%E6%96%87%E4%BB%B6%E5%92%8C%E5%BC%82%E5%B8%B8/">11.文件和异常</a></li>
<li><a href="/python100days/docs/Day01-15/12-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%92%8C%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">12.字符串和正则表达式</a></li>
<li><a href="/python100days/docs/Day01-15/13-%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B/">13.进程和线程</a></li>
<li><a href="/python100days/docs/Day01-15/14-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/">14.网络编程入门和网络应用开发</a></li>
<li><a href="/python100days/docs/Day01-15/15-%E5%9B%BE%E5%83%8F%E5%92%8C%E5%8A%9E%E5%85%AC%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86/">15.图像和办公文档处理</a></li>
</ul></li>
<li><strong>Day16-20</strong>

<ul>
<li><a href="/python100days/docs/Day16-20/16-20-Python%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/">16-20.Python语言进阶</a></li>
</ul></li>
<li><strong>Day21-30</strong>

<ul>
<li><a href="/python100days/docs/Day21-30/21-30-Web%E5%89%8D%E7%AB%AF%E6%A6%82%E8%BF%B0/">21-30.Web前端概述</a></li>
</ul></li>
<li><strong>Day31-35</strong>

<ul>
<li><a href="/python100days/docs/Day31-35/31-35-%E7%8E%A9%E8%BD%ACLinux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">31-35.玩转Linux操作系统</a></li>
</ul></li>
<li><strong>Day36-40</strong>

<ul>
<li><a href="/python100days/docs/Day36-40/36-38-%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93MySQL/">36-38.关系型数据库MySQL</a></li>
<li><a href="/python100days/docs/Day36-40/39-40-NoSQL%E5%85%A5%E9%97%A8/">39-40.NoSQL入门</a></li>
</ul></li>
<li><strong>Day41-55</strong>

<ul>
<li><a href="/python100days/docs/Day41-55/41-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/">41.快速上手</a></li>
<li><a href="/python100days/docs/Day41-55/42-%E6%B7%B1%E5%85%A5%E6%A8%A1%E5%9E%8B/">42.深入模型</a></li>
<li><a href="/python100days/docs/Day41-55/43-%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E5%92%8CAjax%E8%AF%B7%E6%B1%82/">43.静态资源和Ajax请求</a></li>
<li><a href="/python100days/docs/Day41-55/44-%E8%A1%A8%E5%8D%95%E7%9A%84%E5%BA%94%E7%94%A8/">44.表单的应用</a></li>
<li><a href="/python100days/docs/Day41-55/45-Cookie%E5%92%8CSession/">45.Cookie和Session</a></li>
<li><a href="/python100days/docs/Day41-55/46-%E6%8A%A5%E8%A1%A8%E5%92%8C%E6%97%A5%E5%BF%97/">46.报表和日志</a></li>
<li><a href="/python100days/docs/Day41-55/47-%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E5%BA%94%E7%94%A8/">47.中间件的应用</a></li>
<li><a href="/python100days/docs/Day41-55/48-%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/">48.前后端分离开发入门</a></li>
<li><a href="/python100days/docs/Day41-55/49-RESTful%E6%9E%B6%E6%9E%84%E5%92%8CDRF%E5%85%A5%E9%97%A8/">49.RESTful架构和DRF入门</a></li>
<li><a href="/python100days/docs/Day41-55/50-RESTful%E6%9E%B6%E6%9E%84%E5%92%8CDRF%E8%BF%9B%E9%98%B6/">50.RESTful架构和DRF进阶</a></li>
<li><a href="/python100days/docs/Day41-55/51-%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98/">51.使用缓存</a></li>
<li><a href="/python100days/docs/Day41-55/52-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%92%8C%E5%AF%8C%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91/">52.文件上传和富文本编辑</a></li>
<li><a href="/python100days/docs/Day41-55/53-%E7%9F%AD%E4%BF%A1%E5%92%8C%E9%82%AE%E4%BB%B6/">53.短信和邮件</a></li>
<li><a href="/python100days/docs/Day41-55/54-%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E5%92%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/">54.异步任务和定时任务</a></li>
<li><a href="/python100days/docs/Day41-55/55-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E5%92%8C%E9%A1%B9%E7%9B%AE%E4%B8%8A%E7%BA%BF/">55.单元测试和项目上线</a></li>
</ul></li>
<li><strong>Day56-60</strong>

<ul>
<li><a href="/python100days/docs/Day56-60/56-Flask%E5%85%A5%E9%97%A8/">56.Flask入门</a></li>
<li><a href="/python100days/docs/Day56-60/57-%E6%A8%A1%E6%9D%BF%E7%9A%84%E4%BD%BF%E7%94%A8/">57.模板的使用</a></li>
<li><a href="/python100days/docs/Day56-60/58-%E8%A1%A8%E5%8D%95%E7%9A%84%E5%A4%84%E7%90%86/">58.表单的处理</a></li>
<li><a href="/python100days/docs/Day56-60/59-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/">59.数据库操作</a></li>
<li><a href="/python100days/docs/Day56-60/60-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">60.项目实战</a></li>
</ul></li>
<li><strong>Day61-65</strong>

<ul>
<li><a href="/python100days/docs/Day61-65/61-%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86/">61.预备知识</a></li>
<li><a href="/python100days/docs/Day61-65/62-Tornado%E5%85%A5%E9%97%A8/">62.Tornado入门</a></li>
<li><a href="/python100days/docs/Day61-65/63-%E5%BC%82%E6%AD%A5%E5%8C%96/">63.异步化</a></li>
<li><a href="/python100days/docs/Day61-65/64-WebSocket%E7%9A%84%E5%BA%94%E7%94%A8/">64.WebSocket的应用</a></li>
<li><a href="/python100days/docs/Day61-65/65-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">65.项目实战</a></li>
</ul></li>
<li><strong>Day66-75</strong>

<ul>
<li><a href="/python100days/docs/Day66-75/66-%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%92%8C%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7/">66.网络爬虫和相关工具</a></li>
<li><a href="/python100days/docs/Day66-75/67-%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86%E5%92%8C%E8%A7%A3%E6%9E%90/">67.数据采集和解析</a></li>
<li><a href="/python100days/docs/Day66-75/68-%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE/">68.存储数据</a></li>
<li><a href="/python100days/docs/Day66-75/69-%E5%B9%B6%E5%8F%91%E4%B8%8B%E8%BD%BD/">69.并发下载</a></li>
<li><a href="/python100days/docs/Day66-75/70-%E8%A7%A3%E6%9E%90%E5%8A%A8%E6%80%81%E5%86%85%E5%AE%B9/">70.解析动态内容</a></li>
<li><a href="/python100days/docs/Day66-75/71-%E8%A1%A8%E5%8D%95%E4%BA%A4%E4%BA%92%E5%92%8C%E9%AA%8C%E8%AF%81%E7%A0%81%E5%A4%84%E7%90%86/">71.表单交互和验证码处理</a></li>
<li><a href="/python100days/docs/Day66-75/72-Scrapy%E5%85%A5%E9%97%A8/">72.Scrapy入门</a></li>
<li><a href="/python100days/docs/Day66-75/73-Scrapy%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8/">73.Scrapy高级应用</a></li>
<li><a href="/python100days/docs/Day66-75/74-Scrapy%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9E%E7%8E%B0/">74.Scrapy分布式实现</a></li>
<li><a href="/python100days/docs/Day66-75/75-%E7%88%AC%E8%99%AB%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">75.爬虫项目实战</a></li>
</ul></li>
<li><strong>Day76-90</strong>

<ul>
<li><a href="/python100days/docs/Day76-90/76-%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/">76.机器学习基础</a></li>
<li><a href="/python100days/docs/Day76-90/77-Pandas%E7%9A%84%E5%BA%94%E7%94%A8/">77.Pandas的应用</a></li>
<li><a href="/python100days/docs/Day76-90/78-NumPy%E5%92%8CSciPy%E7%9A%84%E5%BA%94%E7%94%A8/">78.NumPy和SciPy的应用</a></li>
<li><a href="/python100days/docs/Day76-90/79-Matplotlib%E5%92%8C%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/">79.Matplotlib和数据可视化</a></li>
<li><a href="/python100days/docs/Day76-90/80-k%E6%9C%80%E8%BF%91%E9%82%BB%E5%88%86%E7%B1%BB/">80.k最近邻分类</a></li>
<li><a href="/python100days/docs/Day76-90/81-%E5%86%B3%E7%AD%96%E6%A0%91/">81.决策树</a></li>
<li><a href="/python100days/docs/Day76-90/82-%E8%B4%9D%E5%8F%B6%E6%96%AF%E5%88%86%E7%B1%BB/">82.贝叶斯分类</a></li>
<li><a href="/python100days/docs/Day76-90/83-%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BA/">83.支持向量机</a></li>
<li><a href="/python100days/docs/Day76-90/84-K-%E5%9D%87%E5%80%BC%E8%81%9A%E7%B1%BB/">84.K-均值聚类</a></li>
<li><a href="/python100days/docs/Day76-90/85-%E5%9B%9E%E5%BD%92%E5%88%86%E6%9E%90/">85.回归分析</a></li>
<li><a href="/python100days/docs/Day76-90/86-%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/">86.大数据分析入门</a></li>
<li><a href="/python100days/docs/Day76-90/87-%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E8%BF%9B%E9%98%B6/">87.大数据分析进阶</a></li>
<li><a href="/python100days/docs/Day76-90/88-Tensorflow%E5%85%A5%E9%97%A8/">88.Tensorflow入门</a></li>
<li><a href="/python100days/docs/Day76-90/89-Tensorflow%E5%AE%9E%E6%88%98/">89.Tensorflow实战</a></li>
<li><a href="/python100days/docs/Day76-90/90-%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AE%9E%E6%88%98/">90.推荐系统实战</a></li>
</ul></li>
<li><strong>Day91-100</strong>

<ul>
<li><a href="/python100days/docs/Day91-100/91-%E5%9B%A2%E9%98%9F%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E5%87%86%E5%A4%87/">91.团队项目开发准备</a></li>
<li><a href="/python100days/docs/Day91-100/92-%E4%BD%BF%E7%94%A8Docker%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1/">92.使用Docker部署服务</a></li>
<li><a href="/python100days/docs/Day91-100/93-MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">93.MySQL性能优化</a></li>
<li><a href="/python100days/docs/Day91-100/94-%E7%BD%91%E7%BB%9CAPI%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1/">94.网络API接口设计</a></li>
<li><a href="/python100days/docs/Day91-100/95-%E4%BD%BF%E7%94%A8Django%E5%BC%80%E5%8F%91%E5%95%86%E4%B8%9A%E9%A1%B9%E7%9B%AE/">95.使用Django开发商业项目</a></li>
<li><a href="/python100days/docs/Day91-100/96-%E8%BD%AF%E4%BB%B6%E6%B5%8B%E8%AF%95%E5%92%8C%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/">96.软件测试和自动化测试</a></li>
<li><a href="/python100days/docs/Day91-100/97-%E7%94%B5%E5%95%86%E7%BD%91%E7%AB%99%E6%8A%80%E6%9C%AF%E8%A6%81%E7%82%B9%E5%89%96%E6%9E%90/">97.电商网站技术要点剖析</a></li>
<li><a href="/python100days/docs/Day91-100/98-%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E4%B8%8A%E7%BA%BF%E5%92%8C%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/">98.项目部署上线和性能调优</a></li>
<li><a href="/python100days/docs/Day91-100/99-%E9%9D%A2%E8%AF%95%E4%B8%AD%E7%9A%84%E5%85%AC%E5%85%B1%E9%97%AE%E9%A2%98/">99.面试中的公共问题</a></li>
<li><a href="/python100days/docs/Day91-100/100-%E8%8B%B1%E8%AF%AD%E9%9D%A2%E8%AF%95/">100.英语面试</a></li>
</ul></li>
</ul>







</nav>


<script>
(function() {
  var menu = document.querySelector("aside.book-menu nav");
  addEventListener("beforeunload", function(event) {
    localStorage.setItem("menu.scrollTop", menu.scrollTop);
  });
  menu.scrollTop = localStorage.getItem("menu.scrollTop");
})();
</script>

    </aside>

    <div class="book-page">
      <header class="flex align-center justify-between book-header">
  <label for="menu-control">
    <img src="/python100days/svg/menu.svg" alt="Menu" />
  </label>
  <strong>95 使用 Django开发商业项目</strong>
</header>

      
<article class="markdown">

<h1 id="使用django开发商业项目">使用Django开发商业项目</h1>

<blockquote>
<p>说明：本文的部分插图来自于《Python项目开发实战》和《精通Django》，这两本书中都包含了对Django框架精彩的讲解，有兴趣的读者可以自行购买阅读。</p>
</blockquote>

<h2 id="web应用">Web应用</h2>

<p>问题1：描述一个Web应用的工作流程。</p>

<p><img src="Day91-100/res/web-application.png" alt="" /></p>

<p>问题2：描述项目的物理架构。（上图中补充负载均衡（反向代理）服务器、数据库服务器、文件服务器、邮件服务器、缓存服务器、防火墙等，而且每个节点都有可能是多节点构成的集群，如下图所示，架构并不是一开始就是这样，而是逐步演进的）</p>

<p><img src="Day91-100/res/05.django_massive_cluster.png" alt="" /></p>

<p>问题3：描述Django项目的工作流程。（如下图所示）</p>

<p><img src="Day91-100/res/django_request_response_cycle.png" alt="" /></p>

<h2 id="mvc架构模式">MVC架构模式</h2>

<p>问题1：为什么要使用MVC架构模式？（模型和视图解耦合）</p>

<p>问题2：MVC架构中每个部分的作用？（如下图所示）</p>

<p><img src="Day91-100/res/mvc.png" alt="" /></p>

<h2 id="http请求和响应">HTTP请求和响应</h2>

<h3 id="http请求-请求行-请求头-空行-消息体">HTTP请求 = 请求行+请求头+空行+[消息体]</h3>

<p><img src="Day91-100/res/http-request.png" alt="" /></p>

<h3 id="http响应-响应行-响应头-空行-消息体">HTTP响应 = 响应行+响应头+空行+消息体</h3>

<p><img src="Day91-100/res/http-response.png" alt="" /></p>

<ol>
<li><p><code>HTTPRequest</code>对象的属性和方法：</p>

<ul>
<li><code>method</code> - 获取请求方法</li>
<li><code>path</code> / <code>get_full_path()</code> - 获取请求路径/带查询字符串的路径</li>
<li><code>scheme</code> / <code>is_secure()</code> / <code>get_host()</code> / <code>get_port()</code> - 获取请求的协议/主机/端口</li>
<li><code>META</code> / <code>COOKIES</code> - 获取请求头/Cookie信息</li>
<li><code>GET</code> / <code>POST</code> / <code>FILES</code> - 获取GET或POST请求参数/上传的文件</li>
<li><code>get_signed_cookie()</code> - 获取带签名的Cookie</li>
<li><code>is_ajax()</code> - 是不是Ajax异步请求</li>
<li><code>body</code> / <code>content_type</code> / <code>encoding</code> - 获取请求的消息体（bytes流）/MIME类型/编码</li>
</ul></li>

<li><p>中间件添加的属性：</p>

<ul>
<li><code>session</code> / <code>user</code> / <code>site</code></li>
</ul></li>

<li><p><code>HttpResponse</code>对象的属性和方法：</p>

<ul>
<li><code>set_cookie()</code> / <code>set_signed_cookie()</code> / <code>delete_cookie()</code> - 添加/删除Cookie</li>
<li><code>__setitem__</code> / <code>__getitem__</code> / <code>__delitem__</code> - 添加/获取/删除响应头</li>
<li><code>charset</code> / <code>content</code> / <code>status_code</code> - 响应的字符集/消息体（bytes流）/状态码

<ul>
<li>1xx：请求已经收到，继续处理</li>
<li>2xx（成功）：请求已经成功收到、理解和接收。</li>
<li>3xx（重定向）：为完成请求要继续执行后续的操作。</li>
<li>4xx（客户端错误）：请求不正确或不能够被受理。</li>
<li>5xx（服务器错误）：服务器处理请求失败。</li>
</ul></li>
</ul></li>

<li><p><code>JsonResponse</code>（<code>HttpResponse</code>的子类型）对象</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> django.http <span style="color:#f92672">import</span> HttpResponse, JsonResponse
<span style="color:#f92672">&gt;&gt;&gt;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> response <span style="color:#f92672">=</span> JsonResponse({<span style="color:#e6db74">&#39;foo&#39;</span>: <span style="color:#e6db74">&#39;bar&#39;</span>})
<span style="color:#f92672">&gt;&gt;&gt;</span> response<span style="color:#f92672">.</span>content
<span style="color:#f92672">&gt;&gt;&gt;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> response <span style="color:#f92672">=</span> JsonResponse([<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>], safe<span style="color:#f92672">=</span>False)
<span style="color:#f92672">&gt;&gt;&gt;</span> response<span style="color:#f92672">.</span>content
<span style="color:#f92672">&gt;&gt;&gt;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> response <span style="color:#f92672">=</span> HttpResponse(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;...&#39;</span>)
<span style="color:#f92672">&gt;&gt;&gt;</span> response[<span style="color:#e6db74">&#39;cotent-type&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;application/pdf&#39;</span>;
<span style="color:#f92672">&gt;&gt;&gt;</span> response[<span style="color:#e6db74">&#39;content-disposition&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;inline; filename=&#34;xyz.pdf&#34;&#39;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> response[<span style="color:#e6db74">&#39;content-disposition&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;attachment; filename=&#34;xyz.pdf&#34;&#39;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> response<span style="color:#f92672">.</span>set_signed_cookie(<span style="color:#e6db74">&#39;foo&#39;</span>, <span style="color:#e6db74">&#39;bar&#39;</span>, salt<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>)
<span style="color:#f92672">&gt;&gt;&gt;</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span></code></pre></div></li>
</ol>

<h2 id="数据模型-model">数据模型(Model)</h2>

<p>问题1：关系型数据库表的设计应该注意哪些问题（范式理论和逆范式）？如何通过表来创建模型类（反向工程）？如何通过模型类来创建表（正向工程）？</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">python manage.py makemigrations &lt;appname&gt;
python manage.py migrate

python manage.py inspectdb &gt; &lt;appname&gt;/models.py</code></pre></div>
<p>问题2：关系型数据库中数据完整性指的是什么？什么时候需要牺牲数据完整性？（实体完整性/参照完整性/域完整性）</p>

<p>问题3：ORM是什么以及解决了什么问题？（对象模型-关系模型双向转换）</p>

<ol>
<li><p><code>Field</code>及其子类的属性：</p>

<ul>
<li>通用选项：

<ul>
<li><code>db_column</code> / <code>db_tablespace</code></li>
<li><code>null</code> / <code>blank</code> / <code>default</code></li>
<li><code>primary_key</code></li>
<li><code>db_index</code> / <code>unqiue</code></li>
<li><code>choices</code> / <code>help_text</code> / <code>error_message</code> / <code>editable</code> / <code>hidden</code></li>
</ul></li>
<li>其他选项：

<ul>
<li><code>CharField</code>: <code>max_length</code></li>
<li><code>DateField</code>: <code>auto_now</code> / <code>auto_now_add</code></li>
<li><code>DecimalField</code>: <code>max_digits</code> / <code>decimal_places</code></li>
<li><code>FileField</code>: <code>storage</code> / <code>upload_to</code></li>
<li><code>ImageField</code>: <code>height_field</code> / <code>width_field</code></li>
</ul></li>
</ul></li>

<li><p><code>ForeignKey</code>的属性：</p>

<ul>
<li><p>重要属性：</p>

<ul>
<li><p><code>db_constraint</code>（提升性能或者数据分片的情况可能需要设置为<code>False</code>）</p></li>

<li><p><code>on_delete</code></p></li>

<li><p><code>CASCADE</code>：级联删除。</p></li>

<li><p><code>PROTECT</code>：抛出<code>ProtectedError</code>异常，阻止删除引用的对象。</p></li>

<li><p><code>SET_NULL</code>：把外键设置为<code>null</code>，当<code>null</code>属性被设置为<code>True</code>时才能这么做。</p></li>

<li><p><code>SET_DEFAULT</code>：把外键设置为默认值，提供了默认值才能这么做。</p></li>

<li><p><code>related_name</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Dept</span>(models<span style="color:#f92672">.</span>Model):
<span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Emp</span>(models<span style="color:#f92672">.</span>Model):
dept <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>ForeignKey(related_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;+&#39;</span>, <span style="color:#f92672">...</span>)


Dept<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>get(no<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)<span style="color:#f92672">.</span>emp_set<span style="color:#f92672">.</span>all()
Emp<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(dept__no<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)</code></pre></div></li>
</ul></li>
</ul>

<blockquote>
<p>说明：<code>related_name</code>设置为<code>'+'</code>，可以防止一对多外键关联从“一”的一方查询“多”的一方。</p>
</blockquote>

<ul>
<li><p>其他属性：</p>

<ul>
<li><code>to_field</code> / <code>limit_choices_to</code> / <code>swappable</code></li>
</ul></li>
</ul></li>

<li><p><code>Model</code>的属性和方法</p>

<ul>
<li><p><code>objects</code> / <code>pk</code></p></li>

<li><p><code>save()</code> / <code>delete()</code></p></li>

<li><p><code>clean()</code> / <code>validate_unique()</code> / <code>full_clean()</code></p></li>
</ul></li>

<li><p><code>QuerySet</code>的方法</p>

<ul>
<li><code>get()</code> / <code>all()</code> / <code>values()</code></li>
</ul>

<blockquote>
<p>说明：<code>values()</code>返回的<code>QuerySet</code>中不是模型对象而是字典</p>
</blockquote>

<ul>
<li><p><code>count()</code> / <code>order_by()</code> / <code>exists()</code> / <code>reverse()</code></p></li>

<li><p><code>filter()</code> / <code>exclude()</code></p>

<ul>
<li><p><code>exact</code> / <code>iexact</code>：精确匹配/忽略大小写的精确匹配查询</p></li>

<li><p><code>contains</code> / <code>icontains</code> / <code>startswith / istartswith / endswith / iendswith</code>：基于<code>like</code>的模糊查询</p></li>

<li><p><code>in</code>：集合运算</p></li>

<li><p><code>gt</code> / <code>gte</code> / <code>lt</code> / <code>lte</code>：大于/大于等于/小于/小于等于关系运算</p></li>

<li><p><code>range</code>：指定范围查询（SQL中的<code>between…and…</code>）</p></li>

<li><p><code>year</code> / <code>month</code> / <code>day</code> / <code>week_day</code> / <code>hour</code> / <code>minute</code> / <code>second</code>：查询时间日期</p></li>

<li><p><code>isnull</code>：查询空值（<code>True</code>）或非空值（<code>False</code>）</p></li>

<li><p><code>search</code>：基于全文索引的全文检索</p></li>

<li><p><code>regex</code> / <code>iregex</code>：基于正则表达式的模糊匹配查询</p></li>

<li><p><code>aggregate()</code> / <code>annotate()</code></p></li>

<li><p><code>Avg</code> / <code>Count</code> / <code>Sum</code> / <code>Max</code> / <code>Min</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> django.db.models <span style="color:#f92672">import</span> Avg
<span style="color:#f92672">&gt;&gt;&gt;</span> Emp<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>aggregate(avg_sal<span style="color:#f92672">=</span>Avg(<span style="color:#e6db74">&#39;sal&#39;</span>))
(<span style="color:#ae81ff">0.001</span>) SELECT AVG(<span style="color:#e6db74">`TbEmp`</span><span style="color:#f92672">.</span><span style="color:#e6db74">`sal`</span>) AS <span style="color:#e6db74">`avg_sal`</span> FROM <span style="color:#e6db74">`TbEmp`</span>; args<span style="color:#f92672">=</span>()
{<span style="color:#e6db74">&#39;avg_sal&#39;</span>: <span style="color:#ae81ff">3521.4286</span>}</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">&gt;&gt;&gt;</span> Emp<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>values(<span style="color:#e6db74">&#39;dept&#39;</span>)<span style="color:#f92672">.</span>annotate(total<span style="color:#f92672">=</span>Count(<span style="color:#e6db74">&#39;dept&#39;</span>))
(<span style="color:#ae81ff">0.001</span>) SELECT <span style="color:#e6db74">`TbEmp`</span><span style="color:#f92672">.</span><span style="color:#e6db74">`dno`</span>, COUNT(<span style="color:#e6db74">`TbEmp`</span><span style="color:#f92672">.</span><span style="color:#e6db74">`dno`</span>) AS <span style="color:#e6db74">`total`</span> FROM <span style="color:#e6db74">`TbEmp`</span> GROUP BY <span style="color:#e6db74">`TbEmp`</span><span style="color:#f92672">.</span><span style="color:#e6db74">`dno`</span> ORDER BY NULL LIMIT <span style="color:#ae81ff">21</span>; args<span style="color:#f92672">=</span>()
<span style="color:#f92672">&lt;</span>QuerySet [{<span style="color:#e6db74">&#39;dept&#39;</span>: <span style="color:#ae81ff">10</span>, <span style="color:#e6db74">&#39;total&#39;</span>: <span style="color:#ae81ff">4</span>}, {<span style="color:#e6db74">&#39;dept&#39;</span>: <span style="color:#ae81ff">20</span>, <span style="color:#e6db74">&#39;total&#39;</span>: <span style="color:#ae81ff">7</span>}, {<span style="color:#e6db74">&#39;dept&#39;</span>: <span style="color:#ae81ff">30</span>, <span style="color:#e6db74">&#39;total&#39;</span>: <span style="color:#ae81ff">3</span>}]</code></pre></div></li>
</ul></li>

<li><p><code>first()</code> / <code>last()</code></p></li>
</ul>

<blockquote>
<p>说明：调用<code>first()</code>方法相当于用<code>[0]</code>对<code>QuerySet</code>进行切片。</p>
</blockquote>

<ul>
<li><p><code>only()</code> / <code>defer()</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">&gt;&gt;&gt;</span> Emp<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(pk<span style="color:#f92672">=</span><span style="color:#ae81ff">7800</span>)<span style="color:#f92672">.</span>only(<span style="color:#e6db74">&#39;name&#39;</span>, <span style="color:#e6db74">&#39;sal&#39;</span>)
(<span style="color:#ae81ff">0.001</span>) SELECT <span style="color:#e6db74">`TbEmp`</span><span style="color:#f92672">.</span><span style="color:#e6db74">`empno`</span>, <span style="color:#e6db74">`TbEmp`</span><span style="color:#f92672">.</span><span style="color:#e6db74">`ename`</span>, <span style="color:#e6db74">`TbEmp`</span><span style="color:#f92672">.</span><span style="color:#e6db74">`sal`</span> FROM <span style="color:#e6db74">`TbEmp`</span> WHERE <span style="color:#e6db74">`TbEmp`</span><span style="color:#f92672">.</span><span style="color:#e6db74">`empno`</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">7800</span> LIMIT <span style="color:#ae81ff">21</span>; args<span style="color:#f92672">=</span>(<span style="color:#ae81ff">7800</span>,)
<span style="color:#f92672">&lt;</span>QuerySet [<span style="color:#f92672">&lt;</span>Emp: Emp object (<span style="color:#ae81ff">7800</span>)<span style="color:#f92672">&gt;</span>]<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> Emp<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(pk<span style="color:#f92672">=</span><span style="color:#ae81ff">7800</span>)<span style="color:#f92672">.</span>defer(<span style="color:#e6db74">&#39;name&#39;</span>, <span style="color:#e6db74">&#39;sal&#39;</span>)
(<span style="color:#ae81ff">0.001</span>) SELECT <span style="color:#e6db74">`TbEmp`</span><span style="color:#f92672">.</span><span style="color:#e6db74">`empno`</span>, <span style="color:#e6db74">`TbEmp`</span><span style="color:#f92672">.</span><span style="color:#e6db74">`job`</span>, <span style="color:#e6db74">`TbEmp`</span><span style="color:#f92672">.</span><span style="color:#e6db74">`mgr`</span>, <span style="color:#e6db74">`TbEmp`</span><span style="color:#f92672">.</span><span style="color:#e6db74">`comm`</span>, <span style="color:#e6db74">`TbEmp`</span><span style="color:#f92672">.</span><span style="color:#e6db74">`dno`</span> FROM <span style="color:#e6db74">`TbEmp`</span> WHERE <span style="color:#e6db74">`TbEmp`</span><span style="color:#f92672">.</span><span style="color:#e6db74">`empno`</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">7800</span> LIMIT <span style="color:#ae81ff">21</span>; args<span style="color:#f92672">=</span>(<span style="color:#ae81ff">7800</span>,)
<span style="color:#f92672">&lt;</span>QuerySet [<span style="color:#f92672">&lt;</span>Emp: Emp object (<span style="color:#ae81ff">7800</span>)<span style="color:#f92672">&gt;</span>]<span style="color:#f92672">&gt;</span></code></pre></div></li>

<li><p><code>create()</code> / <code>update()</code> / <code>raw()</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">&gt;&gt;&gt;</span> Emp<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(dept__no<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>)<span style="color:#f92672">.</span>update(sal<span style="color:#f92672">=</span>F(<span style="color:#e6db74">&#39;sal&#39;</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">100</span>)
(<span style="color:#ae81ff">0.011</span>) UPDATE <span style="color:#e6db74">`TbEmp`</span> SET <span style="color:#e6db74">`sal`</span> <span style="color:#f92672">=</span> (<span style="color:#e6db74">`TbEmp`</span><span style="color:#f92672">.</span><span style="color:#e6db74">`sal`</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">100</span>) WHERE <span style="color:#e6db74">`TbEmp`</span><span style="color:#f92672">.</span><span style="color:#e6db74">`dno`</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>; args<span style="color:#f92672">=</span>(<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">20</span>)
<span style="color:#f92672">&gt;&gt;&gt;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> Emp<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>raw(<span style="color:#e6db74">&#39;select empno, ename, job from TbEmp where dno=10&#39;</span>)
<span style="color:#f92672">&lt;</span>RawQuerySet: select empno, ename, job <span style="color:#f92672">from</span> TbEmp where dno<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span><span style="color:#f92672">&gt;</span></code></pre></div></li>
</ul></li>

<li><p><code>Q</code>对象和<code>F</code>对象</p></li>
</ol>

<blockquote>
<p>说明：Q对象主要用来解决多条件组合的复杂查询；F对象主要用于更新数据。</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">   <span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> django.db.models <span style="color:#f92672">import</span> Q
   <span style="color:#f92672">&gt;&gt;&gt;</span> Emp<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(
   <span style="color:#f92672">...</span>     Q(name__startswith<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;张&#39;</span>),
   <span style="color:#f92672">...</span>     Q(sal__lte<span style="color:#f92672">=</span><span style="color:#ae81ff">5000</span>) <span style="color:#f92672">|</span> Q(comm__gte<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span>)
   <span style="color:#f92672">...</span> ) <span style="color:#75715e"># 查询名字以“张”开头且工资小于等于5000或补贴大于等于1000的员工</span>
   <span style="color:#f92672">&lt;</span>QuerySet [<span style="color:#f92672">&lt;</span>Emp: <span style="color:#960050;background-color:#1e0010">张三丰</span><span style="color:#f92672">&gt;</span>]<span style="color:#f92672">&gt;</span></code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">   <span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> backend.models <span style="color:#f92672">import</span> Emp, Dept
   <span style="color:#f92672">&gt;&gt;&gt;</span> emps <span style="color:#f92672">=</span> Emp<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(dept__no<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>)
   <span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> django.db.models <span style="color:#f92672">import</span> F
   <span style="color:#f92672">&gt;&gt;&gt;</span> emps<span style="color:#f92672">.</span>update(sal<span style="color:#f92672">=</span>F(<span style="color:#e6db74">&#39;sal&#39;</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">100</span>)</code></pre></div>
<ol>
<li><p>原生SQL查询</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">from</span> django.db <span style="color:#f92672">import</span> connections


<span style="color:#66d9ef">with</span> connections[<span style="color:#e6db74">&#39;...&#39;</span>]<span style="color:#f92672">.</span>cursor() <span style="color:#66d9ef">as</span> cursor:
   cursor<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;UPDATE TbEmp SET sal=sal+10 WHERE dno=30&#34;</span>)
   cursor<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;SELECT ename, job FROM TbEmp WHERE dno=10&#34;</span>)
   row <span style="color:#f92672">=</span> cursor<span style="color:#f92672">.</span>fetchall()</code></pre></div></li>

<li><p>模型管理器</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BookManager</span>(models<span style="color:#f92672">.</span>Manager):

   <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">title_count</span>(self, keyword):
       <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>filter(title__icontains<span style="color:#f92672">=</span>keyword)<span style="color:#f92672">.</span>count()

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Book</span>(models<span style="color:#f92672">.</span>Model):

   objects <span style="color:#f92672">=</span> BookManager()</code></pre></div></li>
</ol>

<h2 id="视图函数-controller">视图函数(Controller)</h2>

<h3 id="如何设计视图函数">如何设计视图函数</h3>

<ol>
<li><p>用户的每个操作（用户故事）对应一个视图函数。</p></li>

<li><p><a href="https://docs.djangoproject.com/en/2.1/ref/settings/">每个视图函数可以构成一个事务边界</a>。</p>

<ul>
<li><p>事务的ACID特性。</p>

<ul>
<li>原子性（Atomicity）：事务中各项的操作要么全做要么全不做；</li>
<li>一致性（Consistentcy）：事务前后系统的状态是一致的；</li>
<li>隔离性（Isolation）：并发执行的事务无法看到彼此的中间状态；</li>
<li>持久性（Duration）：事务完成后所做的改动都会被持久化。</li>
</ul></li>

<li><p>事务隔离级别 - 设置事务隔离级别是为了数据库底层依据事务隔离级别为数据加上适当的锁。如果需要保证数据的强一致性，那么关系型数据库仍然是唯一的也是最好的选择，因为关系型数据库可以通过锁机制来保护数据。事务隔离级别从低到高依次是：Read Uncommitted（读未提交）、Read Committed（读提交）、Repeatable Read（可重复读）、Serializable（串行化）。事务隔离级别越高，数据并发访问的问题越少，但是性能越差；事务隔离级别越低，数据并发访问的问题越多，但是性能越好。</p></li>

<li><p>数据并发访问会产生5种问题（请参考我的<a href="https://blog.csdn.net/jackfrued/article/details/44921941">《Java面试题全集（上）》</a>第80题对该问题的讲解）：</p>

<ul>
<li>第1类丢失更新（A事务撤销覆盖B事务更新的数据）和第2类丢失更新（A事务提交覆盖B事务更新的数据）。</li>
<li>脏读（读脏数据）：一个事务读取到其他尚未提交的事务的数据。</li>
<li>不可重复读： 一个事务在读取它的查询结果时，被另一个事务更新了它的查询记录导致无法读到数据。</li>

<li><p>幻读：一个事务在读取它的查询结果时，发现读到了被另一个事务提交的新数据。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-SQL" data-lang="SQL"><span style="color:#75715e">-- 设置全局默认的事务隔离级别
</span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> transaction <span style="color:#66d9ef">isolation</span> <span style="color:#66d9ef">level</span> <span style="color:#66d9ef">repeatable</span> <span style="color:#66d9ef">read</span>;
<span style="color:#75715e">-- 设置当前会话的事务隔离级别
</span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> <span style="color:#66d9ef">session</span> transaction <span style="color:#66d9ef">isolation</span> <span style="color:#66d9ef">level</span> <span style="color:#66d9ef">read</span> <span style="color:#66d9ef">committed</span>;
<span style="color:#75715e">-- 查询当前会话的事务隔离级别
</span><span style="color:#75715e"></span><span style="color:#66d9ef">select</span> <span style="color:#f92672">@@</span>tx_isolation;</code></pre></div></li>
</ul></li>

<li><p>Django中的事务控制。</p>

<ul>
<li><p>给每个请求绑定事务环境（反模式）。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">ATOMIC_REQUESTS <span style="color:#f92672">=</span> True</code></pre></div></li>

<li><p>使用事务装饰器（简单易用） - 粗粒度（控制不够精细）。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#a6e22e">@transaction.non_atomic_requests</span>
<span style="color:#a6e22e">@transaction.atomic</span></code></pre></div></li>

<li><p>使用上下文语法（细粒度 - 事务控制的范围更加精准）。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">with</span> transaction<span style="color:#f92672">.</span>atomic():
<span style="color:#66d9ef">pass</span></code></pre></div></li>

<li><p>关闭自动提交使用手动提交。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">AUTOCOMMIT <span style="color:#f92672">=</span> False</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">transaction<span style="color:#f92672">.</span>commit()
transaction<span style="color:#f92672">.</span>rollback()</code></pre></div></li>
</ul></li>
</ul></li>
</ol>

<h3 id="url配置">URL配置</h3>

<ol>
<li><p>可以让部分URL只在调试模式下生效。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">from</span> django.conf <span style="color:#f92672">import</span> settings

urlpatterns <span style="color:#f92672">=</span> [
   <span style="color:#f92672">...</span>
]

<span style="color:#66d9ef">if</span> settings<span style="color:#f92672">.</span>DEBUG:
   urlpatterns <span style="color:#f92672">+=</span> [ <span style="color:#f92672">...</span> ]</code></pre></div></li>

<li><p>可以使用命名捕获组捕获路径参数。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">url(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;api/code/(?P&lt;mobile&gt;1[3-9]\d{9})&#39;</span>),
path(<span style="color:#e6db74">&#39;api/code/&lt;str:mobile&gt;&#39;</span>),</code></pre></div></li>

<li><p>URL配置不关心请求使用的方法（一个视图函数可以处理不同的请求方式）。</p></li>

<li><p>如果使用<code>url</code>函数捕获的路径参数都是字符串，<code>path</code>函数可以指定路径参数类型。</p></li>

<li><p>可以使用<code>include</code>函数引入其他URL配置，捕获的参数会向下传递。</p></li>

<li><p>在<code>url</code>和<code>path</code>函数甚至是<code>include</code>函数中都可以用字典向视图传入额外的参数，如果参数与捕获的参数同名，则使用字典中的参数。</p></li>

<li><p>可以用<code>reverse</code>函数实现URL的逆向解析（从名字解析出URL），在模板中也可以用<code>{% url %}</code>实现同样的操作。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">path(<span style="color:#e6db74">&#39;&#39;</span>, views<span style="color:#f92672">.</span>index, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;index&#39;</span>)

<span style="color:#66d9ef">return</span> redirect(reverse(<span style="color:#e6db74">&#39;index&#39;</span>))
<span style="color:#66d9ef">return</span> redirect(<span style="color:#e6db74">&#39;index&#39;</span>)</code></pre></div></li>
</ol>

<h2 id="模板-view">模板(View)</h2>

<h3 id="后端渲染">后端渲染</h3>

<ol>
<li><p>模板的配置和渲染函数。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">TEMPLATES <span style="color:#f92672">=</span> [
   {
       <span style="color:#e6db74">&#39;BACKEND&#39;</span>: <span style="color:#e6db74">&#39;django.template.backends.django.DjangoTemplates&#39;</span>,
       <span style="color:#e6db74">&#39;DIRS&#39;</span>: [os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(BASE_DIR, <span style="color:#e6db74">&#39;templates&#39;</span>), ],
       <span style="color:#e6db74">&#39;APP_DIRS&#39;</span>: True,
       <span style="color:#e6db74">&#39;OPTIONS&#39;</span>: {
           <span style="color:#e6db74">&#39;context_processors&#39;</span>: [
               <span style="color:#e6db74">&#39;django.template.context_processors.debug&#39;</span>,
               <span style="color:#e6db74">&#39;django.template.context_processors.request&#39;</span>,
               <span style="color:#e6db74">&#39;django.contrib.auth.context_processors.auth&#39;</span>,
               <span style="color:#e6db74">&#39;django.contrib.messages.context_processors.messages&#39;</span>,
           ],
       },
   },
]</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">resp <span style="color:#f92672">=</span> render(request, <span style="color:#e6db74">&#39;index.html&#39;</span>, {<span style="color:#e6db74">&#39;foo&#39;</span>: <span style="color:#f92672">...</span>})</code></pre></div></li>

<li><p>模板遇到变量名的查找顺序。</p>

<ul>
<li>字典查找（如：<code>foo['bar']</code>）</li>
<li>属性查找（如：<code>foo.bar</code>）</li>
<li>方法调用（如：<code>foo.bar()</code>）

<ul>
<li>方法不能有必须传值的参数</li>
<li>在模板中不能够给方法传参</li>
<li>如果方法的<code>alters_data</code>被设置为<code>True</code>则不能调用该方法（避免误操作的风险），模型对象动态生成的<code>delete()</code>和<code>save()</code>方法都设定了<code>alters_data = True</code>。</li>
</ul></li>
<li>列表索引查找（如：<code>foo[0]</code>）</li>
</ul></li>

<li><p>模板标签的使用。</p>

<ul>
<li><code>{% if %}</code> / <code>{% else %}</code> / <code>{% endif %}</code></li>
<li><code>{% for %}</code> / <code>{% endfor %}</code></li>
<li><code>{% ifequal %}</code> / <code>{% endifequal %}</code> / <code>{% ifnotequal %}</code> / <code>{% endifnotequal %}</code></li>
<li><code>{# comment #}</code> / <code>{% comment %}</code> / <code>{% endcomment %}</code></li>
</ul></li>

<li><p>过滤器的使用。</p>

<ul>
<li><code>lower</code> / <code>upper</code> / <code>first</code> / <code>last</code> / <code>truncatewords</code> / <code>date</code>/ <code>time</code> / <code>length</code> / <code>pluralize</code> / <code>center</code> / <code>ljust</code> / <code>rjust</code> / <code>cut</code> / <code>urlencode</code> / <code>default_if_none</code> / <code>filesizeformat</code> / <code>join</code> / <code>slice</code> / <code>slugify</code></li>
</ul></li>

<li><p>模板的包含和继承。</p>

<ul>
<li><code>{% include %}</code> / <code>{% block %}</code></li>
<li><code>{% extends %}</code></li>
</ul></li>

<li><p>模板加载器（后面优化部分会讲到）。</p>

<ul>
<li><p>文件系统加载器</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">TEMPLATES <span style="color:#f92672">=</span> [{
 <span style="color:#e6db74">&#39;BACKEND&#39;</span>: <span style="color:#e6db74">&#39;django.template.backends.django.DjangoTemplates&#39;</span>,
 <span style="color:#e6db74">&#39;DIRS&#39;</span>: [os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(BASE_DIR, <span style="color:#e6db74">&#39;templates&#39;</span>)],
}]</code></pre></div></li>

<li><p>应用目录加载器</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">TEMPLATES <span style="color:#f92672">=</span> [{
 <span style="color:#e6db74">&#39;BACKEND&#39;</span>: <span style="color:#e6db74">&#39;django.template.backends.django.DjangoTemplates&#39;</span>,
 <span style="color:#e6db74">&#39;APP_DIRS&#39;</span>: True,
}]</code></pre></div></li>
</ul></li>
</ol>

<h3 id="前端渲染">前端渲染</h3>

<ol>
<li>前端模板引擎：Handlebars / Mustache。</li>
<li>前端MV*框架。

<ul>
<li>MVC - AngularJS</li>
<li>MVVM(Model-View-ViewModel) - Vue.js</li>
</ul></li>
</ol>

<h3 id="其他视图">其他视图</h3>

<ol>
<li>MIME（多用途Internet邮件扩展）类型 - 告知浏览器传输的数据类型。</li>
</ol>

<p>| Content-Type     | 说明                                                         |
   | &mdash;&mdash;&mdash;&mdash;&mdash;- | &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash; |
   | application/json | <a href="https://zh.wikipedia.org/wiki/JSON">JSON</a>（JavaScript Object Notation） |
   | application/pdf  | <a href="https://zh.wikipedia.org/wiki/PDF">PDF</a>（Portable Document Format） |
   | audio/mpeg       | <a href="https://zh.wikipedia.org/wiki/MP3">MP3</a>或其他<a href="https://zh.wikipedia.org/wiki/MPEG">MPEG</a>音频文件 |
   | audio/vnd.wave   | <a href="https://zh.wikipedia.org/wiki/WAV">WAV</a>音频文件             |
   | image/gif        | <a href="https://zh.wikipedia.org/wiki/GIF">GIF</a>图像文件             |
   | image/jpeg       | <a href="https://zh.wikipedia.org/wiki/JPEG">JPEG</a>图像文件           |
   | image/png        | <a href="https://zh.wikipedia.org/wiki/PNG">PNG</a>图像文件             |
   | text/html        | <a href="https://zh.wikipedia.org/wiki/HTML">HTML</a>文件               |
   | text/xml         | <a href="https://zh.wikipedia.org/wiki/XML">XML</a>                     |
   | video/mp4        | <a href="https://zh.wikipedia.org/wiki/MP4">MP4</a>视频文件             |
   | video/quicktime  | <a href="https://zh.wikipedia.org/wiki/QuickTime">QuickTime</a>视频文件 |</p>

<ol>
<li><p>如何处置生成的内容（inline / attachment）。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> urllib.parse <span style="color:#f92672">import</span> quote
<span style="color:#f92672">&gt;&gt;&gt;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> response[<span style="color:#e6db74">&#39;content-type&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;application/pdf&#39;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> filename <span style="color:#f92672">=</span> quote(<span style="color:#e6db74">&#39;Python语言规范.pdf&#39;</span>)
<span style="color:#f92672">&gt;&gt;&gt;</span> filename
<span style="color:#e6db74">&#39;Python</span><span style="color:#e6db74">%E</span><span style="color:#e6db74">8%AF%AD</span><span style="color:#e6db74">%E</span><span style="color:#e6db74">8%A8</span><span style="color:#e6db74">%80%</span><span style="color:#e6db74">E8%A7</span><span style="color:#e6db74">%84%</span><span style="color:#e6db74">E8%8C%83.pdf&#39;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> response[<span style="color:#e6db74">&#39;content-disposition&#39;</span>] <span style="color:#f92672">=</span> f<span style="color:#e6db74">&#39;attachment; filename=&#34;{filename}&#34;&#39;</span></code></pre></div></li>
</ol>

<blockquote>
<p>提醒：URL以及请求和响应头中的中文都应该处理成<a href="https://zh.wikipedia.org/zh-hans/%E7%99%BE%E5%88%86%E5%8F%B7%E7%BC%96%E7%A0%81">百分号编码</a>。</p>
</blockquote>

<ol>
<li><p>生成CSV / Excel / PDF / 统计报表。</p>

<ul>
<li><p>向浏览器传输二进制数据。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">buffer <span style="color:#f92672">=</span> ByteIO()

resp <span style="color:#f92672">=</span> HttpResponse(content_type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;...&#39;</span>)
resp[<span style="color:#e6db74">&#39;Content-Disposition&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;attachment; filename=&#34;...&#34;&#39;</span>
resp<span style="color:#f92672">.</span>write(buffer<span style="color:#f92672">.</span>getvalue())</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_style</span>(name, color<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, bold<span style="color:#f92672">=</span>False, italic<span style="color:#f92672">=</span>False):
 style <span style="color:#f92672">=</span> xlwt<span style="color:#f92672">.</span>XFStyle()
 font <span style="color:#f92672">=</span> xlwt<span style="color:#f92672">.</span>Font()
 font<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name
 font<span style="color:#f92672">.</span>colour_index <span style="color:#f92672">=</span> color
 font<span style="color:#f92672">.</span>bold <span style="color:#f92672">=</span> bold
 font<span style="color:#f92672">.</span>italic <span style="color:#f92672">=</span> italic
 style<span style="color:#f92672">.</span>font <span style="color:#f92672">=</span> font
 <span style="color:#66d9ef">return</span> style


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">export_emp_excel</span>(request):
 <span style="color:#75715e"># 创建Excel工作簿(使用三方库xlwt)</span>
 workbook <span style="color:#f92672">=</span> xlwt<span style="color:#f92672">.</span>Workbook()
 <span style="color:#75715e"># 向工作簿中添加工作表</span>
 sheet <span style="color:#f92672">=</span> workbook<span style="color:#f92672">.</span>add_sheet(<span style="color:#e6db74">&#39;员工详细信息&#39;</span>)
 <span style="color:#75715e"># 设置表头</span>
 titles <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;编号&#39;</span>, <span style="color:#e6db74">&#39;姓名&#39;</span>, <span style="color:#e6db74">&#39;主管&#39;</span>, <span style="color:#e6db74">&#39;职位&#39;</span>, <span style="color:#e6db74">&#39;工资&#39;</span>, <span style="color:#e6db74">&#39;部门名称&#39;</span>]
 <span style="color:#66d9ef">for</span> col, title <span style="color:#f92672">in</span> enumerate(titles):
     sheet<span style="color:#f92672">.</span>write(<span style="color:#ae81ff">0</span>, col, title, get_style(<span style="color:#e6db74">&#39;HanziPenSC-W3&#39;</span>, <span style="color:#ae81ff">2</span>, True))
 <span style="color:#75715e"># 使用Django的ORM框架查询员工数据</span>
 emps <span style="color:#f92672">=</span> Emp<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>all()<span style="color:#f92672">.</span>select_related(<span style="color:#e6db74">&#39;dept&#39;</span>)<span style="color:#f92672">.</span>select_related(<span style="color:#e6db74">&#39;mgr&#39;</span>)
 cols <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;no&#39;</span>, <span style="color:#e6db74">&#39;name&#39;</span>, <span style="color:#e6db74">&#39;mgr&#39;</span>, <span style="color:#e6db74">&#39;job&#39;</span>, <span style="color:#e6db74">&#39;sal&#39;</span>, <span style="color:#e6db74">&#39;dept&#39;</span>]
 <span style="color:#75715e"># 通过嵌套的循环将员工表的数据写入Excel工作表的单元格</span>
 <span style="color:#66d9ef">for</span> row, emp <span style="color:#f92672">in</span> enumerate(emps):
     <span style="color:#66d9ef">for</span> col, prop <span style="color:#f92672">in</span> enumerate(cols):
         val <span style="color:#f92672">=</span> getattr(emp, prop, <span style="color:#e6db74">&#39;&#39;</span>)
         <span style="color:#66d9ef">if</span> isinstance(val, (Dept, Emp)):
             val <span style="color:#f92672">=</span> val<span style="color:#f92672">.</span>name
         sheet<span style="color:#f92672">.</span>write(row <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, col, val)
 <span style="color:#75715e"># 将Excel文件的二进制数据写入内存</span>
 buffer <span style="color:#f92672">=</span> BytesIO()
 workbook<span style="color:#f92672">.</span>save(buffer)
 <span style="color:#75715e"># 通过HttpResponse对象向浏览器输出Excel文件</span>
 resp <span style="color:#f92672">=</span> HttpResponse(buffer<span style="color:#f92672">.</span>getvalue())
 resp[<span style="color:#e6db74">&#39;content-type&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;application/msexcel&#39;</span>
 <span style="color:#75715e"># 如果文件名有中文需要处理成百分号编码</span>
 resp[<span style="color:#e6db74">&#39;content-disposition&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;attachment; filename=&#34;detail.xls&#34;&#39;</span>
 <span style="color:#66d9ef">return</span> resp</code></pre></div></li>

<li><p>大文件的流式处理：<code>StreamingHttpResponse</code>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">download_file</span>(request):
 file_stream <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#39;...&#39;</span>, <span style="color:#e6db74">&#39;rb&#39;</span>)
 <span style="color:#75715e"># 如果文件的二进制数据较大则最好用迭代器进行处理避免过多的占用服务器内存</span>
 file_iter <span style="color:#f92672">=</span> iter(<span style="color:#66d9ef">lambda</span>: file_stream<span style="color:#f92672">.</span>read(<span style="color:#ae81ff">4096</span>), <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>)
 resp <span style="color:#f92672">=</span> StreamingHttpResponse(file_iter)
 <span style="color:#75715e"># 中文文件名要处理成百分号编码</span>
 filename <span style="color:#f92672">=</span> quote(<span style="color:#e6db74">&#39;...&#39;</span>, <span style="color:#e6db74">&#39;utf-8&#39;</span>)
 resp[<span style="color:#e6db74">&#39;Content-Type&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;...&#39;</span>
 resp[<span style="color:#e6db74">&#39;Content-Disposition&#39;</span>] <span style="color:#f92672">=</span> f<span style="color:#e6db74">&#39;attachment; filename=&#34;{filename}&#34;&#39;</span>
 <span style="color:#66d9ef">return</span> resp</code></pre></div></li>
</ul>

<blockquote>
<p>说明：如果需要生成PDF文件，可以需要安装<code>reportlab</code>。另外，使用StreamingHttpResponse只能减少内存的开销，但是如果下载一个大文件会导致一个请求长时间占用服务器资源，比较好的做法还是把报表提前生成好（可以考虑使用定时任务），放在静态资源服务器或者是云存储服务器上以访问静态资源的方式访问。</p>
</blockquote>

<ul>
<li><p><a href="http://echarts.baidu.com/">ECharts</a>或<a href="https://www.chartjs.org/">Chart.js</a>。</p>

<ul>
<li><p>思路：后端只提供JSON格式的数据，前端JavaScript渲染生成图表。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_charts_data</span>(request):
<span style="color:#e6db74">&#34;&#34;&#34;获取统计图表JSON数据&#34;&#34;&#34;</span>
names <span style="color:#f92672">=</span> []
totals <span style="color:#f92672">=</span> []
<span style="color:#75715e"># 通过connections获取指定数据库连接并创建游标对象</span>
<span style="color:#66d9ef">with</span> connections[<span style="color:#e6db74">&#39;backend&#39;</span>]<span style="color:#f92672">.</span>cursor() <span style="color:#66d9ef">as</span> cursor:
 <span style="color:#75715e"># 在使用ORM框架时可以使用对象管理器的aggregate()和annotate()方法实现分组和聚合函数查询</span>
 <span style="color:#75715e"># 执行原生SQL查询(如果ORM框架不能满足业务或性能需求)</span>
 cursor<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#39;select dname, total from vw_dept_emp&#39;</span>)
 <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> cursor<span style="color:#f92672">.</span>fetchall():
     names<span style="color:#f92672">.</span>append(row[<span style="color:#ae81ff">0</span>])
     totals<span style="color:#f92672">.</span>append(row[<span style="color:#ae81ff">1</span>])
<span style="color:#66d9ef">return</span> JsonResponse({<span style="color:#e6db74">&#39;names&#39;</span>: names, <span style="color:#e6db74">&#39;totals&#39;</span>: totals})</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-HTML" data-lang="HTML"><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
&lt;<span style="color:#f92672">html</span> <span style="color:#a6e22e">lang</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;en&#34;</span>&gt;
&lt;<span style="color:#f92672">head</span>&gt;
&lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">charset</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;UTF-8&#34;</span>&gt;
&lt;<span style="color:#f92672">title</span>&gt;统计图表&lt;/<span style="color:#f92672">title</span>&gt;
&lt;<span style="color:#f92672">style</span>&gt;
 #main {
     <span style="color:#66d9ef">width</span>: <span style="color:#ae81ff">600</span><span style="color:#66d9ef">px</span>;
     <span style="color:#66d9ef">height</span>: <span style="color:#ae81ff">400</span><span style="color:#66d9ef">px</span>;
 }
&lt;/<span style="color:#f92672">style</span>&gt;
&lt;/<span style="color:#f92672">head</span>&gt;
&lt;<span style="color:#f92672">body</span>&gt;
&lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;main&#34;</span>&gt;&lt;/<span style="color:#f92672">div</span>&gt;
&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://cdn.bootcss.com/echarts/4.2.0-rc.2/echarts.min.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
&lt;<span style="color:#f92672">script</span>&gt;
 <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">myChart</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">echarts</span>.<span style="color:#a6e22e">init</span>(<span style="color:#a6e22e">$</span>(<span style="color:#e6db74">&#39;#main&#39;</span>)[<span style="color:#ae81ff">0</span>]);
 <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">ajax</span>({
     <span style="color:#e6db74">&#39;url&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;charts_data&#39;</span>,
     <span style="color:#e6db74">&#39;type&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;get&#39;</span>,
     <span style="color:#e6db74">&#39;data&#39;</span><span style="color:#f92672">:</span> {},
     <span style="color:#e6db74">&#39;dataType&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;json&#39;</span>,
     <span style="color:#e6db74">&#39;success&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">json</span>) {
         <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">option</span> <span style="color:#f92672">=</span> {
             <span style="color:#a6e22e">title</span><span style="color:#f92672">:</span> {
                 <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;员工分布统计图&#39;</span>
             },
             <span style="color:#a6e22e">tooltip</span><span style="color:#f92672">:</span> {},
             <span style="color:#a6e22e">legend</span><span style="color:#f92672">:</span> {
                 <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span>[<span style="color:#e6db74">&#39;人数&#39;</span>]
             },
             <span style="color:#a6e22e">xAxis</span><span style="color:#f92672">:</span> {
                 <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">names</span>
             },
             <span style="color:#a6e22e">yAxis</span><span style="color:#f92672">:</span> {},
             <span style="color:#a6e22e">series</span><span style="color:#f92672">:</span> [{
                 <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;人数&#39;</span>,
                 <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;bar&#39;</span>,
                 <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">totals</span>
             }]
         };
         <span style="color:#a6e22e">myChart</span>.<span style="color:#a6e22e">setOption</span>(<span style="color:#a6e22e">option</span>);
     },
     <span style="color:#e6db74">&#39;error&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>() {}
 });
&lt;/<span style="color:#f92672">script</span>&gt;
&lt;/<span style="color:#f92672">body</span>&gt;
&lt;/<span style="color:#f92672">html</span>&gt;</code></pre></div></li>
</ul></li>
</ul></li>
</ol>

<h2 id="中间件">中间件</h2>

<p>问题1：中间件背后的设计理念是什么？（分离横切关注功能/拦截过滤器模式）</p>

<p>问题2：中间件有哪些不同的实现方式？（参考下面的代码）</p>

<p>问题3：描述Django内置的中间件及其执行顺序。（推荐阅读：<a href="https://docs.djangoproject.com/zh-hans/2.0/ref/middleware/#middleware-ordering">Django官方文档 - 中间件 - 中间件顺序</a>）</p>

<h3 id="激活中间件">激活中间件</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">MIDDLEWARE <span style="color:#f92672">=</span> [
    <span style="color:#e6db74">&#39;django.middleware.security.SecurityMiddleware&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span>,
    <span style="color:#e6db74">&#39;django.middleware.common.CommonMiddleware&#39;</span>,
    <span style="color:#e6db74">&#39;django.middleware.csrf.CsrfViewMiddleware&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.messages.middleware.MessageMiddleware&#39;</span>,
    <span style="color:#e6db74">&#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;</span>,
    <span style="color:#e6db74">&#39;common.middlewares.block_sms_middleware&#39;</span>,
]</code></pre></div>
<h3 id="自定义中间件">自定义中间件</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">simple_middleware</span>(get_response):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">middleware</span>(request, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):

		response <span style="color:#f92672">=</span> get_response(request, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)

		<span style="color:#66d9ef">return</span> response

    <span style="color:#66d9ef">return</span> middleware</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyMiddleware</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, get_response):
        self<span style="color:#f92672">.</span>get_response <span style="color:#f92672">=</span> get_response

    <span style="color:#66d9ef">def</span> __call__(self, request):

        response <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_response(request)

        <span style="color:#66d9ef">return</span> response</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyMiddleware</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_request</span>(request):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_view</span>(request, view_func, view_args, view_kwargs):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_template_response</span>(request, response):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_response</span>(request, response):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_exception</span>(request, exception):
        <span style="color:#66d9ef">pass</span></code></pre></div>
<h3 id="内置中间件">内置中间件</h3>

<ol>
<li><p>CommonMiddleware - 基础设置中间件</p>

<ul>
<li>DISALLOWED_USER_AGENTS - 不被允许的用户代理（浏览器）</li>
<li>APPEND_SLASH - 是否追加<code>/</code></li>
<li>USE_ETAG - 浏览器缓存相关</li>
</ul></li>

<li><p>SecurityMiddleware - 安全相关中间件</p>

<ul>
<li>SECURE_HSTS_SECONDS - 强制使用HTTPS的时间</li>
<li>SECURE_HSTS_INCLUDE_SUBDOMAINS - HTTPS是否覆盖子域名</li>
<li>SECURE_CONTENT_TYPE_NOSNIFF - 是否允许浏览器推断内容类型</li>
<li>SECURE_BROWSER_XSS_FILTER - 是否启用跨站脚本攻击过滤器</li>
<li>SECURE_SSL_REDIRECT - 是否重定向到HTTPS连接</li>
<li>SECURE_REDIRECT_EXEMPT - 免除重定向到HTTPS</li>
</ul></li>

<li><p>SessionMiddleware - 会话中间件</p></li>

<li><p>CsrfViewMiddleware - 防范跨站身份伪造中间件</p></li>

<li><p>XFrameOptionsMiddleware - 防范点击劫持攻击中间件</p></li>
</ol>

<p><img src="Day91-100/res/click-jacking.png" alt="" /></p>

<p><img src="Day91-100/res/builtin-middlewares.png" alt="" /></p>

<h2 id="表单">表单</h2>

<ol>
<li>用法：通常不要用来生成页面上的表单控件（耦合度太高不容易定制），主要用来验证数据。</li>
<li>Form的属性和方法：

<ul>
<li><code>is_valid()</code> / <code>is_multipart()</code></li>
<li><code>errors</code> / <code>fields</code> / <code>is_bound</code> / <code>changed_data</code> / <code>cleaned_data</code></li>
<li><code>add_error()</code> / <code>has_errors()</code> / <code>non_field_errors()</code></li>
<li><code>clean()</code></li>
</ul></li>
<li>Form.errors的方法：

<ul>
<li><code>as_data()</code> / <code>as_json()</code> / <code>get_json_data()</code></li>
</ul></li>
</ol>

<p>问题1：Django中的<code>Form</code>和<code>ModelForm</code>有什么作用？（通常不用来生成表单主要用来验证数据）</p>

<p>问题2：表单上传文件时应该注意哪些问题？（表单的设置、多文件上传、图片预览（FileReader）、Ajax上传文件、上传后的文件如何存储、调用云存储（如<a href="https://www.aliyun.com/product/oss">阿里云OSS</a>、<a href="https://www.qiniu.com/">七牛云</a>、<a href="https://leancloud.cn/storage/">LeanCloud</a>等））</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-HTML" data-lang="HTML">&lt;<span style="color:#f92672">form</span> <span style="color:#a6e22e">action</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#a6e22e">method</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span> <span style="color:#a6e22e">enctype</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;multipart/form-data&#34;</span>&gt;
    &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;file&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;...&#34;</span> <span style="color:#a6e22e">multiple</span>&gt;
    &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;file&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;foo&#34;</span>&gt;
    &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;file&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;foo&#34;</span>&gt;
    &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;file&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;foo&#34;</span>&gt;
&lt;/<span style="color:#f92672">form</span>&gt;</code></pre></div>
<blockquote>
<p>说明：上传图片文件的预览效果可以通过HTML5的FileReader来实现。</p>

<p>说明：使用云存储通常是比自己配置分布式文件系统这种方式更靠谱的做法，而且云存储通常成本并不太高，不仅如此大多数云存储还提供了如图片剪裁、生成水印、视频转码、CDN等服务。如果要自己做上传的视频文件转码，需要安装三方库ffmpeg，在程序中调用该三方库可以实现转码。</p>
</blockquote>

<h2 id="cookie和session">Cookie和Session</h2>

<p>问题1：使用Cookie能解决什么问题？（用户跟踪，解决HTTP协议无状态问题）</p>

<ol>
<li><p>URL重写</p>

<pre><code>http://www.abc.com/path/resource?foo=bar
</code></pre></li>

<li><p>隐藏域（隐式表单域）- 埋点</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-HTML" data-lang="HTML">&lt;<span style="color:#f92672">form</span> <span style="color:#a6e22e">action</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#a6e22e">method</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span>&gt;

   &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hidden&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;foo&#34;</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bar&#34;</span>&gt;

&lt;/<span style="color:#f92672">form</span>&gt;</code></pre></div></li>

<li><p>Cookie - 浏览器中的临时文件（文本文件）- BASE64</p></li>
</ol>

<p>问题2：Cookie和Session之间关系是什么？（Session的标识通过Cookie保存和传输）</p>

<h3 id="session的配置">Session的配置</h3>

<ol>
<li><p>Session对应的中间件：<code>django.contrib.sessions.middleware.SessionMiddleware</code>。</p></li>

<li><p>Session引擎。</p>

<ul>
<li><p>基于数据库（默认方式）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">INSTALLED_APPS <span style="color:#f92672">=</span> [
 <span style="color:#e6db74">&#39;django.contrib.sessions&#39;</span>,
]</code></pre></div></li>

<li><p>基于缓存（推荐使用）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">SESSION_ENGINE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;django.contrib.sessions.backends.cache&#39;</span>
SESSION_CACHE_ALIAS <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;session&#39;</span></code></pre></div></li>

<li><p>基于文件（基本不考虑）</p></li>

<li><p>基于Cookie（不靠谱）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">SESSION_ENGINE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;django.contrib.sessions.backends.signed_cookies&#39;</span></code></pre></div></li>
</ul></li>

<li><p>Cookie相关的配置。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">SESSION_COOKIE_NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;djang_session_id&#39;</span>
SESSION_COOKIE_AGE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1209600</span>
<span style="color:#75715e"># 如果设置为True，Cookie就是基于浏览器窗口的Cookie，不会持久化</span>
SESSION_EXPIRE_AT_BROWSER_CLOSE <span style="color:#f92672">=</span> False
SESSION_SAVE_EVERY_REQUEST <span style="color:#f92672">=</span> False
SESSION_COOKIE_HTTPONLY <span style="color:#f92672">=</span> True</code></pre></div></li>

<li><p>session的属性和方法。</p>

<ul>
<li><code>session_key</code> / <code>session_data</code> / <code>expire_date</code></li>
<li><code>__getitem__</code> / <code>__setitem__</code> / <code>__delitem__</code> / <code>__contains__</code></li>
<li><code>set_expiry()</code> / <code>get_expiry_age()</code> / <code>get_expiry_date()</code> - 设置/获取会话超期时间</li>
<li><code>flush()</code> - 销毁会话</li>
<li><code>set_test_cookie()</code> / <code>test_cookie_worked()</code> / <code>delete_test_cookie()</code> - 测试浏览器是否支持Cookie（提示用户如果浏览器禁用Cookie可能会影响网站的使用）</li>
</ul></li>

<li><p>session的序列化。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">SESSION_SERIALIZER <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;django.contrib.sessions.serializers.JSONSerializer&#39;</span></code></pre></div>
<ul>
<li>JSONSerializer（1.6及以后默认）- 如果想将自定义的对象放到session中，会遇到“Object of type &lsquo;XXX&rsquo; is not JSON serializable”的问题（如果配置使用Redis保存Session，django-redis使用了Pickle序列化，这个问题就不存在了）。</li>
<li>PickleSerializer（1.6以前的默认）- 因为安全问题不推荐使用，但是只要不去反序列化用户构造的恶意的Payload其实也没有什么风险。关于这种方式的安全漏洞，可以参考《<a href="http://www.polaris-lab.com/index.php/archives/178/">Python Pickle的任意代码执行漏洞实践和Payload构造》</a>一文或《软件架构-Python语言实现》上关于这个问题的讲解。</li>
</ul>

<blockquote>
<p>说明：如果使用了django_redis整合Redis作为session的存储引擎，那么由于django_redis又封装了一个PickleSerializer来提供序列化，所以不会存在上述的问题，且Redis中保存的value是pickle序列化之后的结果。</p>
</blockquote></li>
</ol>

<h2 id="缓存">缓存</h2>

<h3 id="配置缓存">配置缓存</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">CACHES <span style="color:#f92672">=</span> {
    <span style="color:#75715e"># 默认缓存</span>
    <span style="color:#e6db74">&#39;default&#39;</span>: {
        <span style="color:#e6db74">&#39;BACKEND&#39;</span>: <span style="color:#e6db74">&#39;django_redis.cache.RedisCache&#39;</span>,
        <span style="color:#e6db74">&#39;LOCATION&#39;</span>: [
            <span style="color:#e6db74">&#39;redis://1.2.3.4:6379/0&#39;</span>,
        ],
        <span style="color:#e6db74">&#39;KEY_PREFIX&#39;</span>: <span style="color:#e6db74">&#39;teamproject&#39;</span>,
        <span style="color:#e6db74">&#39;OPTIONS&#39;</span>: {
            <span style="color:#e6db74">&#39;CLIENT_CLASS&#39;</span>: <span style="color:#e6db74">&#39;django_redis.client.DefaultClient&#39;</span>,
            <span style="color:#e6db74">&#39;CONNECTION_POOL_KWARGS&#39;</span>: {
                <span style="color:#e6db74">&#39;max_connections&#39;</span>: <span style="color:#ae81ff">1000</span>,
            },
            <span style="color:#e6db74">&#39;PASSWORD&#39;</span>: <span style="color:#e6db74">&#39;1qaz2wsx&#39;</span>,
        }
    },
    <span style="color:#75715e"># 页面缓存</span>
    <span style="color:#e6db74">&#39;page&#39;</span>: {
        <span style="color:#e6db74">&#39;BACKEND&#39;</span>: <span style="color:#e6db74">&#39;django_redis.cache.RedisCache&#39;</span>,
        <span style="color:#e6db74">&#39;LOCATION&#39;</span>: [
            <span style="color:#e6db74">&#39;redis://1.2.3.4:6379/1&#39;</span>,
        ],
        <span style="color:#e6db74">&#39;KEY_PREFIX&#39;</span>: <span style="color:#e6db74">&#39;teamproject:page&#39;</span>,
        <span style="color:#e6db74">&#39;OPTIONS&#39;</span>: {
            <span style="color:#e6db74">&#39;CLIENT_CLASS&#39;</span>: <span style="color:#e6db74">&#39;django_redis.client.DefaultClient&#39;</span>,
            <span style="color:#e6db74">&#39;CONNECTION_POOL_KWARGS&#39;</span>: {
                <span style="color:#e6db74">&#39;max_connections&#39;</span>: <span style="color:#ae81ff">500</span>,
            },
            <span style="color:#e6db74">&#39;PASSWORD&#39;</span>: <span style="color:#e6db74">&#39;1qaz2wsx&#39;</span>,
        }
    },
    <span style="color:#75715e"># 会话缓存</span>
    <span style="color:#e6db74">&#39;session&#39;</span>: {
        <span style="color:#e6db74">&#39;BACKEND&#39;</span>: <span style="color:#e6db74">&#39;django_redis.cache.RedisCache&#39;</span>,
        <span style="color:#e6db74">&#39;LOCATION&#39;</span>: [
            <span style="color:#e6db74">&#39;redis://1.2.3.4:6379/2&#39;</span>,
        ],
        <span style="color:#e6db74">&#39;KEY_PREFIX&#39;</span>: <span style="color:#e6db74">&#39;teamproject:session&#39;</span>,
        <span style="color:#e6db74">&#39;TIMEOUT&#39;</span>: <span style="color:#ae81ff">1209600</span>,
        <span style="color:#e6db74">&#39;OPTIONS&#39;</span>: {
            <span style="color:#e6db74">&#39;CLIENT_CLASS&#39;</span>: <span style="color:#e6db74">&#39;django_redis.client.DefaultClient&#39;</span>,
            <span style="color:#e6db74">&#39;CONNECTION_POOL_KWARGS&#39;</span>: {
                <span style="color:#e6db74">&#39;max_connections&#39;</span>: <span style="color:#ae81ff">2000</span>,
            },
            <span style="color:#e6db74">&#39;PASSWORD&#39;</span>: <span style="color:#e6db74">&#39;1qaz2wsx&#39;</span>,
        }
    },
    <span style="color:#75715e"># 接口数据缓存</span>
    <span style="color:#e6db74">&#39;api&#39;</span>: {
        <span style="color:#e6db74">&#39;BACKEND&#39;</span>: <span style="color:#e6db74">&#39;django_redis.cache.RedisCache&#39;</span>,
        <span style="color:#e6db74">&#39;LOCATION&#39;</span>: [
            <span style="color:#e6db74">&#39;redis://1.2.3.4:6379/3&#39;</span>,
        ],
        <span style="color:#e6db74">&#39;KEY_PREFIX&#39;</span>: <span style="color:#e6db74">&#39;teamproject:api&#39;</span>,
        <span style="color:#e6db74">&#39;OPTIONS&#39;</span>: {
            <span style="color:#e6db74">&#39;CLIENT_CLASS&#39;</span>: <span style="color:#e6db74">&#39;django_redis.client.DefaultClient&#39;</span>,
            <span style="color:#e6db74">&#39;CONNECTION_POOL_KWARGS&#39;</span>: {
                <span style="color:#e6db74">&#39;max_connections&#39;</span>: <span style="color:#ae81ff">500</span>,
            },
            <span style="color:#e6db74">&#39;PASSWORD&#39;</span>: <span style="color:#e6db74">&#39;1qaz2wsx&#39;</span>,
        }
    },
}</code></pre></div>
<blockquote>
<p>说明：通过Redis底层提供的多个数据库来隔离缓存数据有助于缓存数据的管理。如果配置了Redis的主从复制（读写分离），LOCATION列表中可以配置多个Redis连接，第一个被视为master用来进行写操作，后面的被视为slave用来进行读操作。</p>
</blockquote>

<h3 id="全站缓存">全站缓存</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">MIDDLEWARE_CLASSES <span style="color:#f92672">=</span> [
    <span style="color:#e6db74">&#39;django.middleware.cache.UpdateCacheMiddleware&#39;</span>,
    <span style="color:#f92672">...</span>
    <span style="color:#e6db74">&#39;django.middleware.common.CommonMiddleware&#39;</span>,
    <span style="color:#f92672">...</span>
    <span style="color:#e6db74">&#39;django.middleware.cache.FetchFromCacheMiddleware&#39;</span>,
]

CACHE_MIDDLEWARE_ALIAS <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;default&#39;</span>
CACHE_MIDDLEWARE_SECONDS <span style="color:#f92672">=</span> <span style="color:#ae81ff">300</span>
CACHE_MIDDLEWARE_KEY_PREFIX <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;djang:cache&#39;</span></code></pre></div>
<h3 id="视图层缓存">视图层缓存</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">from</span> django.views.decorators.cache <span style="color:#f92672">import</span> cache_page
<span style="color:#f92672">from</span> django.views.decorators.vary <span style="color:#f92672">import</span> vary_on_cookie


<span style="color:#a6e22e">@cache_page</span>(timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">15</span>, cache<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;page&#39;</span>)
<span style="color:#a6e22e">@vary_on_cookie</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">my_view</span>(request):
    <span style="color:#66d9ef">pass</span></code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">from</span> django.views.decorators.cache <span style="color:#f92672">import</span> cache_page

urlpatterns <span style="color:#f92672">=</span> [
    url(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;^foo/([0-9]{1,2})/$&#39;</span>, cache_page(<span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">15</span>)(my_view)),
]</code></pre></div>
<h3 id="其他内容">其他内容</h3>

<ol>
<li><p>模板片段缓存。</p>

<ul>
<li><code>{% load cache %}</code></li>
<li><code>{% cache %}</code> / <code>{% endcache %}</code></li>
</ul></li>

<li><p>使用底层API访问缓存。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> django.core.cache <span style="color:#f92672">import</span> cache
<span style="color:#f92672">&gt;&gt;&gt;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> cache<span style="color:#f92672">.</span>set(<span style="color:#e6db74">&#39;my_key&#39;</span>, <span style="color:#e6db74">&#39;hello, world!&#39;</span>, <span style="color:#ae81ff">30</span>)
<span style="color:#f92672">&gt;&gt;&gt;</span> cache<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;my_key&#39;</span>)
<span style="color:#f92672">&gt;&gt;&gt;</span> cache<span style="color:#f92672">.</span>clear()</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> django.core.cache <span style="color:#f92672">import</span> caches
<span style="color:#f92672">&gt;&gt;&gt;</span> cache1 <span style="color:#f92672">=</span> caches[<span style="color:#e6db74">&#39;page&#39;</span>]
<span style="color:#f92672">&gt;&gt;&gt;</span> cache2 <span style="color:#f92672">=</span> caches[<span style="color:#e6db74">&#39;page&#39;</span>]
<span style="color:#f92672">&gt;&gt;&gt;</span> cache1 <span style="color:#f92672">is</span> cache2
True
<span style="color:#f92672">&gt;&gt;&gt;</span> cache3 <span style="color:#f92672">=</span> caches[<span style="color:#e6db74">&#39;session&#39;</span>]
<span style="color:#f92672">&gt;&gt;&gt;</span> cache2 <span style="color:#f92672">is</span> cache3
False</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> django_redis <span style="color:#f92672">import</span> get_redis_connection
<span style="color:#f92672">&gt;&gt;&gt;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> redis_client <span style="color:#f92672">=</span> get_redis_connection()
<span style="color:#f92672">&gt;&gt;&gt;</span> redis_client<span style="color:#f92672">.</span>hgetall()</code></pre></div></li>
</ol>

<h2 id="日志">日志</h2>

<h3 id="日志级别">日志级别</h3>

<p>NOTSET &lt; DEBUG &lt; INFO &lt; WARNING &lt; ERROR &lt; FATAL</p>

<h3 id="日志配置">日志配置</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">LOGGING <span style="color:#f92672">=</span> {
    <span style="color:#e6db74">&#39;version&#39;</span>: <span style="color:#ae81ff">1</span>,
    <span style="color:#e6db74">&#39;disable_existing_loggers&#39;</span>: False,
    <span style="color:#75715e"># 配置日志格式化器</span>
    <span style="color:#e6db74">&#39;formatters&#39;</span>: {
        <span style="color:#e6db74">&#39;simple&#39;</span>: {
            <span style="color:#e6db74">&#39;format&#39;</span>: <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%(asctime)s</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%(module)s</span><span style="color:#e6db74">.</span><span style="color:#e6db74">%(funcName)s</span><span style="color:#e6db74">: </span><span style="color:#e6db74">%(message)s</span><span style="color:#e6db74">&#39;</span>,
            <span style="color:#e6db74">&#39;datefmt&#39;</span>: <span style="color:#e6db74">&#39;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S&#39;</span>,
        },
        <span style="color:#e6db74">&#39;verbose&#39;</span>: {
            <span style="color:#e6db74">&#39;format&#39;</span>: <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%(asctime)s</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%(levelname)s</span><span style="color:#e6db74"> [</span><span style="color:#e6db74">%(process)d</span><span style="color:#e6db74">-</span><span style="color:#e6db74">%(threadName)s</span><span style="color:#e6db74">] &#39;</span>
                      <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%(module)s</span><span style="color:#e6db74">.</span><span style="color:#e6db74">%(funcName)s</span><span style="color:#e6db74"> line </span><span style="color:#e6db74">%(lineno)d</span><span style="color:#e6db74">: </span><span style="color:#e6db74">%(message)s</span><span style="color:#e6db74">&#39;</span>,
            <span style="color:#e6db74">&#39;datefmt&#39;</span>: <span style="color:#e6db74">&#39;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S&#39;</span>,
        }
    },
    <span style="color:#75715e"># 配置日志过滤器</span>
    <span style="color:#e6db74">&#39;filters&#39;</span>: {
        <span style="color:#e6db74">&#39;require_debug_true&#39;</span>: {
            <span style="color:#e6db74">&#39;()&#39;</span>: <span style="color:#e6db74">&#39;django.utils.log.RequireDebugTrue&#39;</span>,
        },
    },
    <span style="color:#75715e"># 配置日志处理器</span>
    <span style="color:#e6db74">&#39;handlers&#39;</span>: {
        <span style="color:#e6db74">&#39;console&#39;</span>: {
            <span style="color:#e6db74">&#39;class&#39;</span>: <span style="color:#e6db74">&#39;logging.StreamHandler&#39;</span>,
            <span style="color:#e6db74">&#39;level&#39;</span>: <span style="color:#e6db74">&#39;DEBUG&#39;</span>,
            <span style="color:#e6db74">&#39;filters&#39;</span>: [<span style="color:#e6db74">&#39;require_debug_true&#39;</span>],
            <span style="color:#e6db74">&#39;formatter&#39;</span>: <span style="color:#e6db74">&#39;simple&#39;</span>,
        },
        <span style="color:#e6db74">&#39;file1&#39;</span>: {
            <span style="color:#e6db74">&#39;class&#39;</span>: <span style="color:#e6db74">&#39;logging.handlers.TimedRotatingFileHandler&#39;</span>,
            <span style="color:#e6db74">&#39;filename&#39;</span>: <span style="color:#e6db74">&#39;access.log&#39;</span>,
            <span style="color:#e6db74">&#39;when&#39;</span>: <span style="color:#e6db74">&#39;W0&#39;</span>,
            <span style="color:#e6db74">&#39;backupCount&#39;</span>: <span style="color:#ae81ff">12</span>,
            <span style="color:#e6db74">&#39;formatter&#39;</span>: <span style="color:#e6db74">&#39;simple&#39;</span>,
            <span style="color:#e6db74">&#39;level&#39;</span>: <span style="color:#e6db74">&#39;INFO&#39;</span>,
        },
        <span style="color:#e6db74">&#39;file2&#39;</span>: {
            <span style="color:#e6db74">&#39;class&#39;</span>: <span style="color:#e6db74">&#39;logging.handlers.TimedRotatingFileHandler&#39;</span>,
            <span style="color:#e6db74">&#39;filename&#39;</span>: <span style="color:#e6db74">&#39;error.log&#39;</span>,
            <span style="color:#e6db74">&#39;when&#39;</span>: <span style="color:#e6db74">&#39;D&#39;</span>,
            <span style="color:#e6db74">&#39;backupCount&#39;</span>: <span style="color:#ae81ff">31</span>,
            <span style="color:#e6db74">&#39;formatter&#39;</span>: <span style="color:#e6db74">&#39;verbose&#39;</span>,
            <span style="color:#e6db74">&#39;level&#39;</span>: <span style="color:#e6db74">&#39;WARNING&#39;</span>,
        },
    },
    <span style="color:#75715e"># 配置日志器</span>
    <span style="color:#e6db74">&#39;loggers&#39;</span>: {
        <span style="color:#e6db74">&#39;django&#39;</span>: {
            <span style="color:#e6db74">&#39;handlers&#39;</span>: [<span style="color:#e6db74">&#39;console&#39;</span>, <span style="color:#e6db74">&#39;file1&#39;</span>, <span style="color:#e6db74">&#39;file2&#39;</span>],
            <span style="color:#e6db74">&#39;propagate&#39;</span>: True,
            <span style="color:#e6db74">&#39;level&#39;</span>: <span style="color:#e6db74">&#39;DEBUG&#39;</span>,
        },
    }
}</code></pre></div>
<p><a href="https://docs.djangoproject.com/zh-hans/2.0/topics/logging/#s-examples">日志配置官方示例</a>。</p>

<h3 id="日志分析">日志分析</h3>

<ol>
<li><p>Linux相关命令：head、tail、grep、awk、uniq、sort</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">tail -10000 access.log | awk <span style="color:#e6db74">&#39;{print $1}&#39;</span> | uniq -c | sort -r</code></pre></div></li>

<li><p>实时日志文件分析：Python + 正则表达式 + Crontab</p></li>

<li><p><a href="https://github.com/jkklee/web_log_analyse">《Python日志分析工具》</a>。</p></li>

<li><p><a href="https://www.ibm.com/developerworks/cn/opensource/os-cn-elk/index.html">《集中式日志系统ELK》</a>。</p>

<ul>
<li>ElasticSearch：搜索引擎，实现全文检索。</li>
<li>Logstash：负责从指定节点收集日志。</li>
<li>Kibana：日志可视化工具。</li>
</ul></li>

<li><p>大数据日志处理：Flume+Kafka日志采集、Storm / Spark实时数据处理、Impala实时查询。</p></li>
</ol>

<h2 id="restful">RESTful</h2>

<p>问题1：RESTful架构到底解决了什么问题？（URL具有自描述性、资源表述与视图的解耦和、互操作性利用构建微服务以及集成第三方系统、无状态性提高水平扩展能力）</p>

<p>问题2：项目在使用RESTful架构时有没有遇到一些问题或隐患？（对资源访问的限制、资源从属关系检查、避免泄露业务信息、防范可能的攻击）</p>

<blockquote>
<p>补充：下面的几个和安全性相关的响应头在前面讲中间件的时候提到过的。</p>

<ul>
<li>X-Frame-Options: DENY</li>
<li>X-Content-Type-Options: nosniff</li>
<li>X-XSS-Protection: 1; mode=block;</li>
<li>Strict­-Transport-­Security: max-age=31536000;</li>
</ul>
</blockquote>

<p>问题3：如何保护API中的敏感信息以及防范重放攻击？（摘要和令牌）</p>

<p>推荐阅读：<a href="https://help.aliyun.com/knowledge_detail/50041.html">《如何有效防止API的重放攻击》</a>。</p>

<h3 id="使用djangorestframework">使用djangorestframework</h3>

<p>安装djangorestfrmework（为了描述方便，以下统一简称为drf）。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">pip install djangorestframework</code></pre></div>
<p>配置drf。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">INSTALLED_APPS <span style="color:#f92672">=</span> [

    <span style="color:#e6db74">&#39;rest_framework&#39;</span>,

]

REST_FRAMEWORK <span style="color:#f92672">=</span> {
    <span style="color:#75715e"># 配置默认页面大小</span>
    <span style="color:#e6db74">&#39;PAGE_SIZE&#39;</span>: <span style="color:#ae81ff">10</span>,
    <span style="color:#75715e"># 配置默认的分页类</span>
    <span style="color:#e6db74">&#39;DEFAULT_PAGINATION_CLASS&#39;</span>: <span style="color:#e6db74">&#39;rest_framework.pagination.PageNumberPagination&#39;</span>,
    <span style="color:#75715e"># 配置异常处理器</span>
    <span style="color:#75715e"># &#39;EXCEPTION_HANDLER&#39;: &#39;api.exceptions.exception_handler&#39;,</span>
    <span style="color:#75715e"># 配置默认解析器</span>
    <span style="color:#75715e"># &#39;DEFAULT_PARSER_CLASSES&#39;: (</span>
    <span style="color:#75715e">#     &#39;rest_framework.parsers.JSONParser&#39;,</span>
    <span style="color:#75715e">#     &#39;rest_framework.parsers.FormParser&#39;,</span>
    <span style="color:#75715e">#     &#39;rest_framework.parsers.MultiPartParser&#39;,</span>
    <span style="color:#75715e"># ),</span>
    <span style="color:#75715e"># 配置默认限流类</span>
    <span style="color:#75715e"># &#39;DEFAULT_THROTTLE_CLASSES&#39;: (),</span>
    <span style="color:#75715e"># 配置默认授权类</span>
    <span style="color:#75715e"># &#39;DEFAULT_PERMISSION_CLASSES&#39;: (</span>
    <span style="color:#75715e">#     &#39;rest_framework.permissions.IsAuthenticated&#39;,</span>
    <span style="color:#75715e"># ),</span>
    <span style="color:#75715e"># 配置默认认证类</span>
    <span style="color:#75715e"># &#39;DEFAULT_AUTHENTICATION_CLASSES&#39;: (</span>
    <span style="color:#75715e">#     &#39;rest_framework_jwt.authentication.JSONWebTokenAuthentication&#39;,</span>
    <span style="color:#75715e"># ),</span>
}</code></pre></div>
<h3 id="编写序列化器">编写序列化器</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">from</span> rest_framework <span style="color:#f92672">import</span> serializers
<span style="color:#f92672">from</span> rest_framework.serializers <span style="color:#f92672">import</span> ModelSerializer

<span style="color:#f92672">from</span> common.models <span style="color:#f92672">import</span> District, HouseType, Estate, Agent


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DistrictSerializer</span>(ModelSerializer):

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Meta</span>:
        model <span style="color:#f92672">=</span> District
        fields <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;distid&#39;</span>, <span style="color:#e6db74">&#39;name&#39;</span>)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HouseTypeSerializer</span>(ModelSerializer):

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Meta</span>:
        model <span style="color:#f92672">=</span> HouseType
        fields <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;__all__&#39;</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AgentSerializer</span>(ModelSerializer):

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Meta</span>:
        model <span style="color:#f92672">=</span> Agent
        fields <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;agentid&#39;</span>, <span style="color:#e6db74">&#39;name&#39;</span>, <span style="color:#e6db74">&#39;tel&#39;</span>, <span style="color:#e6db74">&#39;servstar&#39;</span>, <span style="color:#e6db74">&#39;certificated&#39;</span>)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EstateSerializer</span>(ModelSerializer):
    district <span style="color:#f92672">=</span> serializers<span style="color:#f92672">.</span>SerializerMethodField()
    agents <span style="color:#f92672">=</span> serializers<span style="color:#f92672">.</span>SerializerMethodField()

    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_agents</span>(estate):
        <span style="color:#66d9ef">return</span> AgentSerializer(estate<span style="color:#f92672">.</span>agents, many<span style="color:#f92672">=</span>True)<span style="color:#f92672">.</span>data

    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_district</span>(estate):
        <span style="color:#66d9ef">return</span> DistrictSerializer(estate<span style="color:#f92672">.</span>district)<span style="color:#f92672">.</span>data

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Meta</span>:
        model <span style="color:#f92672">=</span> Estate
        fields <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;__all__&#39;</span></code></pre></div>
<h3 id="方法1-使用装饰器">方法1：使用装饰器</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#a6e22e">@api_view</span>([<span style="color:#e6db74">&#39;GET&#39;</span>])
<span style="color:#a6e22e">@cache_page</span>(timeout<span style="color:#f92672">=</span>None, cache<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;api&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">provinces</span>(request):
    queryset <span style="color:#f92672">=</span> District<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(parent__isnull<span style="color:#f92672">=</span>True)
    serializer <span style="color:#f92672">=</span> DistrictSerializer(queryset, many<span style="color:#f92672">=</span>True)
    <span style="color:#66d9ef">return</span> Response(serializer<span style="color:#f92672">.</span>data)


<span style="color:#a6e22e">@api_view</span>([<span style="color:#e6db74">&#39;GET&#39;</span>])
<span style="color:#a6e22e">@cache_page</span>(timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">300</span>, cache<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;api&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cities</span>(request, provid):
    queryset <span style="color:#f92672">=</span> District<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(parent__distid<span style="color:#f92672">=</span>provid)
    serializer <span style="color:#f92672">=</span> DistrictSerializer(queryset, many<span style="color:#f92672">=</span>True)
    <span style="color:#66d9ef">return</span> Response(serializer<span style="color:#f92672">.</span>data)</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">urlpatterns <span style="color:#f92672">=</span> [
    path(<span style="color:#e6db74">&#39;districts/&#39;</span>, views<span style="color:#f92672">.</span>provinces, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;districts&#39;</span>),
    path(<span style="color:#e6db74">&#39;districts/&lt;int:provid&gt;/&#39;</span>, views<span style="color:#f92672">.</span>cities, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;cities&#39;</span>),
]</code></pre></div>
<blockquote>
<p>说明：上面使用了Django自带的视图装饰器（@cache_page）来实现对API接口返回数据的缓存。</p>
</blockquote>

<h3 id="方法2-使用apiview及其子类">方法2：使用APIView及其子类</h3>

<p>更好的复用代码，不要重“复发明轮子”。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HouseTypeApiView</span>(CacheResponseMixin, ListAPIView):
    queryset <span style="color:#f92672">=</span> HouseType<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>all()
    serializer_class <span style="color:#f92672">=</span> HouseTypeSerializer</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">urlpatterns <span style="color:#f92672">=</span> [
    path(<span style="color:#e6db74">&#39;housetypes/&#39;</span>, views<span style="color:#f92672">.</span>HouseTypeApiView<span style="color:#f92672">.</span>as_view(), name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;housetypes&#39;</span>),
]</code></pre></div>
<blockquote>
<p>说明：上面使用了drf_extensions提供的CacheResponseMixin混入类实现了对接口数据的缓存。如果重写了获取数据的方法，可以使用drf_extensions提供的@cache_response来实现对接口数据的缓存，也可以用自定义的函数来生成缓存中的key。当然还有一个选择就是通过Django提供的@method_decorator装饰器，将@cache_page装饰器处理为装饰方法的装饰器，这样也能提供使用缓存服务。</p>
</blockquote>

<p><code>drf-extensions</code>配置如下所示。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#75715e"># 配置DRF扩展来支持缓存API接口调用结果</span>
REST_FRAMEWORK_EXTENSIONS <span style="color:#f92672">=</span> {
    <span style="color:#e6db74">&#39;DEFAULT_CACHE_RESPONSE_TIMEOUT&#39;</span>: <span style="color:#ae81ff">300</span>,
    <span style="color:#e6db74">&#39;DEFAULT_USE_CACHE&#39;</span>: <span style="color:#e6db74">&#39;default&#39;</span>,
    <span style="color:#75715e"># 配置默认缓存单个对象的key函数</span>
    <span style="color:#e6db74">&#39;DEFAULT_OBJECT_CACHE_KEY_FUNC&#39;</span>: <span style="color:#e6db74">&#39;rest_framework_extensions.utils.default_object_cache_key_func&#39;</span>,
    <span style="color:#75715e"># 配置默认缓存对象列表的key函数</span>
    <span style="color:#e6db74">&#39;DEFAULT_LIST_CACHE_KEY_FUNC&#39;</span>: <span style="color:#e6db74">&#39;rest_framework_extensions.utils.default_list_cache_key_func&#39;</span>,
}</code></pre></div>
<h3 id="方法3-使用viewset及其子类">方法3：使用ViewSet及其子类</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HouseTypeViewSet</span>(CacheResponseMixin, viewsets<span style="color:#f92672">.</span>ModelViewSet):
    queryset <span style="color:#f92672">=</span> HouseType<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>all()
    serializer_class <span style="color:#f92672">=</span> HouseTypeSerializer
    pagination_class <span style="color:#f92672">=</span> None</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">router <span style="color:#f92672">=</span> DefaultRouter()
router<span style="color:#f92672">.</span>register(<span style="color:#e6db74">&#39;housetypes&#39;</span>, views<span style="color:#f92672">.</span>HouseTypeViewSet)

urlpatterns <span style="color:#f92672">+=</span> router<span style="color:#f92672">.</span>urls</code></pre></div>
<p>djangorestframework提供了基于Bootstrap定制的页面来显示接口返回的JSON数据，当然也可以使用<a href="https://www.getpostman.com/">POSTMAN</a>这样的工具对API接口进行测试。</p>

<h3 id="补充说明">补充说明</h3>

<p>在这里顺便提一下跟前端相关的几个问题。</p>

<p>问题1：如何让浏览器能够发起DELETE/PUT/PATCH？</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-HTML" data-lang="HTML">&lt;<span style="color:#f92672">form</span> <span style="color:#a6e22e">method</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span>&gt;

    &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hidden&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;_method&#34;</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;delete&#34;</span>&gt;

&lt;/<span style="color:#f92672">form</span>&gt;</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span> <span style="color:#f92672">and</span> <span style="color:#e6db74">&#39;_method&#39;</span> <span style="color:#f92672">in</span> request<span style="color:#f92672">.</span>POST:
    request<span style="color:#f92672">.</span>method <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>POST[<span style="color:#e6db74">&#39;_method&#39;</span>]<span style="color:#f92672">.</span>upper()</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-HTML" data-lang="HTML">&lt;<span style="color:#f92672">script</span>&gt;
    <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">ajax</span>({
        <span style="color:#e6db74">&#39;url&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;/api/provinces&#39;</span>,
        <span style="color:#e6db74">&#39;type&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;put&#39;</span>,
        <span style="color:#e6db74">&#39;data&#39;</span><span style="color:#f92672">:</span> {},
        <span style="color:#e6db74">&#39;dataType&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;json&#39;</span>,
        <span style="color:#e6db74">&#39;success&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">json</span>) {
            <span style="color:#75715e">// Web = 标签(内容) + CSS(显示) + JS(行为)
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// JavaScript = ES + BOM + DOM
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// DOM操作实现页面的局部刷新
</span><span style="color:#75715e"></span>        },
        <span style="color:#e6db74">&#39;error&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>() {}
    });
    <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">getJSON</span>(<span style="color:#e6db74">&#39;/api/provinces&#39;</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">json</span>) {
        <span style="color:#75715e">// DOM操作实现页面的局部刷新
</span><span style="color:#75715e"></span>    });
&lt;/<span style="color:#f92672">script</span>&gt;</code></pre></div>
<p>问题2：如何解决多个JavaScript库之间某个定义（如$函数）冲突的问题？</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-HTML" data-lang="HTML">&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;js/jquery.min.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;js/abc.min.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
&lt;<span style="color:#f92672">script</span>&gt;
    <span style="color:#75715e">// $已经被后加载的JavaScript库占用了
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 但是可以直接用绑定在window对象上的jQuery去代替$
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">jQuery</span>(<span style="color:#66d9ef">function</span>() {
        <span style="color:#a6e22e">jQuery</span>(<span style="color:#e6db74">&#39;#okBtn&#39;</span>).<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;click&#39;</span>, <span style="color:#66d9ef">function</span>() {});
    });
&lt;/<span style="color:#f92672">script</span>&gt;</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-HTML" data-lang="HTML">&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;js/abc.min.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;js/jquery.min.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
&lt;<span style="color:#f92672">script</span>&gt;
    <span style="color:#75715e">// 将$让出给其他的JavaScript库使用
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">jQuery</span>.<span style="color:#a6e22e">noConflict</span>();
	<span style="color:#a6e22e">jQuery</span>(<span style="color:#66d9ef">function</span>() {
        <span style="color:#a6e22e">jQuery</span>(<span style="color:#e6db74">&#39;#okBtn&#39;</span>).<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;click&#39;</span>, <span style="color:#66d9ef">function</span>() {});
    });
&lt;/<span style="color:#f92672">script</span>&gt;</code></pre></div>
<p>问题3：jQuery对象与原生DOM对象之间如何转换？</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-HTML" data-lang="HTML">&lt;<span style="color:#f92672">button</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;okBtn&#34;</span>&gt;点我&lt;/<span style="color:#f92672">button</span>&gt;
&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;js/jquery.min.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
&lt;<span style="color:#f92672">script</span>&gt;
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">btn</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#39;okBtn&#39;</span>);	<span style="color:#75715e">// 原生JavaScript对象(使用相对麻烦)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">$btn</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">$</span>(<span style="color:#e6db74">&#39;#okBtn&#39;</span>);	<span style="color:#75715e">// jQuery对象(拥有更多的属性和方法而且没有浏览器兼容性问题)
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">$btn</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;click&#39;</span>, <span style="color:#66d9ef">function</span>() {});
    <span style="color:#75715e">// $(btn)可以将原生JavaScript对象转成jQuery对象
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// $btn.get(0)或$btn[0]可以获得原生的JavaScript对象
</span><span style="color:#75715e"></span>&lt;/<span style="color:#f92672">script</span>&gt;</code></pre></div>
<h3 id="过滤数据">过滤数据</h3>

<p>如果需要过滤数据（对数据接口设置筛选条件、排序条件等），可以使用<code>django-filter</code>三方库来实现。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">pip install django-filter</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">INSTALLED_APPS <span style="color:#f92672">=</span> [

    <span style="color:#e6db74">&#39;django_filters&#39;</span>,

]
REST_FRAMEWORK <span style="color:#f92672">=</span> {

    <span style="color:#e6db74">&#39;DEFAULT_FILTER_BACKENDS&#39;</span>: (
        <span style="color:#e6db74">&#39;django_filters.rest_framework.DjangoFilterBackend&#39;</span>,
        <span style="color:#e6db74">&#39;rest_framework.filters.OrderingFilter&#39;</span>,
    ),

}</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">from</span> django.utils.decorators <span style="color:#f92672">import</span> method_decorator
<span style="color:#f92672">from</span> django.views.decorators.cache <span style="color:#f92672">import</span> cache_page
<span style="color:#f92672">from</span> django_filters.rest_framework <span style="color:#f92672">import</span> DjangoFilterBackend
<span style="color:#f92672">from</span> rest_framework.filters <span style="color:#f92672">import</span> OrderingFilter
<span style="color:#f92672">from</span> rest_framework.generics <span style="color:#f92672">import</span> RetrieveAPIView, ListCreateAPIView

<span style="color:#f92672">from</span> api.serializers <span style="color:#f92672">import</span> EstateSerializer
<span style="color:#f92672">from</span> common.models <span style="color:#f92672">import</span> Estate


<span style="color:#a6e22e">@method_decorator</span>(decorator<span style="color:#f92672">=</span>cache_page(timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">120</span>, cache<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;api&#39;</span>, key_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;estates&#39;</span>), name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;get&#39;</span>)
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EstateView</span>(RetrieveAPIView, ListCreateAPIView):
    queryset <span style="color:#f92672">=</span> Estate<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>all()<span style="color:#f92672">.</span>select_related(<span style="color:#e6db74">&#39;district&#39;</span>)<span style="color:#f92672">.</span>prefetch_related(<span style="color:#e6db74">&#39;agents&#39;</span>)
    serializer_class <span style="color:#f92672">=</span> EstateSerializer
    filter_backends <span style="color:#f92672">=</span> (DjangoFilterBackend, OrderingFilter)
    filter_fields <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;name&#39;</span>, <span style="color:#e6db74">&#39;district&#39;</span>)
    ordering <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;-hot&#39;</span>, )
    ordering_fields <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;hot&#39;</span>, <span style="color:#e6db74">&#39;estateid&#39;</span>)</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">from</span> django_filters <span style="color:#f92672">import</span> rest_framework <span style="color:#66d9ef">as</span> drf
<span style="color:#f92672">from</span> common.models <span style="color:#f92672">import</span> HouseInfo


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HouseInfoFilter</span>(drf<span style="color:#f92672">.</span>FilterSet):
    <span style="color:#e6db74">&#34;&#34;&#34;自定义房源数据过滤器&#34;&#34;&#34;</span>

    title <span style="color:#f92672">=</span> drf<span style="color:#f92672">.</span>CharFilter(lookup_expr<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;starts&#39;</span>)
    dist <span style="color:#f92672">=</span> drf<span style="color:#f92672">.</span>NumberFilter(field_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;district&#39;</span>)
    min_price <span style="color:#f92672">=</span> drf<span style="color:#f92672">.</span>NumberFilter(field_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;price&#39;</span>, lookup_expr<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;gte&#39;</span>)
    max_price <span style="color:#f92672">=</span> drf<span style="color:#f92672">.</span>NumberFilter(field_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;price&#39;</span>, lookup_expr<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;lte&#39;</span>)
    type <span style="color:#f92672">=</span> drf<span style="color:#f92672">.</span>NumberFilter()

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Meta</span>:
        model <span style="color:#f92672">=</span> HouseInfo
        fields <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;title&#39;</span>, <span style="color:#e6db74">&#39;district&#39;</span>, <span style="color:#e6db74">&#39;min_price&#39;</span>, <span style="color:#e6db74">&#39;max_price&#39;</span>, <span style="color:#e6db74">&#39;type&#39;</span>)</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HouseInfoViewSet</span>(CacheResponseMixin, ReadOnlyModelViewSet):
    queryset <span style="color:#f92672">=</span> HouseInfo<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>all() \
        <span style="color:#f92672">.</span>select_related(<span style="color:#e6db74">&#39;type&#39;</span>, <span style="color:#e6db74">&#39;district&#39;</span>, <span style="color:#e6db74">&#39;estate&#39;</span>, <span style="color:#e6db74">&#39;agent&#39;</span>) \
        <span style="color:#f92672">.</span>prefetch_related(<span style="color:#e6db74">&#39;tags&#39;</span>)<span style="color:#f92672">.</span>order_by(<span style="color:#e6db74">&#39;-pubdate&#39;</span>)
    serializer_class <span style="color:#f92672">=</span> HouseInfoSerializer
    filter_backends <span style="color:#f92672">=</span> (DjangoFilterBackend, OrderingFilter)
    filterset_class <span style="color:#f92672">=</span> HouseInfoFilter
    ordering <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;price&#39;</span>,)
    ordering_fields <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;price&#39;</span>, <span style="color:#e6db74">&#39;area&#39;</span>)</code></pre></div>
<h3 id="身份认证">身份认证</h3>

<p>查看drf中APIView类的代码可以看出，drf默认的认证方案是 <code>DEFAULT_AUTHENTICATION_CLASSES</code>，如果修改authentication_classes就可以自行定制身份认证的方案。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">APIView</span>(View):

    <span style="color:#75715e"># The following policies may be set at either globally, or per-view.</span>
    renderer_classes <span style="color:#f92672">=</span> api_settings<span style="color:#f92672">.</span>DEFAULT_RENDERER_CLASSES
    parser_classes <span style="color:#f92672">=</span> api_settings<span style="color:#f92672">.</span>DEFAULT_PARSER_CLASSES
    authentication_classes <span style="color:#f92672">=</span> api_settings<span style="color:#f92672">.</span>DEFAULT_AUTHENTICATION_CLASSES
    throttle_classes <span style="color:#f92672">=</span> api_settings<span style="color:#f92672">.</span>DEFAULT_THROTTLE_CLASSES
    permission_classes <span style="color:#f92672">=</span> api_settings<span style="color:#f92672">.</span>DEFAULT_PERMISSION_CLASSES
    content_negotiation_class <span style="color:#f92672">=</span> api_settings<span style="color:#f92672">.</span>DEFAULT_CONTENT_NEGOTIATION_CLASS
    metadata_class <span style="color:#f92672">=</span> api_settings<span style="color:#f92672">.</span>DEFAULT_METADATA_CLASS
    versioning_class <span style="color:#f92672">=</span> api_settings<span style="color:#f92672">.</span>DEFAULT_VERSIONING_CLASS

   	<span style="color:#75715e"># 此处省略下面的代码</span></code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">DEFAULTS <span style="color:#f92672">=</span> {
    <span style="color:#75715e"># Base API policies</span>
    <span style="color:#e6db74">&#39;DEFAULT_RENDERER_CLASSES&#39;</span>: (
        <span style="color:#e6db74">&#39;rest_framework.renderers.JSONRenderer&#39;</span>,
        <span style="color:#e6db74">&#39;rest_framework.renderers.BrowsableAPIRenderer&#39;</span>,
    ),
    <span style="color:#e6db74">&#39;DEFAULT_PARSER_CLASSES&#39;</span>: (
        <span style="color:#e6db74">&#39;rest_framework.parsers.JSONParser&#39;</span>,
        <span style="color:#e6db74">&#39;rest_framework.parsers.FormParser&#39;</span>,
        <span style="color:#e6db74">&#39;rest_framework.parsers.MultiPartParser&#39;</span>
    ),
    <span style="color:#e6db74">&#39;DEFAULT_AUTHENTICATION_CLASSES&#39;</span>: (
        <span style="color:#e6db74">&#39;rest_framework.authentication.SessionAuthentication&#39;</span>,
        <span style="color:#e6db74">&#39;rest_framework.authentication.BasicAuthentication&#39;</span>
    ),
    <span style="color:#e6db74">&#39;DEFAULT_PERMISSION_CLASSES&#39;</span>: (
        <span style="color:#e6db74">&#39;rest_framework.permissions.AllowAny&#39;</span>,
    ),
    <span style="color:#e6db74">&#39;DEFAULT_THROTTLE_CLASSES&#39;</span>: (),
    <span style="color:#e6db74">&#39;DEFAULT_CONTENT_NEGOTIATION_CLASS&#39;</span>: <span style="color:#e6db74">&#39;rest_framework.negotiation.DefaultContentNegotiation&#39;</span>,
    <span style="color:#e6db74">&#39;DEFAULT_METADATA_CLASS&#39;</span>: <span style="color:#e6db74">&#39;rest_framework.metadata.SimpleMetadata&#39;</span>,
    <span style="color:#e6db74">&#39;DEFAULT_VERSIONING_CLASS&#39;</span>: None,

    <span style="color:#75715e"># 此处省略下面的代码</span>
}</code></pre></div>
<p>自定义认证类，继承<code>BaseAuthentication</code>并重写<code>authenticate(self, request)</code>方法，通过请求中的userid和token来确定用户身份。如果认证成功，该方法应返回一个二元组（用户和令牌的信息），否则产生异常。也可以重写 <code>authenticate_header(self, request)</code>方法来返回一个字符串，该字符串将用于<code>HTTP 401 Unauthorized</code>响应中的WWW-Authenticate响应头的值。如果未重写该方法，那么当未经身份验证的请求被拒绝访问时，身份验证方案将返回<code>HTTP 403 Forbidden</code>响应。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyAuthentication</span>(BaseAuthentication):
    <span style="color:#e6db74">&#34;&#34;&#34;自定义用户身份认证类&#34;&#34;&#34;</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">authenticate</span>(self, request):
        <span style="color:#66d9ef">try</span>:
            token <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>GET[<span style="color:#e6db74">&#39;token&#39;</span>] <span style="color:#f92672">or</span> request<span style="color:#f92672">.</span>POST[<span style="color:#e6db74">&#39;token&#39;</span>]
            user_token <span style="color:#f92672">=</span> UserToken<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(token<span style="color:#f92672">=</span>token)<span style="color:#f92672">.</span>first()
            <span style="color:#66d9ef">if</span> user_token:
                <span style="color:#66d9ef">return</span> user_token<span style="color:#f92672">.</span>user, user_token
            <span style="color:#66d9ef">else</span>:
                <span style="color:#66d9ef">raise</span> AuthenticationFailed(<span style="color:#e6db74">&#39;请提供有效的用户身份标识&#39;</span>)
        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">KeyError</span>:
            <span style="color:#66d9ef">raise</span> AuthenticationFailed(<span style="color:#e6db74">&#39;请提供有效的用户身份标识&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">authenticate_header</span>(self, request):
        <span style="color:#66d9ef">pass</span></code></pre></div>
<p>使用自定义的认证类。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EstateViewSet</span>(CacheResponseMixin, ModelViewSet):
    <span style="color:#75715e"># 通过queryset指定如何获取数据（资源）</span>
    queryset <span style="color:#f92672">=</span> Estate<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>all()<span style="color:#f92672">.</span>select_related(<span style="color:#e6db74">&#39;district&#39;</span>)<span style="color:#f92672">.</span>prefetch_related(<span style="color:#e6db74">&#39;agents&#39;</span>)
    <span style="color:#75715e"># 通过serializer_class指定如何序列化数据</span>
    serializer_class <span style="color:#f92672">=</span> EstateSerializer
    <span style="color:#75715e"># 指定根据哪些字段进行数据筛选</span>
    filter_fields <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;district&#39;</span>, <span style="color:#e6db74">&#39;name&#39;</span>)
    <span style="color:#75715e"># 指定根据哪些字段对数据进行排序</span>
    ordering_fields <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;hot&#39;</span>, )
    <span style="color:#75715e"># 指定用于进行用户身份验证的类</span>
    authentication_classes <span style="color:#f92672">=</span> (MyAuthentication, )</code></pre></div>
<blockquote>
<p>说明：也可以在Django配置文件中将自定义的认证类设置为默认认证方式。</p>
</blockquote>

<h3 id="授予权限">授予权限</h3>

<p>权限检查总是在视图的最开始处运行，在任何其他代码被允许进行之前。最简单的权限是允许通过身份验证的用户访问，并拒绝未经身份验证的用户访问，这对应于dfr中的<code>IsAuthenticated</code>类，可以用它来取代默认的<code>AllowAny</code>类。权限策略可以在Django的drf配置中用<code>DEFAULT_PERMISSION_CLASSES</code>全局设置。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">REST_FRAMEWORK <span style="color:#f92672">=</span> {
    <span style="color:#e6db74">&#39;DEFAULT_PERMISSION_CLASSES&#39;</span>: (
        <span style="color:#e6db74">&#39;rest_framework.permissions.IsAuthenticated&#39;</span>,
    )
}</code></pre></div>
<p>也可以在基于<code>APIView</code>类的视图上设置身份验证策略。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">from</span> rest_framework.permissions <span style="color:#f92672">import</span> IsAuthenticated
<span style="color:#f92672">from</span> rest_framework.views <span style="color:#f92672">import</span> APIView

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExampleView</span>(APIView):
    permission_classes <span style="color:#f92672">=</span> (IsAuthenticated, )
    <span style="color:#75715e"># 此处省略其他代码</span></code></pre></div>
<p>或者在基于<code>@api_view</code>装饰器的视图函数上设置。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">from</span> rest_framework.decorators <span style="color:#f92672">import</span> api_view, permission_classes
<span style="color:#f92672">from</span> rest_framework.permissions <span style="color:#f92672">import</span> IsAuthenticated

<span style="color:#a6e22e">@api_view</span>([<span style="color:#e6db74">&#39;GET&#39;</span>])
<span style="color:#a6e22e">@permission_classes</span>((IsAuthenticated, ))
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">example_view</span>(request, format<span style="color:#f92672">=</span>None):
    <span style="color:#75715e"># 此处省略其他代码</span></code></pre></div>
<p>自定义权限需要继承<code>BasePermission</code>并实现以下方法中的一个或两个，下面是BasePermission的代码。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#a6e22e">@six.add_metaclass</span>(BasePermissionMetaclass)
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BasePermission</span>(object):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    A base class from which all permission classes should inherit.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">has_permission</span>(self, request, view):
        <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">        Return `True` if permission is granted, `False` otherwise.
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        <span style="color:#66d9ef">return</span> True

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">has_object_permission</span>(self, request, view, obj):
        <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">        Return `True` if permission is granted, `False` otherwise.
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        <span style="color:#66d9ef">return</span> True</code></pre></div>
<p>如果请求被授予访问权限，则方法应该返回True，否则返False。下面的例子演示了阻止黑名单中的IP地址访问接口数据（这个在反爬虫的时候很有用哟）。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">from</span> rest_framework <span style="color:#f92672">import</span> permissions


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BlacklistPermission</span>(permissions<span style="color:#f92672">.</span>BasePermission):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Global permission check for blacklisted IPs.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">has_permission</span>(self, request, view):
        ip_addr <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>META[<span style="color:#e6db74">&#39;REMOTE_ADDR&#39;</span>]
        blacklisted <span style="color:#f92672">=</span> Blacklist<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(ip_addr<span style="color:#f92672">=</span>ip_addr)<span style="color:#f92672">.</span>exists()
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">not</span> blacklisted</code></pre></div>
<p>如果要实现更为完整的权限验证，可以考虑RBAC或ACL。</p>

<ol>
<li>RBAC - 基于角色的访问控制，如下图所示。</li>
</ol>

<p><img src="Day91-100/res/rbac-basic.png" alt="" /></p>

<p><img src="Day91-100/res/rbac-full.png" alt="" /></p>

<ol>
<li>ACL - 访问控制列表（每个用户绑定自己的访问白名单）。</li>
</ol>

<h3 id="访问限流">访问限流</h3>

<p>可以修改dfr配置的<code>DEFAULT_THROTTLE_CLASSES</code> 和 <code>DEFAULT_THROTTLE_RATES</code>两个值来设置全局默认限流策略。例如：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">REST_FRAMEWORK <span style="color:#f92672">=</span> {
    <span style="color:#e6db74">&#39;DEFAULT_THROTTLE_CLASSES&#39;</span>: (
        <span style="color:#e6db74">&#39;rest_framework.throttling.AnonRateThrottle&#39;</span>,
        <span style="color:#e6db74">&#39;rest_framework.throttling.UserRateThrottle&#39;</span>
    ),
    <span style="color:#e6db74">&#39;DEFAULT_THROTTLE_RATES&#39;</span>: {
        <span style="color:#e6db74">&#39;anon&#39;</span>: <span style="color:#e6db74">&#39;3/min&#39;</span>,
        <span style="color:#e6db74">&#39;user&#39;</span>: <span style="color:#e6db74">&#39;10000/day&#39;</span>
    }
}</code></pre></div>
<p><code>DEFAULT_THROTTLE_RATES</code>中使用的频率描述可能包括<code>second</code>、<code>minute</code>、<code>hour</code>或<code>day</code>。</p>

<p>如果要为接口单独设置限流，可以在每个视图或视图集上设置限流策略，如下所示：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">from</span> rest_framework.throttling <span style="color:#f92672">import</span> UserRateThrottle
<span style="color:#f92672">from</span> rest_framework.views <span style="color:#f92672">import</span> APIView


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExampleView</span>(APIView):
    throttle_classes <span style="color:#f92672">=</span> (UserRateThrottle, )
    <span style="color:#75715e"># 此处省略下面的代码</span></code></pre></div>
<p>或</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#a6e22e">@api_view</span>([<span style="color:#e6db74">&#39;GET&#39;</span>])
<span style="color:#a6e22e">@throttle_classes</span>([UserRateThrottle, ])
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">example_view</span>(request, format<span style="color:#f92672">=</span>None):
    <span style="color:#75715e"># 此处省略下面的代码</span></code></pre></div>
<p>当然也可以通过继承<code>BaseThrottle</code>来自定义限流策略，通常需要重写<code>allow_request</code>和<code>wait</code>方法。</p>

<h2 id="异步任务和计划任务">异步任务和计划任务</h2>

<h3 id="celery的应用">Celery的应用</h3>

<p>Celery 是一个简单、灵活且可靠的，处理大量消息的分布式系统，并且提供维护这样一个系统的必需工具。它是一个专注于实时处理的任务队列，同时也支持任务调度。</p>

<p>推荐阅读：<a href="http://docs.jinkan.org/docs/celery/">《Celery官方文档中文版》</a>，上面有极为详细的配置和使用指南。</p>

<p><img src="Day91-100/res/celery_architecture.png" alt="" /></p>

<p>Celery是一个本身不提供队列服务，官方推荐使用RabbitMQ或Redis来实现消息队列服务，前者是更好的选择，它对AMQP（高级消息队列协议）做出了非常好的实现。</p>

<ol>
<li><p>安装RabbitMQ。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">docker pull rabbitmq
docker run -d -p <span style="color:#ae81ff">5672</span>:5672 --name myrabbit rabbitmq
docker container exec -it myrabbit /bin/bash</code></pre></div></li>

<li><p>创建用户、资源以及分配操作权限。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">rabbitmqctl add_user luohao <span style="color:#ae81ff">123456</span>
rabbitmqctl set_user_tags luohao administrator
rabbitmqctl add_vhost vhost1
rabbitmqctl set_permissions -p vhost1 luohao <span style="color:#e6db74">&#34;.*&#34;</span> <span style="color:#e6db74">&#34;.*&#34;</span> <span style="color:#e6db74">&#34;.*&#34;</span></code></pre></div></li>

<li><p>创建Celery实例。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#75715e"># 注册环境变量</span>
os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>setdefault(<span style="color:#e6db74">&#39;DJANGO_SETTINGS_MODULE&#39;</span>, <span style="color:#e6db74">&#39;fangtx.settings&#39;</span>)

<span style="color:#75715e"># 创建Celery实例</span>
app <span style="color:#f92672">=</span> celery<span style="color:#f92672">.</span>Celery(
   <span style="color:#e6db74">&#39;fangtx&#39;</span>,
   broker<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;amqp://luohao:123456@120.77.222.217:5672/vhost1&#39;</span>
)

<span style="color:#75715e"># 从项目的配置文件读取Celery配置信息</span>
app<span style="color:#f92672">.</span>config_from_object(<span style="color:#e6db74">&#39;django.conf:settings&#39;</span>)
<span style="color:#75715e"># 从指定的文件(例如celery_config.py)中读取Celery配置信息</span>
<span style="color:#75715e"># app.config_from_object(&#39;celery_config&#39;)</span>

<span style="color:#75715e"># 让Celery自动从参数指定的应用中发现异步任务/定时任务</span>
app<span style="color:#f92672">.</span>autodiscover_tasks([<span style="color:#e6db74">&#39;common&#39;</span>, ])
<span style="color:#75715e"># 让Celery自动从所有注册的应用中发现异步任务/定时任务</span>
<span style="color:#75715e"># app.autodiscover_tasks(lambda: settings.INSTALLED_APPS)</span></code></pre></div></li>

<li><p>启动Celery创建woker（消息的消费者）。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">celery -A &lt;name&gt; worker -l debug &amp;</code></pre></div></li>

<li><p>执行异步任务。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#a6e22e">@app.task</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_email</span>(from, to, cc, subject, content):
   <span style="color:#66d9ef">pass</span>


send_email<span style="color:#f92672">.</span>delay(<span style="color:#e6db74">&#39;&#39;</span>, [], [], <span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)</code></pre></div></li>

<li><p>创建定时任务。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#75715e"># 配置定时任务（计划任务）</span>
app<span style="color:#f92672">.</span>conf<span style="color:#f92672">.</span>update(
   timezone<span style="color:#f92672">=</span>settings<span style="color:#f92672">.</span>TIME_ZONE,
   enable_utc<span style="color:#f92672">=</span>True,
   <span style="color:#75715e"># 定时任务（计划任务）相当于是消息的生产者</span>
   <span style="color:#75715e"># 如果只有生产者没有消费者那么消息就会在消息队列中积压</span>
   <span style="color:#75715e"># 将来实际部署项目的时候生产者、消费者、消息队列可能都是不同节点</span>
   beat_schedule<span style="color:#f92672">=</span>{
       <span style="color:#e6db74">&#39;task1&#39;</span>: {
           <span style="color:#e6db74">&#39;task&#39;</span>: <span style="color:#e6db74">&#39;common.tasks.show_msg&#39;</span>,
           <span style="color:#e6db74">&#39;schedule&#39;</span>: crontab(),
           <span style="color:#e6db74">&#39;args&#39;</span>: (<span style="color:#e6db74">&#39;刘强东，奶茶妹妹喊你回家喝奶啦&#39;</span>, )
       },
   },
)</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#a6e22e">@app.task</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">show_msg</span>(content):
   <span style="color:#66d9ef">print</span>(content)</code></pre></div></li>

<li><p>启动Celery创建执行定时任务的beat（消息的生产者）。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">celery -A &lt;name&gt; beat -l info</code></pre></div></li>

<li><p>检查消息队列状况。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">rabbitmqctl list_queues -p vhost1</code></pre></div></li>

<li><p>监控Celery - 可以通过flower来对Celery进行监控。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">pip install flower
celery flower --broker<span style="color:#f92672">=</span>amqp://luohao:123456@120.77.222.217:5672/vhost1</code></pre></div></li>
</ol>

<h2 id="其他问题">其他问题</h2>

<p>问题1：如何解决JavaScript跨域获取数据的问题？（django-cors-headers）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">INSTALLED_APPS <span style="color:#f92672">=</span> [
    <span style="color:#e6db74">&#39;corsheaders&#39;</span>,
]

MIDDLEWARE <span style="color:#f92672">=</span> [
    <span style="color:#e6db74">&#39;corsheaders.middleware.CorsMiddleware&#39;</span>,
]

CORS_ORIGIN_ALLOW_ALL <span style="color:#f92672">=</span> True
<span style="color:#75715e"># 配置跨域白名单</span>
<span style="color:#75715e"># CORS_ORIGIN_WHITELIST = (&#39;www.abc.com&#39;, &#39;www.baidu.com&#39;)</span>
<span style="color:#75715e"># CORS_ORIGIN_REGEX_WHITELIST = (&#39;...&#39;, )</span>
<span style="color:#75715e"># CORS_ALLOW_CREDENTIALS = True</span>
<span style="color:#75715e"># CORS_ALLOW_METHODS = (&#39;GET&#39;, &#39;POST&#39;, &#39;PUT&#39;, &#39;DELETE&#39;)</span></code></pre></div>
<p>问题2：网站图片（水印、剪裁）和视频（截图、水印、转码）是如何处理的？（云存储、FFmpeg）</p>

<p>问题3：网站如何架设（静态资源）文件系统？（FastDFS、云存储、CDN）</p>

<h2 id="安全保护">安全保护</h2>

<p>问题1：什么是跨站脚本攻击，如何防范？（对提交的内容进行消毒）</p>

<p>问题2：什么是跨站身份伪造，如何防范？（使用随机令牌）</p>

<p>问题3：什么是SQL注射攻击，如何防范？（不拼接SQL语句，避免使用单引号）</p>

<p>问题4：什么是点击劫持攻击，如何防范？（不允许<code>&lt;iframe&gt;</code>加载非同源站点内容）</p>

<h3 id="django提供的安全措施">Django提供的安全措施</h3>

<p>签名数据的API</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> django.core.signing <span style="color:#f92672">import</span> Signer
<span style="color:#f92672">&gt;&gt;&gt;</span> signer <span style="color:#f92672">=</span> Signer()
<span style="color:#f92672">&gt;&gt;&gt;</span> value <span style="color:#f92672">=</span> signer<span style="color:#f92672">.</span>sign(<span style="color:#e6db74">&#39;hello, world!&#39;</span>)
<span style="color:#f92672">&gt;&gt;&gt;</span> value
<span style="color:#e6db74">&#39;hello, world!:BYMlgvWMTSPLxC-DqxByleiMVXU&#39;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> signer<span style="color:#f92672">.</span>unsign(value)
<span style="color:#e6db74">&#39;hello, world!&#39;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> signer <span style="color:#f92672">=</span> Signer(salt<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;1qaz2wsx&#39;</span>)
<span style="color:#f92672">&gt;&gt;&gt;</span> signer<span style="color:#f92672">.</span>sign(<span style="color:#e6db74">&#39;hello, world!&#39;</span>)
<span style="color:#e6db74">&#39;hello, world!:9vEvG6EA05hjMDB5MtUr33nRA_M&#39;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> django.core.signing <span style="color:#f92672">import</span> TimestampSigner
<span style="color:#f92672">&gt;&gt;&gt;</span> signer <span style="color:#f92672">=</span> TimestampSigner()
<span style="color:#f92672">&gt;&gt;&gt;</span> value <span style="color:#f92672">=</span> signer<span style="color:#f92672">.</span>sign(<span style="color:#e6db74">&#39;hello, world!&#39;</span>)
<span style="color:#f92672">&gt;&gt;&gt;</span> value
<span style="color:#e6db74">&#39;hello, world!:1fpmcQ:STwj464IFE6eUB-_-hyUVF3d2So&#39;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> signer<span style="color:#f92672">.</span>unsign(value, max_age<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
Traceback (most recent call last):
    File <span style="color:#e6db74">&#34;&lt;console&gt;&#34;</span>, line <span style="color:#ae81ff">1</span>, <span style="color:#f92672">in</span> <span style="color:#f92672">&lt;</span>module<span style="color:#f92672">&gt;</span>
    File <span style="color:#e6db74">&#34;/Users/Hao/Desktop/fang.com/venv/lib/python3.6/site-packages/django/core/signing.py&#34;</span>, line <span style="color:#ae81ff">198</span>, <span style="color:#f92672">in</span> unsign
    <span style="color:#e6db74">&#39;Signature age </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> &gt; </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> seconds&#39;</span> <span style="color:#f92672">%</span> (age, max_age))
    django<span style="color:#f92672">.</span>core<span style="color:#f92672">.</span>signing<span style="color:#f92672">.</span>SignatureExpired: Signature age <span style="color:#ae81ff">21.020604848861694</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">5</span> seconds
<span style="color:#f92672">&gt;&gt;&gt;</span> signer<span style="color:#f92672">.</span>unsign(value, max_age<span style="color:#f92672">=</span><span style="color:#ae81ff">120</span>)
<span style="color:#e6db74">&#39;hello, world!&#39;</span></code></pre></div>
<p>CSRF令牌和小工具</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-HTML" data-lang="HTML">{% csrf_token %}</code></pre></div>
<ul>
<li>@csrf_exempt：免除令牌</li>
<li>@csrf_protect：提供令牌保护</li>
<li>@require_csrf_token：提供令牌保护</li>
<li>@ensure_csrf_cookie：强制视图发送带令牌的cookie</li>
</ul>

<blockquote>
<p>说明：可以在Chrome浏览器中安装EditThisCookie插件来方便的查看Cookie。</p>
</blockquote>

<h3 id="用户敏感信息的保护">用户敏感信息的保护</h3>

<ol>
<li><p>哈希摘要（签名）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">import</span> hashlib
<span style="color:#f92672">&gt;&gt;&gt;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> md5_hasher <span style="color:#f92672">=</span> hashlib<span style="color:#f92672">.</span>md5()
<span style="color:#f92672">&gt;&gt;&gt;</span> md5_hasher<span style="color:#f92672">.</span>update(<span style="color:#e6db74">&#39;hello, world!&#39;</span><span style="color:#f92672">.</span>encode())
<span style="color:#f92672">&gt;&gt;&gt;</span> md5_hasher<span style="color:#f92672">.</span>hexdigest()
<span style="color:#e6db74">&#39;3adbbad1791fbae3ec908894c4963870&#39;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> sha1_hasher <span style="color:#f92672">=</span> hashlib<span style="color:#f92672">.</span>sha1()
<span style="color:#f92672">&gt;&gt;&gt;</span> sha1_hasher<span style="color:#f92672">.</span>update(<span style="color:#e6db74">&#39;hello, world!&#39;</span><span style="color:#f92672">.</span>encode())
<span style="color:#f92672">&gt;&gt;&gt;</span> sha1_hasher<span style="color:#f92672">.</span>update(<span style="color:#e6db74">&#39;goodbye, world!&#39;</span><span style="color:#f92672">.</span>encode())
<span style="color:#f92672">&gt;&gt;&gt;</span> sha1_hasher<span style="color:#f92672">.</span>hexdigest()
<span style="color:#e6db74">&#39;1f09d30c707d53f3d16c530dd73d70a6ce7596a9&#39;</span></code></pre></div></li>

<li><p>加密和解密（对称加密和非对称加密）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">pip install rsa</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">&gt;&gt;&gt;</span> pub_key, pri_key <span style="color:#f92672">=</span> rsa<span style="color:#f92672">.</span>newkeys(<span style="color:#ae81ff">1024</span>)
<span style="color:#f92672">&gt;&gt;&gt;</span> message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;hello, world!&#39;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> crypto <span style="color:#f92672">=</span> rsa<span style="color:#f92672">.</span>encrypt(message<span style="color:#f92672">.</span>encode(), pub_key)
<span style="color:#f92672">&gt;&gt;&gt;</span> crypto
<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Ou{gH</span><span style="color:#ae81ff">\xa9\xa8</span><span style="color:#e6db74">}O</span><span style="color:#ae81ff">\xe3\x1d\x05</span><span style="color:#e6db74">2|M</span><span style="color:#ae81ff">\x9d</span><span style="color:#e6db74">9?</span><span style="color:#ae81ff">\xdc\xd8\xec</span><span style="color:#e6db74">F</span><span style="color:#ae81ff">\xd3</span><span style="color:#e6db74">v</span><span style="color:#ae81ff">\x9b\xde\x8e\x12\xe6</span><span style="color:#e6db74">M</span><span style="color:#ae81ff">\xeb</span><span style="color:#e6db74">vx</span><span style="color:#ae81ff">\x08\x08\x8b\xe8\x86</span><span style="color:#e6db74">~</span><span style="color:#ae81ff">\xe4</span><span style="color:#e6db74">^)w</span><span style="color:#ae81ff">\xf2\xef\x9e\x9f</span><span style="color:#e6db74">Og</span><span style="color:#ae81ff">\x15</span><span style="color:#e6db74">Q</span><span style="color:#ae81ff">\xb7\x7f\x1d\xcf</span><span style="color:#e6db74">V</span><span style="color:#ae81ff">\xf1\r\xbe</span><span style="color:#e6db74">^+</span><span style="color:#ae81ff">\x8a\xbf</span><span style="color:#e6db74"> }</span><span style="color:#ae81ff">\x10\x01\xa4</span><span style="color:#e6db74">U9b</span><span style="color:#ae81ff">\x97\xf5\xe0\x90</span><span style="color:#e6db74">T</span><span style="color:#ae81ff">\&#39;\xd4</span><span style="color:#e6db74">(</span><span style="color:#ae81ff">\x9b\x00\xa5\x92\x17\xad</span><span style="color:#e6db74">4</span><span style="color:#ae81ff">\xb0\xb0</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd4\x16\x94</span><span style="color:#e6db74">*s</span><span style="color:#ae81ff">\xe1</span><span style="color:#e6db74">r</span><span style="color:#ae81ff">\xb7</span><span style="color:#e6db74">L</span><span style="color:#ae81ff">\xe2\x98\xb7\x7f\x03\xd9\xf2\t\xee</span><span style="color:#e6db74">*</span><span style="color:#ae81ff">\xe6\x93\xe6\xe1</span><span style="color:#e6db74">o</span><span style="color:#ae81ff">\xfd\x18\x83</span><span style="color:#e6db74">L</span><span style="color:#ae81ff">\x0c</span><span style="color:#e6db74">fL</span><span style="color:#ae81ff">\xff\xe4\xdd</span><span style="color:#e6db74">%</span><span style="color:#ae81ff">\xf2\xc0</span><span style="color:#e6db74">/</span><span style="color:#ae81ff">\xfb</span><span style="color:#e6db74">&#39;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> origin <span style="color:#f92672">=</span> rsa<span style="color:#f92672">.</span>decrypt(crypto, pri_key)<span style="color:#f92672">.</span>decode()
<span style="color:#f92672">&gt;&gt;&gt;</span> origin
<span style="color:#e6db74">&#39;hello, world!&#39;</span></code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">pip install pycrypto</code></pre></div></li>
</ol>

<p>AES对称加密：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">   <span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> hashlib <span style="color:#f92672">import</span> md5
   <span style="color:#f92672">&gt;&gt;&gt;</span>
   <span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> Crypto.Cipher <span style="color:#f92672">import</span> AES
   <span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> Crypto <span style="color:#f92672">import</span> Random
   <span style="color:#f92672">&gt;&gt;&gt;</span>
   <span style="color:#f92672">&gt;&gt;&gt;</span> key <span style="color:#f92672">=</span> md5(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;mysecret&#39;</span>)<span style="color:#f92672">.</span>hexdigest()
   <span style="color:#f92672">&gt;&gt;&gt;</span> iv <span style="color:#f92672">=</span> Random<span style="color:#f92672">.</span>new()<span style="color:#f92672">.</span>read(AES<span style="color:#f92672">.</span>block_size)
   <span style="color:#f92672">&gt;&gt;&gt;</span> str1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;我爱你们！&#39;</span>
   <span style="color:#f92672">&gt;&gt;&gt;</span> str2 <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>new(key, AES<span style="color:#f92672">.</span>MODE_CFB, iv)<span style="color:#f92672">.</span>encrypt(str1)
   <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;p</span><span style="color:#ae81ff">\x96</span><span style="color:#e6db74">o</span><span style="color:#ae81ff">\x85\x0b</span><span style="color:#e6db74">q</span><span style="color:#ae81ff">\xc4</span><span style="color:#e6db74">-Y</span><span style="color:#ae81ff">\xc4\xbc</span><span style="color:#e6db74">p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">)&amp;&#39;</span>
   <span style="color:#f92672">&gt;&gt;&gt;</span> str3 <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>new(key, AES<span style="color:#f92672">.</span>MODE_CFB, iv)<span style="color:#f92672">.</span>decrypt(str2)<span style="color:#f92672">.</span>decode()
   <span style="color:#e6db74">&#39;我爱你们！&#39;</span></code></pre></div>
<p>RSA非对称加密：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">   <span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> Crypto.PublicKey <span style="color:#f92672">import</span> RSA
   <span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#75715e"># 生成密钥对</span>
   <span style="color:#f92672">&gt;&gt;&gt;</span> key_pair <span style="color:#f92672">=</span> RSA<span style="color:#f92672">.</span>generate(<span style="color:#ae81ff">2048</span>)
   <span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#75715e"># 导入公钥</span>
   <span style="color:#f92672">&gt;&gt;&gt;</span> pub_key <span style="color:#f92672">=</span> RSA<span style="color:#f92672">.</span>importKey(key_pair<span style="color:#f92672">.</span>publickey()<span style="color:#f92672">.</span>exportKey())
   <span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#75715e"># 导入私钥</span>
   <span style="color:#f92672">&gt;&gt;&gt;</span> pri_key <span style="color:#f92672">=</span> RSA<span style="color:#f92672">.</span>importKey(key_pair<span style="color:#f92672">.</span>exportKey())
   <span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#75715e"># 明文</span>
   <span style="color:#f92672">&gt;&gt;&gt;</span> message1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;hello, world!&#39;</span><span style="color:#f92672">.</span>encode()
   <span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#75715e"># 加密数据</span>
   <span style="color:#f92672">&gt;&gt;&gt;</span> message2 <span style="color:#f92672">=</span> pub_key<span style="color:#f92672">.</span>encrypt(message1, None)
   (<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x03\x86</span><span style="color:#e6db74">t</span><span style="color:#ae81ff">\xa0\x00\xc4\xea\xd2\x80\xed\xa7</span><span style="color:#e6db74">YN7</span><span style="color:#ae81ff">\x07\xff\x88\xaa\x1e</span><span style="color:#e6db74">W</span><span style="color:#ae81ff">\x0c</span><span style="color:#e6db74">mH0</span><span style="color:#ae81ff">\x06\xa7\&#39;\xbc</span><span style="color:#e6db74">&lt;w@q</span><span style="color:#ae81ff">\x8b\xaf\xf7</span><span style="color:#e6db74">:g</span><span style="color:#ae81ff">\x92</span><span style="color:#e6db74">{=</span><span style="color:#ae81ff">\xe2</span><span style="color:#e6db74">E</span><span style="color:#ae81ff">\xa5</span><span style="color:#e6db74">@</span><span style="color:#ae81ff">\x1a</span><span style="color:#e6db74">s2</span><span style="color:#ae81ff">\xdd\xcb\x8e</span><span style="color:#e6db74">[</span><span style="color:#ae81ff">\x98\x85\xdf</span><span style="color:#e6db74">,X</span><span style="color:#ae81ff">\xec</span><span style="color:#e6db74">j.U</span><span style="color:#ae81ff">\xd6\xa7</span><span style="color:#e6db74">W&amp;u</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">Uz&#34;</span><span style="color:#ae81ff">\x0f\x0e\\</span><span style="color:#e6db74">&lt;</span><span style="color:#ae81ff">\xa4\xfa</span><span style="color:#e6db74">vC</span><span style="color:#ae81ff">\x93\xa7\xbc</span><span style="color:#e6db74">O&#34;</span><span style="color:#ae81ff">\xb9</span><span style="color:#e6db74">a</span><span style="color:#ae81ff">\x06</span><span style="color:#e6db74">]&lt;.</span><span style="color:#ae81ff">\xc1\r</span><span style="color:#e6db74">1}*</span><span style="color:#ae81ff">\xdf\xcc</span><span style="color:#e6db74">dqXML</span><span style="color:#ae81ff">\x93\x1b\xe9\xda\xdf\xab</span><span style="color:#e6db74">|</span><span style="color:#ae81ff">\xf8\x18\xe4\x99\xbb\x7f\x18</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\xd9\x9a\x1e</span><span style="color:#e6db74">*J</span><span style="color:#ae81ff">\\\xca\x1a\xd1\x85\xf7</span><span style="color:#e6db74">t</span><span style="color:#ae81ff">\x81\xd9</span><span style="color:#e6db74">5{</span><span style="color:#ae81ff">\x19\xc9\x81\xb6</span><span style="color:#e6db74">^}</span><span style="color:#ae81ff">\x9c</span><span style="color:#e6db74">5</span><span style="color:#ae81ff">\xca\xfe\xcf\xc8\xd8</span><span style="color:#e6db74">M</span><span style="color:#ae81ff">\x9a\x8c</span><span style="color:#e6db74">-</span><span style="color:#ae81ff">\xf1</span><span style="color:#e6db74">t</span><span style="color:#ae81ff">\xee\xf9\x12\x90\x01\xca\x92</span><span style="color:#e6db74">~</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">c5qg5g</span><span style="color:#ae81ff">\x95</span><span style="color:#e6db74">&amp;</span><span style="color:#ae81ff">\x10\xb1\x0b\x1f</span><span style="color:#e6db74">o</span><span style="color:#ae81ff">\x95\xf2\xbc\x8d\xf3</span><span style="color:#e6db74">f&#34;@</span><span style="color:#ae81ff">\xc5\x18</span><span style="color:#e6db74">8</span><span style="color:#ae81ff">\x0b</span><span style="color:#e6db74">X</span><span style="color:#ae81ff">\x9c</span><span style="color:#e6db74">fo</span><span style="color:#ae81ff">\xea\x97\x05</span><span style="color:#e6db74">@</span><span style="color:#ae81ff">\xe5\xb2\xda\xb8\x97</span><span style="color:#e6db74">a</span><span style="color:#ae81ff">\xa5</span><span style="color:#e6db74">w</span><span style="color:#ae81ff">\xa8\x01\x9a\xa5</span><span style="color:#e6db74">N</span><span style="color:#ae81ff">\xc4\x81\x8d\x0f</span><span style="color:#e6db74">&lt;</span><span style="color:#ae81ff">\x96</span><span style="color:#e6db74">iU</span><span style="color:#ae81ff">\xd3\x95\xac</span><span style="color:#e6db74">JZs</span><span style="color:#ae81ff">\xab</span><span style="color:#e6db74">_ #</span><span style="color:#ae81ff">\xee\xf9\x0f\xf2\x12\xdb\xfc\xf8</span><span style="color:#e6db74">g</span><span style="color:#ae81ff">\x18</span><span style="color:#e6db74">v</span><span style="color:#ae81ff">\x02</span><span style="color:#e6db74">k+</span><span style="color:#ae81ff">\xda\x16</span><span style="color:#e6db74">Si</span><span style="color:#ae81ff">\xbf\xbb\xec\xf7</span><span style="color:#e6db74">w</span><span style="color:#ae81ff">\x90\xde\xae\x97\t\xed</span><span style="color:#e6db74">{}5</span><span style="color:#ae81ff">\xd0</span><span style="color:#e6db74">&#39;</span>,)
   <span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#75715e"># 解密数据</span>
   <span style="color:#f92672">&gt;&gt;&gt;</span> message3 <span style="color:#f92672">=</span> pri_key<span style="color:#f92672">.</span>decrypt(message2)
   <span style="color:#e6db74">&#39;hello, world!&#39;</span></code></pre></div>
<h3 id="安全相关建议">安全相关建议</h3>

<ol>
<li>虽然 Django 自带了稳固的安全保护措施，但是依然要采用正确的方式部署应用程序，利用 Web 服务器、操作系统和其他组件提供的安全保护措施。</li>
<li>记得把 Python 代码放在 Web 服务器的文档根目录之外，避免代码意外泄露。</li>
<li>谨慎处理用户上传的文件。</li>
<li>Django本身没有对请求次数加以限制（包括验证用户身份的请求），为了防止暴力攻击和破解，可以考虑使用具有一次消费性的验证码或对这类请求的次数进行限制。<br /></li>
<li>将缓存系统、数据库服务器以及重要的资源服务器都放在第二级防火墙之后（不要放在DMZ）。</li>
</ol>

<h2 id="测试相关">测试相关</h2>

<p>测试是发现和标记缺陷的过程。所谓的缺陷是指实际结果和期望结果之间的任何差别。有的地方，测试也被认为是执行以找出错误为目的的程序的过程。 测试是为了让产品达到以下目标：</p>

<ol>
<li>满足需求用户满意</li>
<li>改善产品的市场占有率</li>
<li>树立对产品的信任</li>
<li>减少开发和维护的成本</li>
</ol>

<h3 id="功能测试">功能测试</h3>

<p>如果一个软件单元的行为方式与它的开发规范完全一样，那么该软件单元就通过了它的功能测试。
 - 白盒测试：开发人员自己实现，最基本的形式是单元测试，还有集成测试和系统测试。
 - 黑盒测试：由开发团队之外的人执行，对测试代码没有可见性，将被测系统视为黑盒子。通常由测试人员或QA工程师来执行，Web应用可以通过Selenium这样的测试框架自动化实施。</p>

<h3 id="性能测试">性能测试</h3>

<p>软件在高工作负载下对其响应性和健壮性展开的测试。</p>

<ul>
<li><p>负载测试：在特定负载下执行的测试。</p>

<ul>
<li>压力测试：突发条件或极限条件下的性能测试。</li>
</ul></li>
</ul>

<h3 id="安全性测试">安全性测试</h3>

<p>系统的敏感数据都是经过认证和授权之后才能访问。</p>

<h3 id="其他测试">其他测试</h3>

<p>易用性测试 / 安装测试 / 可访问性测试</p>

<h3 id="单元测试">单元测试</h3>

<p>测试函数和对象的方法（程序中最小最基本的单元）。通过对实际输出和预期输出的比对以及各种的断言条件来判定被测单元是否满足设计需求。</p>

<ul>
<li>测试用例</li>
<li>测试固件 - 每次测试时都要使用的东西。</li>

<li><p>测试套件（测试集）- 组合了多个测试用例而构成的集合。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UtilTest</span>(TestCase):

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">setUp</span>(self):
    self<span style="color:#f92672">.</span>pattern <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>compile(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\d{6}&#39;</span>)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_gen_mobile_code</span>(self):
    <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">100</span>):
        self<span style="color:#f92672">.</span>assertIsNotNone(self<span style="color:#f92672">.</span>pattern<span style="color:#f92672">.</span>match(gen_mobile_code()))

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_to_md5_hex</span>(self):
    md5_dict <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#39;123456&#39;</span>: <span style="color:#e6db74">&#39;e10adc3949ba59abbe56e057f20f883e&#39;</span>,
        <span style="color:#e6db74">&#39;123123123&#39;</span>: <span style="color:#e6db74">&#39;f5bb0c8de146c67b44babbf4e6584cc0&#39;</span>,
        <span style="color:#e6db74">&#39;1qaz2wsx&#39;</span>: <span style="color:#e6db74">&#39;1c63129ae9db9c60c3e8aa94d3e00495&#39;</span>,
    }
    <span style="color:#66d9ef">for</span> key, value <span style="color:#f92672">in</span> md5_dict<span style="color:#f92672">.</span>items():
        self<span style="color:#f92672">.</span>assertEqual(value, to_md5_hex(key))</code></pre></div></li>
</ul>

<p><code>TestCase</code>的断言方法：</p>

<ul>
<li>assertEqual / assertNotEqual</li>
<li>assertTrue / assertFalse / assertIsNot</li>
<li>assertRaise / assertRaiseRegexp</li>
<li>assertAlmostEqual / assertNotAlmostEqual</li>
<li>assertGreater / assertGreaterEqual / assertLess / assertLessEqual</li>
<li>assertRegexpMatches / assertNotRegexpMatches</li>
<li>assertListEqual / assertSetEqual / assertTupleEqual / assertDictEqual</li>
</ul>

<p>可以使用nose2或pytest来辅助执行单元测试，同时通过cov-core或pytest-cov可以对测试覆度进行评估。覆盖率由百分比表示。比如测试代码执行过了程序的每一行，那么覆盖率就是100%。这种时候，几乎不会出现新程序上线后突然无法运行的尴尬情况。覆盖率不关心代码内容究竟是什么，覆盖率是用来检查“测试代码不足、测试存在疏漏”的一个指标，“测试内容是否妥当”并不归它管。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">pip install nose2 pytest cov-core pytest-cov</code></pre></div>
<p>可以使用Selenium来实现Web应用的自动化测试，它还可以用于屏幕抓取与浏览器行为模拟，通过爬虫抓取页面上的动态数据也可以使用它。Selenium其实包括三个部分：</p>

<ul>
<li>Selenium IDE：嵌入到浏览器的插件，可以录制和回放脚本。</li>
</ul>

<p><img src="Day91-100/res/selenium_ide.png" alt="" /></p>

<ul>
<li><p>Selenium WebDriver：支持多种语言可以操控浏览器的API。</p></li>

<li><p>Selenium Standalone Server：Selenium Grid、远程控制、分布式部署。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">pip install selenium</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">from</span> selenium <span style="color:#f92672">import</span> webdriver
<span style="color:#f92672">import</span> pytest
<span style="color:#f92672">import</span> contextlib


<span style="color:#a6e22e">@pytest.fixture</span>(scope<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;session&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">chrome</span>():
<span style="color:#75715e"># 设置使用无头浏览器(不会打开浏览器窗口)</span>
options <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>ChromeOptions()
options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--headless&#39;</span>)
driver <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>Chrome(options<span style="color:#f92672">=</span>options)
<span style="color:#66d9ef">yield</span> driver
driver<span style="color:#f92672">.</span>quit()


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_baidu_index</span>(chrome):
chrome<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;https://www.baidu.com&#39;</span>)
<span style="color:#66d9ef">assert</span> chrome<span style="color:#f92672">.</span>title <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;百度一下，你就知道&#39;</span></code></pre></div></li>
</ul>

<p>除了Selenium之外，还有一个Web自动化测试工具名叫Robot Framework。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">nose2 -v -C
pytest --cov</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">Ran <span style="color:#ae81ff">7</span> tests in <span style="color:#ae81ff">0</span>.002s

OK
Name                       Stmts   Miss  Cover
----------------------------------------------
example01.py                  <span style="color:#ae81ff">15</span>      <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">100</span>%
example02.py                  <span style="color:#ae81ff">49</span>     <span style="color:#ae81ff">49</span>     <span style="color:#ae81ff">0</span>%
example03.py                  <span style="color:#ae81ff">22</span>     <span style="color:#ae81ff">22</span>     <span style="color:#ae81ff">0</span>%
example04.py                  <span style="color:#ae81ff">61</span>     <span style="color:#ae81ff">61</span>     <span style="color:#ae81ff">0</span>%
example05.py                  <span style="color:#ae81ff">29</span>     <span style="color:#ae81ff">29</span>     <span style="color:#ae81ff">0</span>%
example06.py                  <span style="color:#ae81ff">39</span>     <span style="color:#ae81ff">39</span>     <span style="color:#ae81ff">0</span>%
example07.py                  <span style="color:#ae81ff">19</span>     <span style="color:#ae81ff">19</span>     <span style="color:#ae81ff">0</span>%
example08.py                  <span style="color:#ae81ff">27</span>     <span style="color:#ae81ff">27</span>     <span style="color:#ae81ff">0</span>%
example09.py                  <span style="color:#ae81ff">18</span>     <span style="color:#ae81ff">18</span>     <span style="color:#ae81ff">0</span>%
example10.py                  <span style="color:#ae81ff">19</span>     <span style="color:#ae81ff">19</span>     <span style="color:#ae81ff">0</span>%
example11.py                  <span style="color:#ae81ff">22</span>     <span style="color:#ae81ff">22</span>     <span style="color:#ae81ff">0</span>%
example12.py                  <span style="color:#ae81ff">28</span>     <span style="color:#ae81ff">28</span>     <span style="color:#ae81ff">0</span>%
example13.py                  <span style="color:#ae81ff">28</span>     <span style="color:#ae81ff">28</span>     <span style="color:#ae81ff">0</span>%
test_ddt_example.py           <span style="color:#ae81ff">18</span>      <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">100</span>%
test_pytest_example.py        <span style="color:#ae81ff">11</span>      <span style="color:#ae81ff">6</span>    <span style="color:#ae81ff">45</span>%
test_unittest_example.py      <span style="color:#ae81ff">22</span>      <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">100</span>%
----------------------------------------------
TOTAL                        <span style="color:#ae81ff">427</span>    <span style="color:#ae81ff">367</span>    <span style="color:#ae81ff">14</span>%</code></pre></div>
<p>在测试过程中需要孤立各种外部依赖（数据库、外部接口调用、时间依赖），具体又包括两个方面：</p>

<ol>
<li><p>数据源：数据本地化 / 置于内存中 / 测试之后回滚</p></li>

<li><p>资源虚拟化：存根/桩（stub）、仿制/模拟（mock）、伪造（fake）</p>

<ul>
<li>stub：测试期间为提供响应的函数生成的替代品</li>
<li>mock：代替实际对象（以及该对象的API）的对象</li>
<li>fake：没有达到生产级别的轻量级对象</li>
</ul></li>
</ol>

<h3 id="集成测试">集成测试</h3>

<p>集成多个函数或方法的输入输出的测试，测试时需要将多个测试对象组合在一起。</p>

<ul>
<li>测试组件互操作性 / 需求变更测试 / 外部依赖和API / 调试硬件问题 / 在代码路径中发现异常</li>
</ul>

<h3 id="系统测试">系统测试</h3>

<p>对需求的测试，测试成品是否最终满足了所有需求，在客户验收项目时进行。</p>

<h3 id="数据驱动测试">数据驱动测试</h3>

<p>使用外部数据源实现对输入值与期望值的参数化，避免在测试中使用硬编码的数据。</p>

<p>被测函数：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(x, y):
    <span style="color:#66d9ef">return</span> x <span style="color:#f92672">+</span> y</code></pre></div>
<p>data.csv文件：</p>

<pre><code>3,1,2
0,1,-1
100,50,50
100,1,99
15,7,8
</code></pre>

<p>测试代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">import</span> csv

<span style="color:#f92672">from</span> unittest <span style="color:#f92672">import</span> TestCase
<span style="color:#f92672">from</span> ddt <span style="color:#f92672">import</span> ddt, data, unpack


<span style="color:#a6e22e">@ddt</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestAdd</span>(TestCase):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_data_from_csv</span>(filename):
        data_items <span style="color:#f92672">=</span> []
        <span style="color:#66d9ef">with</span> open(filename, <span style="color:#e6db74">&#39;r&#39;</span>, newline<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>) <span style="color:#66d9ef">as</span> fs:
            reader <span style="color:#f92672">=</span> csv<span style="color:#f92672">.</span>reader(fs)
            <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> reader:
                data_items<span style="color:#f92672">.</span>append(list(map(int, row)))
        <span style="color:#66d9ef">return</span> data_items


    <span style="color:#a6e22e">@data</span>(<span style="color:#f92672">*</span>load_data_from_csv(<span style="color:#e6db74">&#39;data.csv&#39;</span>))
    <span style="color:#a6e22e">@unpack</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_add</span>(self, result, param1, param2):
        self<span style="color:#f92672">.</span>assertEqual(result, add(param1, param2))</code></pre></div>
<h3 id="django中的测试">Django中的测试</h3>

<ol>
<li><p>测试Django视图 - Django中提供的<code>TestCase</code>扩展了<code>unittest</code>中的<code>TestCase</code>，绑定了一个名为<code>client</code>的属性，可以用来模拟浏览器发出的GET、POST、DELETE、PUT等请求。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SomeViewTest</span>(TestCase):

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_example_view</span>(self):
    resp <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>get(reverse(<span style="color:#e6db74">&#39;index&#39;</span>))
    self<span style="color:#f92672">.</span>assertEqual(<span style="color:#ae81ff">200</span>, resp<span style="color:#f92672">.</span>status_code)
    self<span style="color:#f92672">.</span>assertEqual(<span style="color:#ae81ff">5</span>, resp<span style="color:#f92672">.</span>context[<span style="color:#e6db74">&#39;num&#39;</span>])</code></pre></div></li>

<li><p>运行测试 - 配置测试数据库。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">DATABASES <span style="color:#f92672">=</span> {
<span style="color:#e6db74">&#39;default&#39;</span>: {
    <span style="color:#e6db74">&#39;ENGINE&#39;</span>: <span style="color:#e6db74">&#39;django.db.backends.mysql&#39;</span>,
    <span style="color:#e6db74">&#39;HOST&#39;</span>: <span style="color:#e6db74">&#39;localhost&#39;</span>,
    <span style="color:#e6db74">&#39;PORT&#39;</span>: <span style="color:#ae81ff">3306</span>,
    <span style="color:#e6db74">&#39;NAME&#39;</span>: <span style="color:#e6db74">&#39;DbName&#39;</span>,
    <span style="color:#e6db74">&#39;USER&#39;</span>: os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#39;DB_USER&#39;</span>],
    <span style="color:#e6db74">&#39;PASSWORD&#39;</span>: os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#39;DB_PASS&#39;</span>],
    <span style="color:#e6db74">&#39;TEST&#39;</span>: {
        <span style="color:#e6db74">&#39;NAME&#39;</span>: <span style="color:#e6db74">&#39;DbName_for_testing&#39;</span>,
        <span style="color:#e6db74">&#39;CHARSET&#39;</span>: <span style="color:#e6db74">&#39;utf8&#39;</span>,
    },
}
}</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">python manage.py test
python manage.py test common
python manage.py test common.tests.UtilsTest
python manage.py test common.tests.UtilsTest.test_to_md5_hex</code></pre></div></li>

<li><p>评估测试覆盖度</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">pip install coverage
coverage run --source<span style="color:#f92672">=</span>&lt;path1&gt; --omit<span style="color:#f92672">=</span>&lt;path2&gt; manage.py test common
coverage report

Name                            Stmts   Miss  Cover
---------------------------------------------------
common/__init__.py                  <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">100</span>%
common/admin.py                     <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">100</span>%
common/apps.py                      <span style="color:#ae81ff">3</span>      <span style="color:#ae81ff">3</span>     <span style="color:#ae81ff">0</span>%
common/forms.py                    <span style="color:#ae81ff">16</span>     <span style="color:#ae81ff">16</span>     <span style="color:#ae81ff">0</span>%
common/helper.py                   <span style="color:#ae81ff">32</span>     <span style="color:#ae81ff">32</span>     <span style="color:#ae81ff">0</span>%
common/middlewares.py              <span style="color:#ae81ff">19</span>     <span style="color:#ae81ff">19</span>     <span style="color:#ae81ff">0</span>%
common/migrations/__init__.py       <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">100</span>%
common/models.py                   <span style="color:#ae81ff">71</span>      <span style="color:#ae81ff">2</span>    <span style="color:#ae81ff">97</span>%
common/serializers.py              <span style="color:#ae81ff">14</span>     <span style="color:#ae81ff">14</span>     <span style="color:#ae81ff">0</span>%
common/tests.py                    <span style="color:#ae81ff">14</span>      <span style="color:#ae81ff">8</span>    <span style="color:#ae81ff">43</span>%
common/urls_api.py                  <span style="color:#ae81ff">3</span>      <span style="color:#ae81ff">3</span>     <span style="color:#ae81ff">0</span>%
common/urls_user.py                 <span style="color:#ae81ff">3</span>      <span style="color:#ae81ff">3</span>     <span style="color:#ae81ff">0</span>%
common/utils.py                    <span style="color:#ae81ff">22</span>      <span style="color:#ae81ff">7</span>    <span style="color:#ae81ff">68</span>%
common/views.py                    <span style="color:#ae81ff">69</span>     <span style="color:#ae81ff">69</span>     <span style="color:#ae81ff">0</span>%
---------------------------------------------------
TOTAL                             <span style="color:#ae81ff">267</span>    <span style="color:#ae81ff">176</span>    <span style="color:#ae81ff">34</span>%</code></pre></div></li>
</ol>

<h3 id="性能测试-1">性能测试</h3>

<p>问题1：性能测试的指标有哪些？</p>

<ol>
<li><p>ab（ Apache Benchmark） / webbench / httpperf</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">yum -y install httpd
ab -c <span style="color:#ae81ff">10</span> -n <span style="color:#ae81ff">1000</span> http://www.baidu.com/
...
Benchmarking www.baidu.com <span style="color:#f92672">(</span>be patient<span style="color:#f92672">)</span>.....done
Server Software:        BWS/1.1
Server Hostname:        www.baidu.com
Server Port:            <span style="color:#ae81ff">80</span>
Document Path:          /
Document Length:        <span style="color:#ae81ff">118005</span> bytes
Concurrency Level:      <span style="color:#ae81ff">10</span>
Time taken <span style="color:#66d9ef">for</span> tests:   <span style="color:#ae81ff">0</span>.397 seconds
Complete requests:      <span style="color:#ae81ff">100</span>
Failed requests:        <span style="color:#ae81ff">98</span>
  <span style="color:#f92672">(</span>Connect: <span style="color:#ae81ff">0</span>, Receive: <span style="color:#ae81ff">0</span>, Length: <span style="color:#ae81ff">98</span>, Exceptions: <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span>
Write errors:           <span style="color:#ae81ff">0</span>
Total transferred:      <span style="color:#ae81ff">11918306</span> bytes
HTML transferred:       <span style="color:#ae81ff">11823480</span> bytes
Requests per second:    <span style="color:#ae81ff">252</span>.05 <span style="color:#f92672">[</span><span style="color:#75715e">#/sec] (mean)</span>
Time per request:       <span style="color:#ae81ff">39</span>.675 <span style="color:#f92672">[</span>ms<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>mean<span style="color:#f92672">)</span>
Time per request:       <span style="color:#ae81ff">3</span>.967 <span style="color:#f92672">[</span>ms<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>mean, across all concurrent requests<span style="color:#f92672">)</span>
Transfer rate:          <span style="color:#ae81ff">29335</span>.93 <span style="color:#f92672">[</span>Kbytes/sec<span style="color:#f92672">]</span> received
Connection Times <span style="color:#f92672">(</span>ms<span style="color:#f92672">)</span>
             min  mean<span style="color:#f92672">[</span>+/-sd<span style="color:#f92672">]</span> median   max
Connect:        <span style="color:#ae81ff">6</span>    <span style="color:#ae81ff">7</span>   <span style="color:#ae81ff">0</span>.6      <span style="color:#ae81ff">7</span>       <span style="color:#ae81ff">9</span>
Processing:    <span style="color:#ae81ff">20</span>   <span style="color:#ae81ff">27</span>  <span style="color:#ae81ff">22</span>.7     <span style="color:#ae81ff">24</span>     <span style="color:#ae81ff">250</span>
Waiting:        <span style="color:#ae81ff">8</span>   <span style="color:#ae81ff">11</span>  <span style="color:#ae81ff">21</span>.7      <span style="color:#ae81ff">9</span>     <span style="color:#ae81ff">226</span>
Total:         <span style="color:#ae81ff">26</span>   <span style="color:#ae81ff">34</span>  <span style="color:#ae81ff">22</span>.8     <span style="color:#ae81ff">32</span>     <span style="color:#ae81ff">258</span>
Percentage of the requests served within a certain time <span style="color:#f92672">(</span>ms<span style="color:#f92672">)</span>
 <span style="color:#ae81ff">50</span>%     <span style="color:#ae81ff">32</span>
 <span style="color:#ae81ff">66</span>%     <span style="color:#ae81ff">34</span>
 <span style="color:#ae81ff">75</span>%     <span style="color:#ae81ff">34</span>
 <span style="color:#ae81ff">80</span>%     <span style="color:#ae81ff">34</span>
 <span style="color:#ae81ff">90</span>%     <span style="color:#ae81ff">36</span>
 <span style="color:#ae81ff">95</span>%     <span style="color:#ae81ff">39</span>
 <span style="color:#ae81ff">98</span>%     <span style="color:#ae81ff">51</span>
 <span style="color:#ae81ff">99</span>%    <span style="color:#ae81ff">258</span>
<span style="color:#ae81ff">100</span>%    <span style="color:#ae81ff">258</span> <span style="color:#f92672">(</span>longest request<span style="color:#f92672">)</span></code></pre></div></li>

<li><p>mysqlslap</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">mysqlslap -a -c <span style="color:#ae81ff">100</span> -h <span style="color:#ae81ff">1</span>.2.3.4 -u root -p
mysqlslap -a -c <span style="color:#ae81ff">100</span> --number-of-queries<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span> --auto-generate-sql-load-type<span style="color:#f92672">=</span>read -h &lt;负载均衡服务器IP地址&gt; -u root -p
mysqlslap -a --concurrency<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>,100 --number-of-queries<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span> --debug-info --auto-generate-sql-load-type<span style="color:#f92672">=</span>mixed -h <span style="color:#ae81ff">1</span>.2.3.4 -u root -p</code></pre></div></li>

<li><p>sysbench</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">sysbench --test<span style="color:#f92672">=</span>threads --num-threads<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> --thread-yields<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span> --thread-locks<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> run
sysbench --test<span style="color:#f92672">=</span>memory --num-threads<span style="color:#f92672">=</span><span style="color:#ae81ff">512</span> --memory-block-size<span style="color:#f92672">=</span>256M --memory-total-size<span style="color:#f92672">=</span>32G run</code></pre></div></li>

<li><p>jmeter</p></li>
</ol>

<p>请查看<a href="https://www.ibm.com/developerworks/cn/java/l-jmeter/index.html">《使用JMeter进行性能测试》</a>。</p>

<ol>
<li>LoadRunner / QTP</li>
</ol>

<h2 id="项目调试">项目调试</h2>

<p>可以使用django-debug-toolbar来辅助项目调试。</p>

<ol>
<li><p>安装</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">pip install django-debug-toolbar</code></pre></div></li>

<li><p>配置 - 修改settings.py。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">INSTALLED_APPS <span style="color:#f92672">=</span> [
   <span style="color:#e6db74">&#39;debug_toolbar&#39;</span>,
]

MIDDLEWARE <span style="color:#f92672">=</span> [
   <span style="color:#e6db74">&#39;debug_toolbar.middleware.DebugToolbarMiddleware&#39;</span>,
]

DEBUG_TOOLBAR_CONFIG <span style="color:#f92672">=</span> {
   <span style="color:#75715e"># 引入jQuery库</span>
   <span style="color:#e6db74">&#39;JQUERY_URL&#39;</span>: <span style="color:#e6db74">&#39;https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js&#39;</span>,
   <span style="color:#75715e"># 工具栏是否折叠</span>
   <span style="color:#e6db74">&#39;SHOW_COLLAPSED&#39;</span>: True,
   <span style="color:#75715e"># 是否显示工具栏</span>
   <span style="color:#e6db74">&#39;SHOW_TOOLBAR_CALLBACK&#39;</span>: <span style="color:#66d9ef">lambda</span> x: True,
}</code></pre></div></li>

<li><p>配置 - 修改urls.py。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">if</span> settings<span style="color:#f92672">.</span>DEBUG:

   <span style="color:#f92672">import</span> debug_toolbar

   urlpatterns<span style="color:#f92672">.</span>insert(<span style="color:#ae81ff">0</span>, path(<span style="color:#e6db74">&#39;__debug__/&#39;</span>, include(debug_toolbar<span style="color:#f92672">.</span>urls)))</code></pre></div></li>

<li><p>使用 - 在页面右侧可以看到一个调试工具栏，上面包括了执行时间、项目设置、请求头、SQL、静态资源、模板、缓存、信号等调试信息，查看起来非常的方便。</p></li>
</ol>

<h2 id="部署相关">部署相关</h2>

<p>请参考《Django项目上线指南》。</p>

<h2 id="性能相关">性能相关</h2>

<h3 id="网站优化两大定律">网站优化两大定律：</h3>

<ol>
<li><p>尽可能的使用缓存 - 牺牲空间换取时间（普适策略）。</p></li>

<li><p>能推迟的都推迟 - 使用消息队列将并行任务串行来缓解服务器压力。</p>

<ul>
<li>服务器CPU利用率出现瞬时峰值 - 削峰（CPU利用率平缓的增长）</li>
<li>上下游节点解耦合（下订单和受理订单的系统通常是分离的）</li>
</ul></li>
</ol>

<h3 id="django框架">Django框架</h3>

<ol>
<li><p>配置缓存来缓解数据库的压力，并有合理的机制应对<a href="https://www.cnblogs.com/zhangweizhong/p/6258797.html">缓存穿透和缓存雪崩</a>。</p></li>

<li><p>开启<a href="https://docs.djangoproject.com/en/2.0/ref/templates/api/#django.template.loaders.cached.Loader">模板缓存</a>来加速模板的渲染。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">TEMPLATES <span style="color:#f92672">=</span> [
   {
       <span style="color:#e6db74">&#39;BACKEND&#39;</span>: <span style="color:#e6db74">&#39;django.template.backends.django.DjangoTemplates&#39;</span>,
       <span style="color:#e6db74">&#39;DIRS&#39;</span>: [os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(BASE_DIR, <span style="color:#e6db74">&#39;templates&#39;</span>), ],
       <span style="color:#75715e"># &#39;APP_DIRS&#39;: True,</span>
       <span style="color:#e6db74">&#39;OPTIONS&#39;</span>: {
           <span style="color:#e6db74">&#39;context_processors&#39;</span>: [
               <span style="color:#e6db74">&#39;django.template.context_processors.debug&#39;</span>,
               <span style="color:#e6db74">&#39;django.template.context_processors.request&#39;</span>,
               <span style="color:#e6db74">&#39;django.contrib.auth.context_processors.auth&#39;</span>,
               <span style="color:#e6db74">&#39;django.contrib.messages.context_processors.messages&#39;</span>,
           ],
           <span style="color:#e6db74">&#39;loaders&#39;</span>: [(
               <span style="color:#e6db74">&#39;django.template.loaders.cached.Loader&#39;</span>, [
                   <span style="color:#e6db74">&#39;django.template.loaders.filesystem.Loader&#39;</span>,
                   <span style="color:#e6db74">&#39;django.template.loaders.app_directories.Loader&#39;</span>,
               ], ),
           ],
       },
   },
]</code></pre></div></li>

<li><p>用惰性求值、迭代器、<code>defer()</code>、<code>only()</code>等缓解内存压力。</p></li>

<li><p>用<code>select_related()</code>和<code>prefetch_related()</code>执行预加载避免“1+N查询问题”。</p></li>
</ol>

<h3 id="数据库">数据库</h3>

<ol>
<li><p>用ID生成器代替自增主键（性能更好、适用于分布式环境）。</p>

<ul>
<li><p>自定义ID生成器</p></li>

<li><p>UUID</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">&gt;&gt;&gt;</span> my_uuid <span style="color:#f92672">=</span> uuid<span style="color:#f92672">.</span>uuid1()
<span style="color:#f92672">&gt;&gt;&gt;</span> my_uuid
UUID(<span style="color:#e6db74">&#39;63f859d0-a03a-11e8-b0ad-60f81da8d840&#39;</span>)
<span style="color:#f92672">&gt;&gt;&gt;</span> my_uuid<span style="color:#f92672">.</span>hex
<span style="color:#e6db74">&#39;63f859d0a03a11e8b0ad60f81da8d840&#39;</span></code></pre></div></li>
</ul></li>

<li><p>避免不必要的外键列上的约束（除非必须保证参照完整性），更不要使用触发器之类的机制。</p></li>

<li><p>使用索引来优化查询性能（索引放在要用于查询的字段上）。InnoDB用的是BTREE索引，使用&gt;、&lt;、&gt;=、&lt;=、BETWEEN或者LIKE &lsquo;pattern&rsquo;（pattern不以通配符开头）时都可以用到索引。因为建立索引需要额外的磁盘空间，而主键上是有默认的索引，所以主键要尽可能选择较短的数据类型来减少磁盘占用，提高索引的缓存效果。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-SQL" data-lang="SQL"><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">index</span> idx_goods_name <span style="color:#66d9ef">on</span> tb_goods (gname(<span style="color:#ae81ff">10</span>));</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-SQL" data-lang="SQL"><span style="color:#75715e">-- 无法使用索引
</span><span style="color:#75715e"></span><span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> tb_goods <span style="color:#66d9ef">where</span> gname <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%iPhone%&#39;</span>;
<span style="color:#75715e">-- 可以使用索引
</span><span style="color:#75715e"></span><span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> tb_goods <span style="color:#66d9ef">where</span> gname <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;iPhone%&#39;</span>;</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#75715e"># 无法使用索引</span>
Goods<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(name_icontains<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;iPhone&#39;</span>)
<span style="color:#75715e"># 可以使用索引</span>
Goods<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(name__istartswith<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;iPhone&#39;</span>);</code></pre></div></li>

<li><p>使用存储过程（存储在服务器端编译过的一组SQL语句）。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-SQL" data-lang="SQL"><span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">procedure</span> <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">exists</span> sp_avg_sal_by_dept;

<span style="color:#66d9ef">create</span> <span style="color:#66d9ef">procedure</span> sp_avg_sal_by_dept(deptno integer, <span style="color:#66d9ef">out</span> avg_sal float)
<span style="color:#66d9ef">begin</span>
   <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">avg</span>(sal) <span style="color:#66d9ef">into</span> avg_sal <span style="color:#66d9ef">from</span> TbEmp <span style="color:#66d9ef">where</span> dno<span style="color:#f92672">=</span>deptno;
<span style="color:#66d9ef">end</span>;

<span style="color:#66d9ef">call</span> sp_avg_sal_by_dept(<span style="color:#ae81ff">10</span>, <span style="color:#f92672">@</span>a);

<span style="color:#66d9ef">select</span> <span style="color:#f92672">@</span>a;</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> django.db <span style="color:#f92672">import</span> connection
<span style="color:#f92672">&gt;&gt;&gt;</span> cursor <span style="color:#f92672">=</span> connection<span style="color:#f92672">.</span>cursor()
<span style="color:#f92672">&gt;&gt;&gt;</span> cursor<span style="color:#f92672">.</span>callproc(<span style="color:#e6db74">&#39;sp_avg_sal_by_dept&#39;</span>, (<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">0</span>))
<span style="color:#f92672">&gt;&gt;&gt;</span> cursor<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#39;select @_sp_avg_sal_by_dept_1&#39;</span>)
<span style="color:#f92672">&gt;&gt;&gt;</span> cursor<span style="color:#f92672">.</span>fetchone()
(<span style="color:#ae81ff">2675.0</span>,)</code></pre></div></li>

<li><p>使用数据分区。通过分区可以存储更多的数据、优化查询更大的吞吐量、可以快速删除过期的数据。关于这个知识点可以看看MySQL的<a href="https://dev.mysql.com/doc/refman/5.7/en/partitioning-overview.html">官方文档</a>。</p>

<ul>
<li>RANGE分区：基于连续区间范围，把数据分配到不同的分区。</li>
<li>LIST分区：基于枚举值的范围，把数据分配到不同的分区。</li>

<li><p>HASH分区 / KEY分区：基于分区个数，把数据分配到不同的分区。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-SQL" data-lang="SQL"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> tb_emp (
eno INT <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
ename VARCHAR(<span style="color:#ae81ff">20</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
job VARCHAR(<span style="color:#ae81ff">10</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
hiredate DATE <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
dno INT <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>
)
PARTITION <span style="color:#66d9ef">BY</span> HASH(dno)
PARTITIONS <span style="color:#ae81ff">4</span>;</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-SQL" data-lang="SQL"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> tb_emp (
eno INT <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
ename VARCHAR(<span style="color:#ae81ff">20</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
job VARCHAR(<span style="color:#ae81ff">10</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
hiredate DATE <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
dno INT <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>
)
PARTITION <span style="color:#66d9ef">BY</span> RANGE( <span style="color:#66d9ef">YEAR</span>(hiredate) ) (
PARTITION p0 <span style="color:#66d9ef">VALUES</span> <span style="color:#66d9ef">LESS</span> <span style="color:#66d9ef">THAN</span> (<span style="color:#ae81ff">1960</span>),
PARTITION p1 <span style="color:#66d9ef">VALUES</span> <span style="color:#66d9ef">LESS</span> <span style="color:#66d9ef">THAN</span> (<span style="color:#ae81ff">1970</span>),
PARTITION p2 <span style="color:#66d9ef">VALUES</span> <span style="color:#66d9ef">LESS</span> <span style="color:#66d9ef">THAN</span> (<span style="color:#ae81ff">1980</span>),
PARTITION p3 <span style="color:#66d9ef">VALUES</span> <span style="color:#66d9ef">LESS</span> <span style="color:#66d9ef">THAN</span> (<span style="color:#ae81ff">1990</span>),
PARTITION p4 <span style="color:#66d9ef">VALUES</span> <span style="color:#66d9ef">LESS</span> <span style="color:#66d9ef">THAN</span> <span style="color:#66d9ef">MAXVALUE</span>
);</code></pre></div></li>
</ul></li>

<li><p>使用<code>explain</code>来分析查询性能 - 执行计划。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-SQL" data-lang="SQL"><span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> ...;</code></pre></div></li>
</ol>

<p><code>explain</code>结果解析：</p>

<ul>
<li>select_type：表示select操作的类型，常见的值有SIMPLE（简单查询，没有使用子查询或者表连接查询）、PRIMARY（主查询，外层的查询）、UNION（并集操作中的第二个或者后面的查询）、SUBQUERY（子查询中的第一个SELECT）等。</li>
<li>table：输出结果的表。</li>
<li>type：MySQL在表中找到所需行的方式，也称为访问类型，常见的值有：

<ul>
<li>ALL：全表扫描（遍历全表找到匹配的行）</li>
<li>index：索引全扫描（遍历整个索引）</li>
<li>range：索引范围扫描</li>
<li>ref：非唯一索引扫描或唯一索引的前缀扫描</li>
<li>eq_ref：唯一索引扫描</li>
<li>const / system：表中最多有一行匹配</li>
<li>NULL：不用访问表或者索引</li>
</ul></li>
<li>possible_keys：查询时可能用到的索引。</li>
<li>key：实际使用的索引。</li>
<li>key_len：使用到索引字段的长度。</li>
<li>rows：扫描行的数量。</li>
<li>Extra：额外的信息（执行情况的说明或描述）。</li>
</ul>

<blockquote>
<p>说明：关于MySQL更多的知识尤其是性能调优和运维方面的内容，推荐大家阅读网易出品的《深入浅出MySQL（第2版）》，网易出品必属精品。</p>
</blockquote>

<ol>
<li><p>使用慢查询日志来发现性能低下的查询。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-SQL" data-lang="SQL">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;slow_query%&#39;</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">---------------------------+----------------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Variable_name             <span style="color:#f92672">|</span> Value                            <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">---------------------------+----------------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> slow_query_log            <span style="color:#f92672">|</span> <span style="color:#66d9ef">OFF</span>                              <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> slow_query_log_file       <span style="color:#f92672">|</span> <span style="color:#f92672">/</span>mysql<span style="color:#f92672">/</span><span style="color:#66d9ef">data</span><span style="color:#f92672">/</span>localhost<span style="color:#f92672">-</span>slow.log   <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">---------------------------+----------------------------------+
</span><span style="color:#75715e"></span>
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;long_query_time&#39;</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">-----------------+-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Variable_name   <span style="color:#f92672">|</span> Value     <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------------+-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> long_query_time <span style="color:#f92672">|</span> <span style="color:#ae81ff">10</span>.<span style="color:#ae81ff">000000</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------------+-----------+</span></code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-SQL" data-lang="SQL">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> slow_query_log<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ON&#39;</span>;
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> long_query_time<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-INI" data-lang="INI"><span style="color:#66d9ef">[mysqld]</span>
<span style="color:#a6e22e">slow_query_log</span><span style="color:#f92672">=</span><span style="color:#e6db74">ON</span>
<span style="color:#a6e22e">slow_query_log_file</span><span style="color:#f92672">=</span><span style="color:#e6db74">/usr/local/mysql/data/slow.log</span>
<span style="color:#a6e22e">long_query_time</span><span style="color:#f92672">=</span><span style="color:#e6db74">1</span></code></pre></div></li>
</ol>

<h3 id="其他">其他</h3>

<p>请参考《Python性能调优》。</p>
</article>

      

      
    </div>

    
  

  <aside class="book-toc level-3 fixed">
    <nav id="TableOfContents">
<ul>
<li><a href="#使用django开发商业项目">使用Django开发商业项目</a>
<ul>
<li><a href="#web应用">Web应用</a></li>
<li><a href="#mvc架构模式">MVC架构模式</a></li>
<li><a href="#http请求和响应">HTTP请求和响应</a>
<ul>
<li><a href="#http请求-请求行-请求头-空行-消息体">HTTP请求 = 请求行+请求头+空行+[消息体]</a></li>
<li><a href="#http响应-响应行-响应头-空行-消息体">HTTP响应 = 响应行+响应头+空行+消息体</a></li>
</ul></li>
<li><a href="#数据模型-model">数据模型(Model)</a></li>
<li><a href="#视图函数-controller">视图函数(Controller)</a>
<ul>
<li><a href="#如何设计视图函数">如何设计视图函数</a></li>
<li><a href="#url配置">URL配置</a></li>
</ul></li>
<li><a href="#模板-view">模板(View)</a>
<ul>
<li><a href="#后端渲染">后端渲染</a></li>
<li><a href="#前端渲染">前端渲染</a></li>
<li><a href="#其他视图">其他视图</a></li>
</ul></li>
<li><a href="#中间件">中间件</a>
<ul>
<li><a href="#激活中间件">激活中间件</a></li>
<li><a href="#自定义中间件">自定义中间件</a></li>
<li><a href="#内置中间件">内置中间件</a></li>
</ul></li>
<li><a href="#表单">表单</a></li>
<li><a href="#cookie和session">Cookie和Session</a>
<ul>
<li><a href="#session的配置">Session的配置</a></li>
</ul></li>
<li><a href="#缓存">缓存</a>
<ul>
<li><a href="#配置缓存">配置缓存</a></li>
<li><a href="#全站缓存">全站缓存</a></li>
<li><a href="#视图层缓存">视图层缓存</a></li>
<li><a href="#其他内容">其他内容</a></li>
</ul></li>
<li><a href="#日志">日志</a>
<ul>
<li><a href="#日志级别">日志级别</a></li>
<li><a href="#日志配置">日志配置</a></li>
<li><a href="#日志分析">日志分析</a></li>
</ul></li>
<li><a href="#restful">RESTful</a>
<ul>
<li><a href="#使用djangorestframework">使用djangorestframework</a></li>
<li><a href="#编写序列化器">编写序列化器</a></li>
<li><a href="#方法1-使用装饰器">方法1：使用装饰器</a></li>
<li><a href="#方法2-使用apiview及其子类">方法2：使用APIView及其子类</a></li>
<li><a href="#方法3-使用viewset及其子类">方法3：使用ViewSet及其子类</a></li>
<li><a href="#补充说明">补充说明</a></li>
<li><a href="#过滤数据">过滤数据</a></li>
<li><a href="#身份认证">身份认证</a></li>
<li><a href="#授予权限">授予权限</a></li>
<li><a href="#访问限流">访问限流</a></li>
</ul></li>
<li><a href="#异步任务和计划任务">异步任务和计划任务</a>
<ul>
<li><a href="#celery的应用">Celery的应用</a></li>
</ul></li>
<li><a href="#其他问题">其他问题</a></li>
<li><a href="#安全保护">安全保护</a>
<ul>
<li><a href="#django提供的安全措施">Django提供的安全措施</a></li>
<li><a href="#用户敏感信息的保护">用户敏感信息的保护</a></li>
<li><a href="#安全相关建议">安全相关建议</a></li>
</ul></li>
<li><a href="#测试相关">测试相关</a>
<ul>
<li><a href="#功能测试">功能测试</a></li>
<li><a href="#性能测试">性能测试</a></li>
<li><a href="#安全性测试">安全性测试</a></li>
<li><a href="#其他测试">其他测试</a></li>
<li><a href="#单元测试">单元测试</a></li>
<li><a href="#集成测试">集成测试</a></li>
<li><a href="#系统测试">系统测试</a></li>
<li><a href="#数据驱动测试">数据驱动测试</a></li>
<li><a href="#django中的测试">Django中的测试</a></li>
<li><a href="#性能测试-1">性能测试</a></li>
</ul></li>
<li><a href="#项目调试">项目调试</a></li>
<li><a href="#部署相关">部署相关</a></li>
<li><a href="#性能相关">性能相关</a>
<ul>
<li><a href="#网站优化两大定律">网站优化两大定律：</a></li>
<li><a href="#django框架">Django框架</a></li>
<li><a href="#数据库">数据库</a></li>
<li><a href="#其他">其他</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </aside>



  </main>

  
  
</body>

</html>
